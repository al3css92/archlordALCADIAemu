#include "public/ap_skill.h"

#include "core/log.h"
#include "core/malloc.h"
#include "core/string.h"

#include "public/ap_admin.h"
#include "public/ap_character.h"
#include "public/ap_packet.h"
#include "public/ap_random.h"
#include "public/ap_tick.h"

#include "utility/au_packet.h"
#include "utility/au_table.h"

#include <assert.h>
#include <stdarg.h>
#include <stdlib.h>

struct ap_skill_module {
	struct ap_module_instance instance;
	struct ap_character_module * ap_character;
	struct ap_factors_module * ap_factors;
	struct ap_packet_module * ap_packet;
	struct ap_random_module * ap_random;
	struct ap_tick_module * ap_tick;
	struct au_packet packet;
	struct au_packet packet_base;
	struct au_packet packet_action;
	struct au_packet packet_buff;
	struct ap_admin template_admin;
	uint32_t id_counter;
	struct ap_skill * freelist;
	size_t character_offset;
};

#define INI_NAME_NAME "Name"

enum spec_data_col_id {
	SPEC_DCID_NAME,
	SPEC_DCID_ATTRIBUTE,
	SPEC_DCID_UPGRADABLE,
	SPEC_DCID_CHECK_RANGE,
	SPEC_DCID_TARGET,
	SPEC_DCID_RANGE,
	SPEC_DCID_REQUIREMENT,
	SPEC_DCID_CONDITION,
	SPEC_DCID_OTHER_CONDITION,
	SPEC_DCID_ARG1,
	SPEC_DCID_ARG2,
	SPEC_DCID_ARG3,
	SPEC_DCID_ARG4,
	SPEC_DCID_ARG_STRING,
	SPEC_DCID_MELEE_ATTACK,
	SPEC_DCID_MAGIC_ATTACK,
	SPEC_DCID_COUNT,
	SPEC_DCID_SPECIAL_STATUS,
	SPEC_DCID_SPECIAL_STATUS_ARG,
	SPEC_DCID_MOVE_POS,
	SPEC_DCID_UPDATE_FACTOR,
	SPEC_DCID_REFLECT_MELEE_ATTACK,
	SPEC_DCID_REFLECT_MAGIC_ATTACK,
	SPEC_DCID_REFLECT_HEROIC_ATTACK,
	SPEC_DCID_DEFENSE_MELEE_ATTACK,
	SPEC_DCID_DEFENSE_MAGIC_ATTACK,
	SPEC_DCID_MAGIC_RESIST_LEVEL_UP,
	SPEC_DCID_DISPEL_MAGIC,
	SPEC_DCID_TRANSFORM_TARGET,
	SPEC_DCID_LIFE_PROTECTION,
	SPEC_DCID_DOT,
	SPEC_DCID_INFECT_AROUND,
	SPEC_DCID_ADD_SPELLCOUNT,
	SPEC_DCID_DMG_ADJUST,
	SPEC_DCID_SKILL_FACTOR_ADJUST,
	SPEC_DCID_UPDATE_COMBAT_POINT,
	SPEC_DCID_REGEN_HP,
	SPEC_DCID_CONVERT_TYPE,
	SPEC_DCID_CHARGE,
	SPEC_DCID_SKILL_LEVELUP,
	SPEC_DCID_PRODUCT,
	SPEC_DCID_TWICE_PACKET,
	SPEC_DCID_AUTO_ATTACK,
	SPEC_DCID_DYNAMIC_TARGET,
	SPEC_DCID_ACTION_ON_ACTION,
	SPEC_DCID_AT_FIELD,
	SPEC_DCID_SUMMONS,
	SPEC_DCID_ACTION_PASSIVE,
	SPEC_DCID_DURATION_TYPE,
	SPEC_DCID_LIMITED_MAX_LEVEL,
	SPEC_DCID_RELEASE_TARGET,
	SPEC_DCID_VISIBLE_EFFECT_TYPE,
	SPEC_DCID_GAME_BONUS,
	SPEC_DCID_ITEM_USE_TYPE,
	SPEC_DCID_CASH,
	SPEC_DCID_LEVEL_DIFF_TYPE,
	SPEC_DCID_DETECT,
	SPEC_DCID_RIDE,
	SPEC_DCID_GAME_EFFECT,
	SPEC_DCID_FORCE,
	SPEC_DCID_DIVIDE,
	SPEC_DCID_RESURRECTION,
	SPEC_DCID_SKILL_UNION,
	SPEC_DCID_TARGET_RESTRICTION,
	SPEC_DCID_DISTURB,
	SPEC_DCID_DOWNTIME_ID,
	SPEC_DCID_DOWNTIME_DURATION,
	SPEC_DCID_APPLIED_COOLDOWN_CAP,
};

enum const_data_column_id {
	CONST_DCID_NAME,
	CONST_DCID_SKILL_LEVEL,
	CONST_DCID_SKILL_TYPE,
	CONST_DCID_SKILL_TYPE2,
	CONST_DCID_BUFF_TYPE,
	CONST_DCID_REQUIRE_CLASS_KNIGHT,
	CONST_DCID_REQUIRE_CLASS_ARCHER,
	CONST_DCID_REQUIRE_CLASS_WIZARD,
	CONST_DCID_REQUIRE_CLASS_BERSERKER,
	CONST_DCID_REQUIRE_CLASS_HUNTER,
	CONST_DCID_REQUIRE_CLASS_SORCERER,
	CONST_DCID_REQUIRE_CLASS_SWASHBUCKLER,
	CONST_DCID_REQUIRE_CLASS_RANGER,
	CONST_DCID_REQUIRE_CLASS_ELEMENTALER,
	CONST_DCID_REQUIRE_CLASS_SLAYER,
	CONST_DCID_REQUIRE_CLASS_OBITER,
	CONST_DCID_REQUIRE_CLASS_SUMMONER,
	CONST_DCID_REQUIRE_CLASS_SCION,
	CONST_DCID_REQUIRE_LEVEL,
	CONST_DCID_REQUIRE_POINT,
	CONST_DCID_REQUIRE_HEROIC_POINT,
	CONST_DCID_REQUIRE_CHARISMA_POINT,
	CONST_DCID_DAMAGE_A,
	CONST_DCID_DAMAGE_MAGIC,
	CONST_DCID_DAMAGE_WATER,
	CONST_DCID_DAMAGE_AIR,
	CONST_DCID_DAMAGE_EARTH,
	CONST_DCID_DAMAGE_FIRE,
	CONST_DCID_DAMAGE_POISON,
	CONST_DCID_DAMAGE_ICE,
	CONST_DCID_DAMAGE_THUNDER,
	CONST_DCID_DMG_HEROIC,
	CONST_DCID_DAMAGE_C,
	CONST_DCID_DAMAGE_A_PERCENT,
	CONST_DCID_DAMAGE_MAGIC_PERCENT,
	CONST_DCID_DAMAGE_WATER_PERCENT,
	CONST_DCID_DAMAGE_AIR_PERCENT,
	CONST_DCID_DAMAGE_EARTH_PERCENT,
	CONST_DCID_DAMAGE_FIRE_PERCENT,
	CONST_DCID_DAMAGE_POISON_PERCENT,
	CONST_DCID_DAMAGE_ICE_PERCENT,
	CONST_DCID_DAMAGE_THUNDER_PERCENT,
	CONST_DCID_DMG_HEROIC_PERCENT,
	CONST_DCID_DAMAGE_C_PERCENT,
	CONST_DCID_RESIST_A,
	CONST_DCID_COST_HP,
	CONST_DCID_COST_MP,
	CONST_DCID_COST_SP,
	CONST_DCID_COST_ARROW,
	CONST_DCID_ENDSKILL_COST_HP,
	CONST_DCID_CAST_TIME,
	CONST_DCID_RECAST_TIME,
	CONST_DCID_SEMI_RECAST_TIME,
	CONST_DCID_DURATION,
	CONST_DCID_INTERVAL,
	CONST_DCID_SHOW_DAMAGE,
	CONST_DCID_RANGE,
	CONST_DCID_AREA_R,
	CONST_DCID_AREA_F1,
	CONST_DCID_AREA_F2,
	CONST_DCID_DOT_DMG_A,
	CONST_DCID_DOT_DMG_MAGIC,
	CONST_DCID_DOT_DMG_WATER,
	CONST_DCID_DOT_DMG_AIR,
	CONST_DCID_DOT_DMG_EARTH,
	CONST_DCID_DOT_DMG_FIRE,
	CONST_DCID_DOT_DMG_POISON,
	CONST_DCID_DOT_DMG_ICE,
	CONST_DCID_DOT_DMG_THUNDER,
	CONST_DCID_DOT_DMG_HEROIC,
	CONST_DCID_DOT_DMG_A_PERCENT,
	CONST_DCID_DOT_DMG_MAGIC_PERCENT,
	CONST_DCID_DOT_DMG_WATER_PERCENT,
	CONST_DCID_DOT_DMG_AIR_PERCENT,
	CONST_DCID_DOT_DMG_EARTH_PERCENT,
	CONST_DCID_DOT_DMG_FIRE_PERCENT,
	CONST_DCID_DOT_DMG_POISON_PERCENT,
	CONST_DCID_DOT_DMG_ICE_PERCENT,
	CONST_DCID_DOT_DMG_THUNDER_PERCENT,
	CONST_DCID_MOVE_DISTANCE,
	CONST_DCID_REFLECT_MAX,
	CONST_DCID_HEROIC_REFLECT_MAX,
	CONST_DCID_DEFENSE_MAX,
	CONST_DCID_REFLECT_CON,
	CONST_DCID_DEFENSE_CON,
	CONST_DCID_DAMAGE_SHIELD,
	CONST_DCID_COUNTER_UP,
	CONST_DCID_COUNTER_REDUCE,
	CONST_DCID_HOT,
	CONST_DCID_DMG_ADJUST,
	CONST_DCID_DMG_SHOW_DIVIDE,
	CONST_DCID_HP_RECOVERY,
	CONST_DCID_MP_RECOVERY,
	CONST_DCID_SP_RECOVERY,
	CONST_DCID_WARRIOR_LEV,
	CONST_DCID_CHANGE_MONSTER,
	CONST_DCID_BLOCK_POINT,
	CONST_DCID_STUN_TIME,
	CONST_DCID_STUN_GENERATE_TIME,
	CONST_DCID_CRITICAL,
	CONST_DCID_SKILL_RANGE,
	CONST_DCID_SKILL_RATE,
	CONST_DCID_SPECIAL_STATUS_RATE,
	CONST_DCID_DAMAGE_CONVERT_HP,
	CONST_DCID_DAMAGE_CONVERT_MP,
	CONST_DCID_REGEN_HP,
	CONST_DCID_REGEN_MP,
	CONST_DCID_CHARGE_1,
	CONST_DCID_CHARGE_2,
	CONST_DCID_CHARGE_3,
	CONST_DCID_AGGRODOLL_HP,
	CONST_DCID_DOT_DAMAGE_TIME,
	CONST_DCID_COST_MP_DECREASE,
	CONST_DCID_CAST_TIME_DECREASE,
	CONST_DCID_SKILL_LEVELUP,
	CONST_DCID_MP_CONVERT_HP,
	CONST_DCID_DEATH,
	CONST_DCID_TIME_CONTROL,
	CONST_DCID_ITEM_PARTS,
	CONST_DCID_SKILL_COST,
	CONST_DCID_SKILL_UPGRADE_COST,
	CONST_DCID_SKILL_CLASSIFY_ID,
	CONST_DCID_SKILL_CLASSIFY_LEVEL,
	CONST_DCID_VELOCITY,
	CONST_DCID_SUMMONS_TID,
	CONST_DCID_CREATURE_TID,
	CONST_DCID_ADDITIONAL_SKILLTID,
	CONST_DCID_ADDITIONAL_DURATION,
	CONST_DCID_MAX_TARGET_NUM,
	CONST_DCID_LIMIT_QUANTITY,
	CONST_DCID_SUMMONS_COUNT,
	CONST_DCID_BONUS_EXP,
	CONST_DCID_BONUS_MONEY,
	CONST_DCID_BONUS_DROP_RATE,
	CONST_DCID_BONUS_CHARISMA_ADD_RATE,
	CONST_DCID_LEVEL_DIFF,
	CONST_DCID_DIVIDE_RATE,
	CONST_DCID_EA_DAMAGE_PHYSICAL,
	CONST_DCID_EA_DAMAGE_MAGIC,
	CONST_DCID_EA_DAMAGE_WATER,
	CONST_DCID_EA_DAMAGE_AIR,
	CONST_DCID_EA_DAMAGE_EARTH,
	CONST_DCID_EA_DAMAGE_FIRE,
	CONST_DCID_EA_DAMAGE_POISON,
	CONST_DCID_EA_DAMAGE_ICE,
	CONST_DCID_EA_DAMAGE_THUNDER,
	CONST_DCID_EA_DAMAGE_C,
	CONST_DCID_EA_DAMAGE_PHYSICAL_PERCENT,
	CONST_DCID_EA_DAMAGE_MAGIC_PERCENT,
	CONST_DCID_EA_DAMAGE_WATER_PERCENT,
	CONST_DCID_EA_DAMAGE_AIR_PERCENT,
	CONST_DCID_EA_DAMAGE_EARTH_PERCENT,
	CONST_DCID_EA_DAMAGE_FIRE_PERCENT,
	CONST_DCID_EA_DAMAGE_POISON_PERCENT,
	CONST_DCID_EA_DAMAGE_ICE_PERCENT,
	CONST_DCID_EA_DAMAGE_THUNDER_PERCENT,
	CONST_DCID_EA_DAMAGE_C_PERCENT,
	CONST_DCID_FACTOR_POINT,
	CONST_DCID_CON,
	CONST_DCID_STR,
	CONST_DCID_INT,
	CONST_DCID_DEX,
	CONST_DCID_CHA,
	CONST_DCID_WIS,
	CONST_DCID_MOVEMENT,
	CONST_DCID_HP,
	CONST_DCID_MP,
	CONST_DCID_SP,
	CONST_DCID_AP,
	CONST_DCID_AGRO,
	CONST_DCID_MAX_HP,
	CONST_DCID_MAX_MP,
	CONST_DCID_MAX_SP,
	CONST_DCID_ATK_SPEED,
	CONST_DCID_ATK_RANGE,
	CONST_DCID_SKILL_CAST,
	CONST_DCID_SKILL_DELAY,
	CONST_DCID_HIT_RATE,
	CONST_DCID_EVADE_RATE,
	CONST_DCID_DODGE_RATE,
	CONST_DCID_DMG_MIN_PHYSICAL,
	CONST_DCID_DMG_MIN_MAGIC,
	CONST_DCID_DMG_MIN_WATER,
	CONST_DCID_DMG_MIN_AIR,
	CONST_DCID_DMG_MIN_EARTH,
	CONST_DCID_DMG_MIN_FIRE,
	CONST_DCID_DMG_MIN_POISON,
	CONST_DCID_DMG_MIN_ICE,
	CONST_DCID_DMG_MIN_THUNDER,
	CONST_DCID_DMG_MAX_PHYSICAL,
	CONST_DCID_DMG_MAX_MAGIC,
	CONST_DCID_DMG_MAX_WATER,
	CONST_DCID_DMG_MAX_AIR,
	CONST_DCID_DMG_MAX_EARTH,
	CONST_DCID_DMG_MAX_FIRE,
	CONST_DCID_DMG_MAX_POISON,
	CONST_DCID_DMG_MAX_ICE,
	CONST_DCID_DMG_MAX_THUNDER,
	CONST_DCID_DEF_POINT_PHYSICAL,
	CONST_DCID_DEF_POINT_MAGIC,
	CONST_DCID_DEF_POINT_WATER,
	CONST_DCID_DEF_POINT_AIR,
	CONST_DCID_DEF_POINT_EARTH,
	CONST_DCID_DEF_POINT_FIRE,
	CONST_DCID_DEF_POINT_POISON,
	CONST_DCID_DEF_POINT_ICE,
	CONST_DCID_DEF_POINT_THUNDER,
	CONST_DCID_PHYSICAL_RESISTANCE,
	CONST_DCID_PHYSICAL_BLOCK,
	CONST_DCID_SKILL_BLOCK,
	CONST_DCID_DMG_MIN_HEROIC,
	CONST_DCID_DMG_MAX_HEROIC,
	CONST_DCID_DEF_POINT_HEROIC,
	CONST_DCID_HEROIC_MELEE_RESISTANCE,
	CONST_DCID_HEROIC_RANGED_RESISTANCE,
	CONST_DCID_HEROIC_MAGIC_RESISTANCE,
	CONST_DCID_FACTOR_PERCENT,
	CONST_DCID_FACTOR_MAGNIFY,
};

enum const2_data_column_id {
	CONST2_DCID_NAME2,
	CONST2_DCID_SKILL_LEVEL2,
	CONST2_DCID_DAMAGE_A2,
	CONST2_DCID_DAMAGE_MAGIC2,
	CONST2_DCID_DAMAGE_WATER2,
	CONST2_DCID_DAMAGE_AIR2,
	CONST2_DCID_DAMAGE_EARTH2,
	CONST2_DCID_DAMAGE_FIRE2,
	CONST2_DCID_DAMAGE_POISON2,
	CONST2_DCID_DAMAGE_ICE2,
	CONST2_DCID_DAMAGE_THUNDER2,
	CONST2_DCID_DAMAGE_A_PERCENT2,
	CONST2_DCID_DAMAGE_MAGIC_PERCENT2,
	CONST2_DCID_DAMAGE_WATER_PERCENT2,
	CONST2_DCID_DAMAGE_AIR_PERCENT2,
	CONST2_DCID_DAMAGE_EARTH_PERCENT2,
	CONST2_DCID_DAMAGE_FIRE_PERCENT2,
	CONST2_DCID_DAMAGE_POISON_PERCENT2,
	CONST2_DCID_DAMAGE_ICE_PERCENT2,
	CONST2_DCID_DAMAGE_THUNDER_PERCENT2,
	CONST2_DCID_DAMAGE_C_PERCENT2,
	CONST2_DCID_COST_HP2,
	CONST2_DCID_COST_MP2,
	CONST2_DCID_DURATION2,
	CONST2_DCID_INTERVAL2,
	CONST2_DCID_DOT_DMG_A2,
	CONST2_DCID_DOT_DMG_MAGIC2,
	CONST2_DCID_DOT_DMG_WATER2,
	CONST2_DCID_DOT_DMG_AIR2,
	CONST2_DCID_DOT_DMG_EARTH2,
	CONST2_DCID_DOT_DMG_FIRE2,
	CONST2_DCID_DOT_DMG_POISON2,
	CONST2_DCID_DOT_DMG_ICE2,
	CONST2_DCID_DOT_DMG_THUNDER2,
	CONST2_DCID_DOT_DMG_A_PERCENT2,
	CONST2_DCID_DOT_DMG_MAGIC_PERCENT2,
	CONST2_DCID_DOT_DMG_WATER_PERCENT2,
	CONST2_DCID_DOT_DMG_AIR_PERCENT2,
	CONST2_DCID_DOT_DMG_EARTH_PERCENT2,
	CONST2_DCID_DOT_DMG_FIRE_PERCENT2,
	CONST2_DCID_DOT_DMG_POISON_PERCENT2,
	CONST2_DCID_DOT_DMG_ICE_PERCENT2,
	CONST2_DCID_DOT_DMG_THUNDER_PERCENT2,
	CONST2_DCID_STUN_TIME2,
	CONST2_DCID_SKILL_RATE2,
	CONST2_DCID_AGGRODOLL_HP2,
	CONST2_DCID_DOT_DAMAGE_TIME2,
	CONST2_DCID_DEATH2,
	CONST2_DCID_SPECIFIC_SKILL_LEVELUP2,
	CONST2_DCID_CONNECTION_TID2,
	CONST2_DCID_SKILL_UNION2,
	CONST2_DCID_SKILL_UNION_CONTROL2,
	CONST2_DCID_MAX_SKILL_UNION2,
	CONST2_DCID_BONUS_DROP_ADD_RATE2,
	CONST2_DCID_VELOCITY2,
	CONST2_DCID_EA_DAMAGE_PHYSICAL2,
	CONST2_DCID_EA_DAMAGE_MAGIC2,
	CONST2_DCID_EA_DAMAGE_WATER2,
	CONST2_DCID_EA_DAMAGE_AIR2,
	CONST2_DCID_EA_DAMAGE_EARTH2,
	CONST2_DCID_EA_DAMAGE_FIRE2,
	CONST2_DCID_EA_DAMAGE_POISON2,
	CONST2_DCID_EA_DAMAGE_ICE2,
	CONST2_DCID_EA_DAMAGE_THUNDER2,
	CONST2_DCID_EA_DAMAGE_C2,
	CONST2_DCID_EA_DAMAGE_PHYSICAL_PERCENT2,
	CONST2_DCID_EA_DAMAGE_MAGIC_PERCENT2,
	CONST2_DCID_EA_DAMAGE_WATER_PERCENT2,
	CONST2_DCID_EA_DAMAGE_AIR_PERCENT2,
	CONST2_DCID_EA_DAMAGE_EARTH_PERCENT2,
	CONST2_DCID_EA_DAMAGE_FIRE_PERCENT2,
	CONST2_DCID_EA_DAMAGE_POISON_PERCENT2,
	CONST2_DCID_EA_DAMAGE_ICE_PERCENT2,
	CONST2_DCID_EA_DAMAGE_THUNDER_PERCENT2,
	CONST2_DCID_EA_DAMAGE_C_PERCENT2,
	CONST2_DCID_FACTOR_POINT2,
	CONST2_DCID_CON2,
	CONST2_DCID_STR2,
	CONST2_DCID_INT2,
	CONST2_DCID_DEX2,
	CONST2_DCID_CHA2,
	CONST2_DCID_WIS2,
	CONST2_DCID_MOVEMENT2,
	CONST2_DCID_HP2,
	CONST2_DCID_MP2,
	CONST2_DCID_SP2,
	CONST2_DCID_AP2,
	CONST2_DCID_AGRO2,
	CONST2_DCID_MAX_HP2,
	CONST2_DCID_MAX_MP2,
	CONST2_DCID_MAX_SP2,
	CONST2_DCID_ATK_SPEED2,
	CONST2_DCID_ATK_RANGE2,
	CONST2_DCID_SKILL_CAST2,
	CONST2_DCID_SKILL_DELAY2,
	CONST2_DCID_HIT_RATE2,
	CONST2_DCID_EVADE_RATE2,
	CONST2_DCID_DODGE_RATE2,
	CONST2_DCID_DMG_MIN_PHYSICAL2,
	CONST2_DCID_DMG_MIN_MAGIC2,
	CONST2_DCID_DMG_MIN_WATER2,
	CONST2_DCID_DMG_MIN_AIR2,
	CONST2_DCID_DMG_MIN_EARTH2,
	CONST2_DCID_DMG_MIN_FIRE2,
	CONST2_DCID_DMG_MIN_POISON2,
	CONST2_DCID_DMG_MIN_ICE2,
	CONST2_DCID_DMG_MIN_THUNDER2,
	CONST2_DCID_DMG_MAX_PHYSICAL2,
	CONST2_DCID_DMG_MAX_MAGIC2,
	CONST2_DCID_DMG_MAX_WATER2,
	CONST2_DCID_DMG_MAX_AIR2,
	CONST2_DCID_DMG_MAX_EARTH2,
	CONST2_DCID_DMG_MAX_FIRE2,
	CONST2_DCID_DMG_MAX_POISON2,
	CONST2_DCID_DMG_MAX_ICE2,
	CONST2_DCID_DMG_MAX_THUNDER2,
	CONST2_DCID_DEF_POINT_PHYSICAL2,
	CONST2_DCID_DEF_POINT_MAGIC2,
	CONST2_DCID_DEF_POINT_WATER2,
	CONST2_DCID_DEF_POINT_AIR2,
	CONST2_DCID_DEF_POINT_EARTH2,
	CONST2_DCID_DEF_POINT_FIRE2,
	CONST2_DCID_DEF_POINT_POISON2,
	CONST2_DCID_DEF_POINT_ICE2,
	CONST2_DCID_DEF_POINT_THUNDER2,
	CONST2_DCID_PHYSICAL_RESISTANCE2,
	CONST2_DCID_PHYSICAL_BLOCK2,
	CONST2_DCID_SKILL_BLOCK2,
	CONST2_DCID_FACTOR_PERCENT2,
	CONST2_DCID_IGNORE_PHYSICAL_DEFENCE_PERCENT2,
	CONST2_DCID_IGNORE_ATTRIBUTE_DEFENCE_PERCENT2,
	CONST2_DCID_CRITICAL_DEFENCE_PERCENT2,
	CONST2_DCID_DURABILITY_PERCENT2,
	CONST2_DCID_DURABILITY_NUM2,
};

static void addeffect(
	struct ap_skill_template * temp,
	uint64_t type_bit,
	boolean process_interval)
{
	temp->effect_type |= type_bit;
	if (process_interval)
		temp->process_interval_effect_type |= type_bit;
}

static void addeffect2(
	struct ap_skill_template * temp,
	uint64_t type_bit,
	boolean process_interval)
{
	temp->effect_type2 |= type_bit;
	if (process_interval)
		temp->process_interval_effect_type2 |= type_bit;
}

static void addeffectdetail(
	struct ap_skill_template * temp,
	enum ap_skill_effect_detail detail,
	uint64_t type_bit,
	boolean process_interval)
{
	if (detail < 0 || detail >= AP_SKILL_EFFECT_DETAIL_COUNT) {
		assert(0);
		return;
	}
	temp->effect_detail_type[detail] |= type_bit;
	if (process_interval) {
		temp->process_interval_effect_detail_type[detail] |= 
			type_bit;
	}
}

void setspecialstatus(
	struct ap_skill_template * temp, 
	uint32_t value)
{
	switch (value) {
	case 1:
		temp->special_status |= AP_SKILL_SPECIAL_STATUS_STUN;
		break;
	case 2:
		temp->special_status |= AP_SKILL_SPECIAL_STATUS_FREEZE;
		break;
	case 3:
		temp->special_status |= AP_SKILL_SPECIAL_STATUS_SLOW;
		break;
	case 4:
		temp->special_status |= 
			AP_SKILL_SPECIAL_STATUS_INVINCIBLE;
		break;
	case 5:
		temp->special_status |= 
			AP_SKILL_SPECIAL_STATUS_ATTRIBUTE_INVINCIBLE;
		break;
	case 6:
		temp->special_status |= 
			AP_SKILL_SPECIAL_STATUS_NOT_ADD_AGRO;
		break;
	case 7:
		temp->special_status |= AP_SKILL_SPECIAL_STATUS_HIDE_AGRO;
		break;
	case 8:
		temp->special_status |= 
			AP_SKILL_SPECIAL_STATUS_STUN_PROTECT;
		break;
	case 9:
		temp->special_status |= AP_SKILL_SPECIAL_STATUS_HALT;
		break;
	case 10:
		temp->special_status |= 
			AP_SKILL_SPECIAL_STATUS_TRANSPARENT;
		break;
	case 11:
		temp->special_status |= 
			AP_SKILL_SPECIAL_STATUS_HALF_TRANSPARENT;
		break;
	case 12:
		temp->special_status |= 
			AP_SKILL_SPECIAL_STATUS_NORMAL_ATK_INVINCIBLE;
		break;
	case 13:
		temp->special_status |= 
			AP_SKILL_SPECIAL_STATUS_SKILL_ATK_INVINCIBLE;
		break;
	case 14:
		temp->special_status |= 
			AP_SKILL_SPECIAL_STATUS_DISABLE_SKILL;
		break;
	case 15:
		temp->special_status |= 
			AP_SKILL_SPECIAL_STATUS_DISABLE_NORMAL_ATK;
		break;
	case 16:
		temp->special_status |= AP_SKILL_SPECIAL_STATUS_SLEEP;
		break;
	case 17:
		temp->special_status |= 
			AP_SKILL_SPECIAL_STATUS_STUN_PROTECT;
		temp->special_status |= 
			AP_SKILL_SPECIAL_STATUS_SLOW_INVINCIBLE;
		break;
	case 18:
		temp->special_status |= 
			AP_SKILL_SPECIAL_STATUS_DISARMAMENT;
		break;
	case 19:
		temp->special_status |= 
			AP_SKILL_SPECIAL_STATUS_DISABLE_CHATTING;
		break;
	case 20:
		temp->special_status |= AP_SKILL_SPECIAL_STATUS_HOLD;
		break;
	case 21:
		temp->special_status |= AP_SKILL_SPECIAL_STATUS_CONFUSION;
		break;
	case 22:
		temp->special_status |= AP_SKILL_SPECIAL_STATUS_FEAR;
		break;
	case 23:
		temp->special_status |= AP_SKILL_SPECIAL_STATUS_DISEASE;
		break;
	case 24:
		temp->special_status |= AP_SKILL_SPECIAL_STATUS_BERSERK;
		break;
	case 25:
		temp->special_status |= AP_SKILL_SPECIAL_STATUS_SHRINK;
		break;
	}
}

static uint32_t getconstfactor(
	enum const_data_column_id id)
{
	switch (id) {
	case CONST_DCID_SKILL_LEVEL:
		return AP_SKILL_CONST_SKILL_LEVEL;
	case CONST_DCID_SKILL_TYPE:
		return AP_SKILL_CONST_SKILL_TYPE;
	case CONST_DCID_SKILL_TYPE2:
		return AP_SKILL_CONST_SKILL_TYPE2;
	case CONST_DCID_BUFF_TYPE:
		return AP_SKILL_CONST_BUFF_TYPE;
	case CONST_DCID_REQUIRE_CLASS_KNIGHT:
		return AP_SKILL_CONST_REQUIRE_CLASS_KNIGHT;
	case CONST_DCID_REQUIRE_CLASS_ARCHER:
		return AP_SKILL_CONST_REQUIRE_CLASS_ARCHER;
	case CONST_DCID_REQUIRE_CLASS_WIZARD:
		return AP_SKILL_CONST_REQUIRE_CLASS_WIZARD;
	case CONST_DCID_REQUIRE_CLASS_BERSERKER:
		return AP_SKILL_CONST_REQUIRE_CLASS_BERSERKER;
	case CONST_DCID_REQUIRE_CLASS_HUNTER:
		return AP_SKILL_CONST_REQUIRE_CLASS_HUNTER;
	case CONST_DCID_REQUIRE_CLASS_SORCERER:
		return AP_SKILL_CONST_REQUIRE_CLASS_SORCERER;
	case CONST_DCID_REQUIRE_CLASS_SWASHBUCKLER:
		return AP_SKILL_CONST_REQUIRE_CLASS_SWASHBUCKLER;
	case CONST_DCID_REQUIRE_CLASS_RANGER:
		return AP_SKILL_CONST_REQUIRE_CLASS_RANGER;
	case CONST_DCID_REQUIRE_CLASS_ELEMENTALER:
		return AP_SKILL_CONST_REQUIRE_CLASS_ELEMENTALER;
	case CONST_DCID_REQUIRE_CLASS_SLAYER:
		return AP_SKILL_CONST_REQUIRE_CLASS_SLAYER;
	case CONST_DCID_REQUIRE_CLASS_OBITER:
		return AP_SKILL_CONST_REQUIRE_CLASS_OBITER;
	case CONST_DCID_REQUIRE_CLASS_SUMMONER:
		return AP_SKILL_CONST_REQUIRE_CLASS_SUMMONER;
	case CONST_DCID_REQUIRE_CLASS_SCION:
		return AP_SKILL_CONST_REQUIRE_CLASS_SCION;
	case CONST_DCID_REQUIRE_LEVEL:
		return AP_SKILL_CONST_REQUIRE_LEVEL;
	case CONST_DCID_REQUIRE_POINT:
		return AP_SKILL_CONST_REQUIRE_POINT;
	case CONST_DCID_REQUIRE_HEROIC_POINT:
		return AP_SKILL_CONST_REQUIRE_HEROIC_POINT;
	case CONST_DCID_REQUIRE_CHARISMA_POINT:
		return AP_SKILL_CONST_REQUIRE_CHARISMA_POINT;
	case CONST_DCID_DAMAGE_A:
		return AP_SKILL_CONST_DAMAGE_A;
	case CONST_DCID_DAMAGE_MAGIC:
		return AP_SKILL_CONST_DAMAGE_MAGIC;
	case CONST_DCID_DAMAGE_WATER:
		return AP_SKILL_CONST_DAMAGE_WATER;
	case CONST_DCID_DAMAGE_AIR:
		return AP_SKILL_CONST_DAMAGE_AIR;
	case CONST_DCID_DAMAGE_EARTH:
		return AP_SKILL_CONST_DAMAGE_EARTH;
	case CONST_DCID_DAMAGE_FIRE:
		return AP_SKILL_CONST_DAMAGE_FIRE;
	case CONST_DCID_DAMAGE_POISON:
		return AP_SKILL_CONST_DAMAGE_POISON;
	case CONST_DCID_DAMAGE_ICE:
		return AP_SKILL_CONST_DAMAGE_ICE;
	case CONST_DCID_DAMAGE_THUNDER:
		return AP_SKILL_CONST_DAMAGE_THUNDER;
	case CONST_DCID_DMG_HEROIC:
		return AP_SKILL_CONST_DAMAGE_HEROIC;
	case CONST_DCID_DAMAGE_C:
		return AP_SKILL_CONST_DAMAGE_C;
	case CONST_DCID_DAMAGE_A_PERCENT:
		return AP_SKILL_CONST_DAMAGE_A_PERCENT;
	case CONST_DCID_DAMAGE_MAGIC_PERCENT:
		return AP_SKILL_CONST_DAMAGE_MAGIC_PERCENT;
	case CONST_DCID_DAMAGE_WATER_PERCENT:
		return AP_SKILL_CONST_DAMAGE_WATER_PERCENT;
	case CONST_DCID_DAMAGE_AIR_PERCENT:
		return AP_SKILL_CONST_DAMAGE_AIR_PERCENT;
	case CONST_DCID_DAMAGE_EARTH_PERCENT:
		return AP_SKILL_CONST_DAMAGE_EARTH_PERCENT;
	case CONST_DCID_DAMAGE_FIRE_PERCENT:
		return AP_SKILL_CONST_DAMAGE_FIRE_PERCENT;
	case CONST_DCID_DAMAGE_POISON_PERCENT:
		return AP_SKILL_CONST_DAMAGE_POISON_PERCENT;
	case CONST_DCID_DAMAGE_ICE_PERCENT:
		return AP_SKILL_CONST_DAMAGE_ICE_PERCENT;
	case CONST_DCID_DAMAGE_THUNDER_PERCENT:
		return AP_SKILL_CONST_DAMAGE_THUNDER_PERCENT;
	case CONST_DCID_DMG_HEROIC_PERCENT:
		return AP_SKILL_CONST_DAMAGE_HEROIC_PERCENT;
	case CONST_DCID_DAMAGE_C_PERCENT:
		return AP_SKILL_CONST_DAMAGE_C_PERCENT;
	case CONST_DCID_RESIST_A:
		return AP_SKILL_CONST_RESIST_A;
	case CONST_DCID_COST_HP:
		return AP_SKILL_CONST_COST_HP;
	case CONST_DCID_COST_MP:
		return AP_SKILL_CONST_COST_MP;
	case CONST_DCID_COST_SP:
		return AP_SKILL_CONST_COST_SP;
	case CONST_DCID_COST_ARROW:
		return AP_SKILL_CONST_COST_ARROW;
	case CONST_DCID_ENDSKILL_COST_HP:
		return AP_SKILL_CONST_ENDSKILL_COST_HP;
	case CONST_DCID_CAST_TIME:
		return AP_SKILL_CONST_CAST_TIME;
	case CONST_DCID_RECAST_TIME:
		return AP_SKILL_CONST_RECAST_TIME;
	case CONST_DCID_SEMI_RECAST_TIME:
		return AP_SKILL_CONST_SEMI_RECAST_TIME;
	case CONST_DCID_DURATION:
		return AP_SKILL_CONST_DURATION;
	case CONST_DCID_INTERVAL:
		return AP_SKILL_CONST_INTERVAL;
	case CONST_DCID_SHOW_DAMAGE:
		return AP_SKILL_CONST_SHOW_DAMAGE;
	case CONST_DCID_RANGE:
		return AP_SKILL_CONST_RANGE;
	case CONST_DCID_AREA_R:
		return AP_SKILL_CONST_TARGET_AREA_R;
	case CONST_DCID_AREA_F1:
		return AP_SKILL_CONST_TARGET_AREA_F1;
	case CONST_DCID_AREA_F2:
		return AP_SKILL_CONST_TARGET_AREA_F2;
	case CONST_DCID_DOT_DMG_A:
		return AP_SKILL_CONST_DOT_DMG_A;
	case CONST_DCID_DOT_DMG_MAGIC:
		return AP_SKILL_CONST_DOT_DMG_MAGIC;
	case CONST_DCID_DOT_DMG_WATER:
		return AP_SKILL_CONST_DOT_DMG_WATER;
	case CONST_DCID_DOT_DMG_AIR:
		return AP_SKILL_CONST_DOT_DMG_AIR;
	case CONST_DCID_DOT_DMG_EARTH:
		return AP_SKILL_CONST_DOT_DMG_EARTH;
	case CONST_DCID_DOT_DMG_FIRE:
		return AP_SKILL_CONST_DOT_DMG_FIRE;
	case CONST_DCID_DOT_DMG_POISON:
		return AP_SKILL_CONST_DOT_DMG_POISON;
	case CONST_DCID_DOT_DMG_ICE:
		return AP_SKILL_CONST_DOT_DMG_ICE;
	case CONST_DCID_DOT_DMG_THUNDER:
		return AP_SKILL_CONST_DOT_DMG_THUNDER;
	case CONST_DCID_DOT_DMG_HEROIC:
		return AP_SKILL_CONST_DOT_DMG_HEROIC;
	case CONST_DCID_DOT_DMG_A_PERCENT:
		return AP_SKILL_CONST_DOT_DMG_A_PERCENT;
	case CONST_DCID_DOT_DMG_MAGIC_PERCENT:
		return AP_SKILL_CONST_DOT_DMG_MAGIC_PERCENT;
	case CONST_DCID_DOT_DMG_WATER_PERCENT:
		return AP_SKILL_CONST_DOT_DMG_WATER_PERCENT;
	case CONST_DCID_DOT_DMG_AIR_PERCENT:
		return AP_SKILL_CONST_DOT_DMG_AIR_PERCENT;
	case CONST_DCID_DOT_DMG_EARTH_PERCENT:
		return AP_SKILL_CONST_DOT_DMG_EARTH_PERCENT;
	case CONST_DCID_DOT_DMG_FIRE_PERCENT:
		return AP_SKILL_CONST_DOT_DMG_FIRE_PERCENT;
	case CONST_DCID_DOT_DMG_POISON_PERCENT:
		return AP_SKILL_CONST_DOT_DMG_POISON_PERCENT;
	case CONST_DCID_DOT_DMG_ICE_PERCENT:
		return AP_SKILL_CONST_DOT_DMG_ICE_PERCENT;
	case CONST_DCID_DOT_DMG_THUNDER_PERCENT:
		return AP_SKILL_CONST_DOT_DMG_THUNDER_PERCENT;
	case CONST_DCID_MOVE_DISTANCE:
		return AP_SKILL_CONST_MOVE_DISTANCE;
	case CONST_DCID_REFLECT_MAX:
		return AP_SKILL_CONST_REFLECT_MAX;
	case CONST_DCID_HEROIC_REFLECT_MAX:
		return AP_SKILL_CONST_HEROIC_REFLECT_MAX;
	case CONST_DCID_DEFENSE_MAX:
		return AP_SKILL_CONST_DEFENSE_MAX;
	case CONST_DCID_REFLECT_CON:
		return AP_SKILL_CONST_REFLECT_CON;
	case CONST_DCID_DEFENSE_CON:
		return AP_SKILL_CONST_DEFENSE_CON;
	case CONST_DCID_DAMAGE_SHIELD:
		return AP_SKILL_CONST_DAMAGE_SHIELD;
	case CONST_DCID_COUNTER_UP:
		return AP_SKILL_CONST_COUNTER_UP;
	case CONST_DCID_COUNTER_REDUCE:
		return AP_SKILL_CONST_COUNTER_REDUCE;
	case CONST_DCID_HOT:
		return AP_SKILL_CONST_HOT;
	case CONST_DCID_DMG_ADJUST:
		return AP_SKILL_CONST_DMG_ADJUST;
	case CONST_DCID_DMG_SHOW_DIVIDE:
		return AP_SKILL_CONST_DMG_SHOW_DIVIDE;
	case CONST_DCID_HP_RECOVERY:
		return AP_SKILL_CONST_HP_RECOVERY;
	case CONST_DCID_MP_RECOVERY:
		return AP_SKILL_CONST_MP_RECOVERY;
	case CONST_DCID_SP_RECOVERY:
		return AP_SKILL_CONST_SP_RECOVERY;
	case CONST_DCID_WARRIOR_LEV:
		return AP_SKILL_CONST_WARRIOR_LEVEL;
	case CONST_DCID_CHANGE_MONSTER:
		return AP_SKILL_CONST_CHANGE_MONSTER;
	case CONST_DCID_BLOCK_POINT:
		return AP_SKILL_CONST_BLOCK_POINT;
	case CONST_DCID_STUN_TIME:
		return AP_SKILL_CONST_STUN_TIME;
	case CONST_DCID_STUN_GENERATE_TIME:
		return AP_SKILL_CONST_STUN_GENERATE_TIME;
	case CONST_DCID_CRITICAL:
		return AP_SKILL_CONST_CRITICAL;
	case CONST_DCID_SKILL_RANGE:
		return AP_SKILL_CONST_SKILL_RANGE;
	case CONST_DCID_SKILL_RATE:
		return AP_SKILL_CONST_SKILL_RATE;
	case CONST_DCID_DAMAGE_CONVERT_HP:
		return AP_SKILL_CONST_DAMAGE_CONVERT_HP;
	case CONST_DCID_DAMAGE_CONVERT_MP:
		return AP_SKILL_CONST_DAMAGE_CONVERT_MP;
	case CONST_DCID_REGEN_HP:
		return AP_SKILL_CONST_REGEN_HP;
	case CONST_DCID_REGEN_MP:
		return AP_SKILL_CONST_REGEN_MP;
	case CONST_DCID_CHARGE_1:
		return AP_SKILL_CONST_CHARGE_1;
	case CONST_DCID_CHARGE_2:
		return AP_SKILL_CONST_CHARGE_2;
	case CONST_DCID_CHARGE_3:
		return AP_SKILL_CONST_CHARGE_3;
	case CONST_DCID_AGGRODOLL_HP:
		return AP_SKILL_CONST_AGGRODOLL_HP;
	case CONST_DCID_DOT_DAMAGE_TIME:
		return AP_SKILL_CONST_DOT_DAMAGE_TIME;
	case CONST_DCID_COST_MP_DECREASE:
		return AP_SKILL_CONST_COST_MP_DECREASE;
	case CONST_DCID_CAST_TIME_DECREASE:
		return AP_SKILL_CONST_CAST_TIME_DECREASE;
	case CONST_DCID_SKILL_LEVELUP:
		return AP_SKILL_CONST_SKILL_LEVELUP;
	case CONST_DCID_MP_CONVERT_HP:
		return AP_SKILL_CONST_MP_CONVERT_HP;
	case CONST_DCID_DEATH:
		return AP_SKILL_CONST_DEATH;
	case CONST_DCID_TIME_CONTROL:
		return AP_SKILL_CONST_TIME_CONTROL;
	case CONST_DCID_ITEM_PARTS:
		return AP_SKILL_CONST_ITEM_PARTS;
	case CONST_DCID_SKILL_COST:
		return AP_SKILL_CONST_SKILL_COST;
	case CONST_DCID_SKILL_UPGRADE_COST:
		return AP_SKILL_CONST_SKILL_UPGRADE_COST;
	case CONST_DCID_SKILL_CLASSIFY_ID:
		return AP_SKILL_CONST_SKILL_CLASSIFY_ID;
	case CONST_DCID_SKILL_CLASSIFY_LEVEL:
		return AP_SKILL_CONST_SKILL_CLASSIFY_LEVEL;
	case CONST_DCID_VELOCITY:
		return AP_SKILL_CONST_VELOCITY;
	case CONST_DCID_SUMMONS_TID:
		return AP_SKILL_CONST_SUMMONS_TID;
	case CONST_DCID_ADDITIONAL_DURATION:
		return AP_SKILL_CONST_ADDITIONAL_DURATION;
	case CONST_DCID_MAX_TARGET_NUM:
		return AP_SKILL_CONST_MAX_TARGET_NUM;
	case CONST_DCID_LIMIT_QUANTITY:
		return AP_SKILL_CONST_LIMIT_QUANTITY;
	case CONST_DCID_SUMMONS_COUNT:
		return AP_SKILL_CONST_SUMMONS_COUNT;
	case CONST_DCID_BONUS_EXP:
		return AP_SKILL_CONST_BONUS_EXP;
	case CONST_DCID_BONUS_MONEY:
		return AP_SKILL_CONST_BONUS_MONEY;
	case CONST_DCID_BONUS_DROP_RATE:
		return AP_SKILL_CONST_BONUS_DROP_RATE;
	case CONST_DCID_BONUS_CHARISMA_ADD_RATE:
		return AP_SKILL_CONST_BONUS_CHARISMA_RATE;
	case CONST_DCID_LEVEL_DIFF:
		return AP_SKILL_CONST_LEVEL_DIFF;
	case CONST_DCID_DIVIDE_RATE:
		return AP_SKILL_CONST_DIVIDE_RATE;
	case CONST_DCID_EA_DAMAGE_PHYSICAL:
		return AP_SKILL_CONST_EA_DMG_PHYSICAL;
	case CONST_DCID_EA_DAMAGE_MAGIC:
		return AP_SKILL_CONST_EA_DMG_MAGIC;
	case CONST_DCID_EA_DAMAGE_WATER:
		return AP_SKILL_CONST_EA_DMG_WATER;
	case CONST_DCID_EA_DAMAGE_AIR:
		return AP_SKILL_CONST_EA_DMG_AIR;
	case CONST_DCID_EA_DAMAGE_EARTH:
		return AP_SKILL_CONST_EA_DMG_EARTH;
	case CONST_DCID_EA_DAMAGE_FIRE:
		return AP_SKILL_CONST_EA_DMG_FIRE;
	case CONST_DCID_EA_DAMAGE_POISON:
		return AP_SKILL_CONST_EA_DMG_POISON;
	case CONST_DCID_EA_DAMAGE_ICE:
		return AP_SKILL_CONST_EA_DMG_ICE;
	case CONST_DCID_EA_DAMAGE_THUNDER:
		return AP_SKILL_CONST_EA_DMG_THUNDER;
	case CONST_DCID_EA_DAMAGE_C:
		return AP_SKILL_CONST_EA_DMG_C;
	case CONST_DCID_EA_DAMAGE_PHYSICAL_PERCENT:
		return AP_SKILL_CONST_EA_DMG_PHYSICAL_PERCENT;
	case CONST_DCID_EA_DAMAGE_MAGIC_PERCENT:
		return AP_SKILL_CONST_EA_DMG_MAGIC_PERCENT;
	case CONST_DCID_EA_DAMAGE_WATER_PERCENT:
		return AP_SKILL_CONST_EA_DMG_WATER_PERCENT;
	case CONST_DCID_EA_DAMAGE_AIR_PERCENT:
		return AP_SKILL_CONST_EA_DMG_AIR_PERCENT;
	case CONST_DCID_EA_DAMAGE_EARTH_PERCENT:
		return AP_SKILL_CONST_EA_DMG_EARTH_PERCENT;
	case CONST_DCID_EA_DAMAGE_FIRE_PERCENT:
		return AP_SKILL_CONST_EA_DMG_FIRE_PERCENT;
	case CONST_DCID_EA_DAMAGE_POISON_PERCENT:
		return AP_SKILL_CONST_EA_DMG_POISON_PERCENT;
	case CONST_DCID_EA_DAMAGE_ICE_PERCENT:
		return AP_SKILL_CONST_EA_DMG_ICE_PERCENT;
	case CONST_DCID_EA_DAMAGE_THUNDER_PERCENT:
		return AP_SKILL_CONST_EA_DMG_THUNDER_PERCENT;
	case CONST_DCID_EA_DAMAGE_C_PERCENT:
		return AP_SKILL_CONST_EA_DMG_C_PERCENT;
	case CONST_DCID_CON:
		return AP_SKILL_CONST_POINT_CON;
	case CONST_DCID_STR:
		return AP_SKILL_CONST_POINT_STR;
	case CONST_DCID_INT:
		return AP_SKILL_CONST_POINT_INT;
	case CONST_DCID_DEX:
		return AP_SKILL_CONST_POINT_DEX;
	case CONST_DCID_CHA:
		return AP_SKILL_CONST_POINT_CHA;
	case CONST_DCID_WIS:
		return AP_SKILL_CONST_POINT_WIS;
	case CONST_DCID_MOVEMENT:
		return AP_SKILL_CONST_POINT_MOVEMENT;
	case CONST_DCID_HP:
		return AP_SKILL_CONST_POINT_HP;
	case CONST_DCID_MP:
		return AP_SKILL_CONST_POINT_MP;
	case CONST_DCID_SP:
		return AP_SKILL_CONST_POINT_SP;
	case CONST_DCID_AP:
		return AP_SKILL_CONST_POINT_AP;
	case CONST_DCID_AGRO:
		return AP_SKILL_CONST_POINT_AGRO;
	case CONST_DCID_MAX_HP:
		return AP_SKILL_CONST_POINT_HP_MAX;
	case CONST_DCID_MAX_MP:
		return AP_SKILL_CONST_POINT_MP_MAX;
	case CONST_DCID_MAX_SP:
		return AP_SKILL_CONST_POINT_SP_MAX;
	case CONST_DCID_ATK_SPEED:
		return AP_SKILL_CONST_POINT_ATK_SPEED;
	case CONST_DCID_ATK_RANGE:
		return AP_SKILL_CONST_POINT_ATK_RANGE;
	case CONST_DCID_SKILL_CAST:
		return AP_SKILL_CONST_POINT_SKILL_CAST;
	case CONST_DCID_SKILL_DELAY:
		return AP_SKILL_CONST_POINT_SKILL_DELAY;
	case CONST_DCID_HIT_RATE:
		return AP_SKILL_CONST_POINT_HIT_RATE;
	case CONST_DCID_EVADE_RATE:
		return AP_SKILL_CONST_POINT_EVADE_RATE;
	case CONST_DCID_DODGE_RATE:
		return AP_SKILL_CONST_POINT_DODGE_RATE;
	case CONST_DCID_DMG_MIN_PHYSICAL:
		return AP_SKILL_CONST_POINT_DMG_MIN_PHYSICAL;
	case CONST_DCID_DMG_MIN_MAGIC:
		return AP_SKILL_CONST_POINT_DMG_MIN_MAGIC;
	case CONST_DCID_DMG_MIN_WATER:
		return AP_SKILL_CONST_POINT_DMG_MIN_WATER;
	case CONST_DCID_DMG_MIN_AIR:
		return AP_SKILL_CONST_POINT_DMG_MIN_AIR;
	case CONST_DCID_DMG_MIN_EARTH:
		return AP_SKILL_CONST_POINT_DMG_MIN_EARTH;
	case CONST_DCID_DMG_MIN_FIRE:
		return AP_SKILL_CONST_POINT_DMG_MIN_FIRE;
	case CONST_DCID_DMG_MIN_POISON:
		return AP_SKILL_CONST_POINT_DMG_MIN_POISON;
	case CONST_DCID_DMG_MIN_ICE:
		return AP_SKILL_CONST_POINT_DMG_MIN_ICE;
	case CONST_DCID_DMG_MIN_THUNDER:
		return AP_SKILL_CONST_POINT_DMG_MIN_LIGHTENING;
	case CONST_DCID_DMG_MAX_PHYSICAL:
		return AP_SKILL_CONST_POINT_DMG_MAX_PHYSICAL;
	case CONST_DCID_DMG_MAX_MAGIC:
		return AP_SKILL_CONST_POINT_DMG_MAX_MAGIC;
	case CONST_DCID_DMG_MAX_WATER:
		return AP_SKILL_CONST_POINT_DMG_MAX_WATER;
	case CONST_DCID_DMG_MAX_AIR:
		return AP_SKILL_CONST_POINT_DMG_MAX_AIR;
	case CONST_DCID_DMG_MAX_EARTH:
		return AP_SKILL_CONST_POINT_DMG_MAX_EARTH;
	case CONST_DCID_DMG_MAX_FIRE:
		return AP_SKILL_CONST_POINT_DMG_MAX_FIRE;
	case CONST_DCID_DMG_MAX_POISON:
		return AP_SKILL_CONST_POINT_DMG_MAX_POISON;
	case CONST_DCID_DMG_MAX_ICE:
		return AP_SKILL_CONST_POINT_DMG_MAX_ICE;
	case CONST_DCID_DMG_MAX_THUNDER:
		return AP_SKILL_CONST_POINT_DMG_MAX_LIGHTENING;
	case CONST_DCID_DEF_POINT_PHYSICAL:
		return AP_SKILL_CONST_POINT_DEF_POINT_PHYSICAL;
	case CONST_DCID_DEF_POINT_MAGIC:
		return AP_SKILL_CONST_POINT_DEF_POINT_MAGIC;
	case CONST_DCID_DEF_POINT_WATER:
		return AP_SKILL_CONST_POINT_DEF_POINT_WATER;
	case CONST_DCID_DEF_POINT_AIR:
		return AP_SKILL_CONST_POINT_DEF_POINT_AIR;
	case CONST_DCID_DEF_POINT_EARTH:
		return AP_SKILL_CONST_POINT_DEF_POINT_EARTH;
	case CONST_DCID_DEF_POINT_FIRE:
		return AP_SKILL_CONST_POINT_DEF_POINT_FIRE;
	case CONST_DCID_DEF_POINT_POISON:
		return AP_SKILL_CONST_POINT_DEF_POINT_POISON;
	case CONST_DCID_DEF_POINT_ICE:
		return AP_SKILL_CONST_POINT_DEF_POINT_ICE;
	case CONST_DCID_DEF_POINT_THUNDER:
		return AP_SKILL_CONST_POINT_DEF_POINT_LIGHTENING;
	case CONST_DCID_PHYSICAL_RESISTANCE:
		return AP_SKILL_CONST_POINT_DEF_RATE_PHYSICAL;
	case CONST_DCID_PHYSICAL_BLOCK:
		return AP_SKILL_CONST_POINT_DEF_RATE_PHYSICAL_BLOCK;
	case CONST_DCID_SKILL_BLOCK:
		return AP_SKILL_CONST_POINT_DEF_RATE_SKILL_BLOCK;
	case CONST_DCID_DMG_MIN_HEROIC:
		return AP_SKILL_CONST_POINT_DMG_MIN_HEROIC;
	case CONST_DCID_DMG_MAX_HEROIC:
		return AP_SKILL_CONST_POINT_DMG_MAX_HEROIC;
	case CONST_DCID_DEF_POINT_HEROIC:
		return AP_SKILL_CONST_POINT_DEF_POINT_HEROIC;
	case CONST_DCID_HEROIC_MELEE_RESISTANCE:
		return AP_SKILL_CONST_POINT_DEF_RATE_HEROIC_MELEE;
	case CONST_DCID_HEROIC_RANGED_RESISTANCE:
		return AP_SKILL_CONST_POINT_DEF_RATE_HEROIC_RANGED;
	case CONST_DCID_HEROIC_MAGIC_RESISTANCE:
		return AP_SKILL_CONST_POINT_DEF_RATE_HEROIC_MAGIC;	
	default:
		assert(0);
		return UINT32_MAX;
	}
}

static uint32_t getconstfactor2(
	enum const2_data_column_id id)
{
	switch (id) {
	case CONST2_DCID_SKILL_LEVEL2:
		return AP_SKILL_CONST_SKILL_LEVEL;
	case CONST2_DCID_DAMAGE_A2:
		return AP_SKILL_CONST_DAMAGE_A;
	case CONST2_DCID_DAMAGE_MAGIC2:
		return AP_SKILL_CONST_DAMAGE_MAGIC;
	case CONST2_DCID_DAMAGE_WATER2:
		return AP_SKILL_CONST_DAMAGE_WATER;
	case CONST2_DCID_DAMAGE_AIR2:
		return AP_SKILL_CONST_DAMAGE_AIR;
	case CONST2_DCID_DAMAGE_EARTH2:
		return AP_SKILL_CONST_DAMAGE_EARTH;
	case CONST2_DCID_DAMAGE_FIRE2:
		return AP_SKILL_CONST_DAMAGE_FIRE;
	case CONST2_DCID_DAMAGE_POISON2:
		return AP_SKILL_CONST_DAMAGE_POISON;
	case CONST2_DCID_DAMAGE_ICE2:
		return AP_SKILL_CONST_DAMAGE_ICE;
	case CONST2_DCID_DAMAGE_THUNDER2:
		return AP_SKILL_CONST_DAMAGE_THUNDER;
	case CONST2_DCID_DAMAGE_A_PERCENT2:
		return AP_SKILL_CONST_DAMAGE_A_PERCENT;
	case CONST2_DCID_DAMAGE_MAGIC_PERCENT2:
		return AP_SKILL_CONST_DAMAGE_MAGIC_PERCENT;
	case CONST2_DCID_DAMAGE_WATER_PERCENT2:
		return AP_SKILL_CONST_DAMAGE_WATER_PERCENT;
	case CONST2_DCID_DAMAGE_AIR_PERCENT2:
		return AP_SKILL_CONST_DAMAGE_AIR_PERCENT;
	case CONST2_DCID_DAMAGE_EARTH_PERCENT2:
		return AP_SKILL_CONST_DAMAGE_EARTH_PERCENT;
	case CONST2_DCID_DAMAGE_FIRE_PERCENT2:
		return AP_SKILL_CONST_DAMAGE_FIRE_PERCENT;
	case CONST2_DCID_DAMAGE_POISON_PERCENT2:
		return AP_SKILL_CONST_DAMAGE_POISON_PERCENT;
	case CONST2_DCID_DAMAGE_ICE_PERCENT2:
		return AP_SKILL_CONST_DAMAGE_ICE_PERCENT;
	case CONST2_DCID_DAMAGE_THUNDER_PERCENT2:
		return AP_SKILL_CONST_DAMAGE_THUNDER_PERCENT;
	case CONST2_DCID_DAMAGE_C_PERCENT2:
		return AP_SKILL_CONST_DAMAGE_C_PERCENT;
	case CONST2_DCID_COST_HP2:
		return AP_SKILL_CONST_COST_HP;
	case CONST2_DCID_COST_MP2:
		return AP_SKILL_CONST_COST_MP;
	case CONST2_DCID_DURATION2:
		return AP_SKILL_CONST_DURATION;
	case CONST2_DCID_INTERVAL2:
		return AP_SKILL_CONST_INTERVAL;
	case CONST2_DCID_DOT_DMG_A2:
		return AP_SKILL_CONST_DOT_DMG_A;
	case CONST2_DCID_DOT_DMG_MAGIC2:
		return AP_SKILL_CONST_DOT_DMG_MAGIC;
	case CONST2_DCID_DOT_DMG_WATER2:
		return AP_SKILL_CONST_DOT_DMG_WATER;
	case CONST2_DCID_DOT_DMG_AIR2:
		return AP_SKILL_CONST_DOT_DMG_AIR;
	case CONST2_DCID_DOT_DMG_EARTH2:
		return AP_SKILL_CONST_DOT_DMG_EARTH;
	case CONST2_DCID_DOT_DMG_FIRE2:
		return AP_SKILL_CONST_DOT_DMG_FIRE;
	case CONST2_DCID_DOT_DMG_POISON2:
		return AP_SKILL_CONST_DOT_DMG_POISON;
	case CONST2_DCID_DOT_DMG_ICE2:
		return AP_SKILL_CONST_DOT_DMG_ICE;
	case CONST2_DCID_DOT_DMG_THUNDER2:
		return AP_SKILL_CONST_DOT_DMG_THUNDER;
	case CONST2_DCID_DOT_DMG_A_PERCENT2:
		return AP_SKILL_CONST_DOT_DMG_A_PERCENT;
	case CONST2_DCID_DOT_DMG_MAGIC_PERCENT2:
		return AP_SKILL_CONST_DOT_DMG_MAGIC_PERCENT;
	case CONST2_DCID_DOT_DMG_WATER_PERCENT2:
		return AP_SKILL_CONST_DOT_DMG_WATER_PERCENT;
	case CONST2_DCID_DOT_DMG_AIR_PERCENT2:
		return AP_SKILL_CONST_DOT_DMG_AIR_PERCENT;
	case CONST2_DCID_DOT_DMG_EARTH_PERCENT2:
		return AP_SKILL_CONST_DOT_DMG_EARTH_PERCENT;
	case CONST2_DCID_DOT_DMG_FIRE_PERCENT2:
		return AP_SKILL_CONST_DOT_DMG_FIRE_PERCENT;
	case CONST2_DCID_DOT_DMG_POISON_PERCENT2:
		return AP_SKILL_CONST_DOT_DMG_POISON_PERCENT;
	case CONST2_DCID_DOT_DMG_ICE_PERCENT2:
		return AP_SKILL_CONST_DOT_DMG_ICE_PERCENT;
	case CONST2_DCID_DOT_DMG_THUNDER_PERCENT2:
		return AP_SKILL_CONST_DOT_DMG_THUNDER_PERCENT;
	case CONST2_DCID_STUN_TIME2:
		return AP_SKILL_CONST_STUN_TIME;
	case CONST2_DCID_SKILL_RATE2:
		return AP_SKILL_CONST_SKILL_RATE;
	case CONST2_DCID_AGGRODOLL_HP2:
		return AP_SKILL_CONST_AGGRODOLL_HP;
	case CONST2_DCID_DOT_DAMAGE_TIME2:
		return AP_SKILL_CONST_DOT_DAMAGE_TIME;
	case CONST2_DCID_DEATH2:
		return AP_SKILL_CONST_DEATH;
	case CONST2_DCID_CONNECTION_TID2:
		return AP_SKILL_CONST_CONNECTION_TID;
	case CONST2_DCID_SKILL_UNION2:
		return AP_SKILL_CONST_SKILL_UNION;
	case CONST2_DCID_SKILL_UNION_CONTROL2:
		return AP_SKILL_CONST_SKILL_UNION_CONTROL;
	case CONST2_DCID_MAX_SKILL_UNION2:
		return AP_SKILL_CONST_MAX_SKILL_UNION;
	case CONST2_DCID_BONUS_DROP_ADD_RATE2:
		return AP_SKILL_CONST_BONUS_DROP_RATE2;
	case CONST2_DCID_VELOCITY2:
		return AP_SKILL_CONST_VELOCITY;
	case CONST2_DCID_EA_DAMAGE_PHYSICAL2:
		return AP_SKILL_CONST_EA_DMG_PHYSICAL;
	case CONST2_DCID_EA_DAMAGE_MAGIC2:
		return AP_SKILL_CONST_EA_DMG_MAGIC;
	case CONST2_DCID_EA_DAMAGE_WATER2:
		return AP_SKILL_CONST_EA_DMG_WATER;
	case CONST2_DCID_EA_DAMAGE_AIR2:
		return AP_SKILL_CONST_EA_DMG_AIR;
	case CONST2_DCID_EA_DAMAGE_EARTH2:
		return AP_SKILL_CONST_EA_DMG_EARTH;
	case CONST2_DCID_EA_DAMAGE_FIRE2:
		return AP_SKILL_CONST_EA_DMG_FIRE;
	case CONST2_DCID_EA_DAMAGE_POISON2:
		return AP_SKILL_CONST_EA_DMG_POISON;
	case CONST2_DCID_EA_DAMAGE_ICE2:
		return AP_SKILL_CONST_EA_DMG_ICE;
	case CONST2_DCID_EA_DAMAGE_THUNDER2:
		return AP_SKILL_CONST_EA_DMG_THUNDER;
	case CONST2_DCID_EA_DAMAGE_C2:
		return AP_SKILL_CONST_EA_DMG_C;
	case CONST2_DCID_EA_DAMAGE_PHYSICAL_PERCENT2:
		return AP_SKILL_CONST_EA_DMG_PHYSICAL_PERCENT;
	case CONST2_DCID_EA_DAMAGE_MAGIC_PERCENT2:
		return AP_SKILL_CONST_EA_DMG_MAGIC_PERCENT;
	case CONST2_DCID_EA_DAMAGE_WATER_PERCENT2:
		return AP_SKILL_CONST_EA_DMG_WATER_PERCENT;
	case CONST2_DCID_EA_DAMAGE_AIR_PERCENT2:
		return AP_SKILL_CONST_EA_DMG_AIR_PERCENT;
	case CONST2_DCID_EA_DAMAGE_EARTH_PERCENT2:
		return AP_SKILL_CONST_EA_DMG_EARTH_PERCENT;
	case CONST2_DCID_EA_DAMAGE_FIRE_PERCENT2:
		return AP_SKILL_CONST_EA_DMG_FIRE_PERCENT;
	case CONST2_DCID_EA_DAMAGE_POISON_PERCENT2:
		return AP_SKILL_CONST_EA_DMG_POISON_PERCENT;
	case CONST2_DCID_EA_DAMAGE_ICE_PERCENT2:
		return AP_SKILL_CONST_EA_DMG_ICE_PERCENT;
	case CONST2_DCID_EA_DAMAGE_THUNDER_PERCENT2:
		return AP_SKILL_CONST_EA_DMG_THUNDER_PERCENT;
	case CONST2_DCID_EA_DAMAGE_C_PERCENT2:
		return AP_SKILL_CONST_EA_DMG_C_PERCENT;
	case CONST2_DCID_CON2:
		return AP_SKILL_CONST_POINT_CON;
	case CONST2_DCID_STR2:
		return AP_SKILL_CONST_POINT_STR;
	case CONST2_DCID_INT2:
		return AP_SKILL_CONST_POINT_INT;
	case CONST2_DCID_DEX2:
		return AP_SKILL_CONST_POINT_DEX;
	case CONST2_DCID_CHA2:
		return AP_SKILL_CONST_POINT_CHA;
	case CONST2_DCID_WIS2:
		return AP_SKILL_CONST_POINT_WIS;
	case CONST2_DCID_MOVEMENT2:
		return AP_SKILL_CONST_POINT_MOVEMENT;
	case CONST2_DCID_HP2:
		return AP_SKILL_CONST_POINT_HP;
	case CONST2_DCID_MP2:
		return AP_SKILL_CONST_POINT_MP;
	case CONST2_DCID_SP2:
		return AP_SKILL_CONST_POINT_SP;
	case CONST2_DCID_AP2:
		return AP_SKILL_CONST_POINT_AP;
	case CONST2_DCID_AGRO2:
		return AP_SKILL_CONST_POINT_AGRO;
	case CONST2_DCID_MAX_HP2:
		return AP_SKILL_CONST_POINT_HP_MAX;
	case CONST2_DCID_MAX_MP2:
		return AP_SKILL_CONST_POINT_MP_MAX;
	case CONST2_DCID_MAX_SP2:
		return AP_SKILL_CONST_POINT_SP_MAX;
	case CONST2_DCID_ATK_SPEED2:
		return AP_SKILL_CONST_POINT_ATK_SPEED;
	case CONST2_DCID_ATK_RANGE2:
		return AP_SKILL_CONST_POINT_ATK_RANGE;
	case CONST2_DCID_SKILL_CAST2:
		return AP_SKILL_CONST_POINT_SKILL_CAST;
	case CONST2_DCID_SKILL_DELAY2:
		return AP_SKILL_CONST_POINT_SKILL_DELAY;
	case CONST2_DCID_HIT_RATE2:
		return AP_SKILL_CONST_POINT_HIT_RATE;
	case CONST2_DCID_EVADE_RATE2:
		return AP_SKILL_CONST_POINT_EVADE_RATE;
	case CONST2_DCID_DODGE_RATE2:
		return AP_SKILL_CONST_POINT_DODGE_RATE;
	case CONST2_DCID_DMG_MIN_PHYSICAL2:
		return AP_SKILL_CONST_POINT_DMG_MIN_PHYSICAL;
	case CONST2_DCID_DMG_MIN_MAGIC2:
		return AP_SKILL_CONST_POINT_DMG_MIN_MAGIC;
	case CONST2_DCID_DMG_MIN_WATER2:
		return AP_SKILL_CONST_POINT_DMG_MIN_WATER;
	case CONST2_DCID_DMG_MIN_AIR2:
		return AP_SKILL_CONST_POINT_DMG_MIN_AIR;
	case CONST2_DCID_DMG_MIN_EARTH2:
		return AP_SKILL_CONST_POINT_DMG_MIN_EARTH;
	case CONST2_DCID_DMG_MIN_FIRE2:
		return AP_SKILL_CONST_POINT_DMG_MIN_FIRE;
	case CONST2_DCID_DMG_MIN_POISON2:
		return AP_SKILL_CONST_POINT_DMG_MIN_POISON;
	case CONST2_DCID_DMG_MIN_ICE2:
		return AP_SKILL_CONST_POINT_DMG_MIN_ICE;
	case CONST2_DCID_DMG_MIN_THUNDER2:
		return AP_SKILL_CONST_POINT_DMG_MIN_LIGHTENING;
	case CONST2_DCID_DMG_MAX_PHYSICAL2:
		return AP_SKILL_CONST_POINT_DMG_MAX_PHYSICAL;
	case CONST2_DCID_DMG_MAX_MAGIC2:
		return AP_SKILL_CONST_POINT_DMG_MAX_MAGIC;
	case CONST2_DCID_DMG_MAX_WATER2:
		return AP_SKILL_CONST_POINT_DMG_MAX_WATER;
	case CONST2_DCID_DMG_MAX_AIR2:
		return AP_SKILL_CONST_POINT_DMG_MAX_AIR;
	case CONST2_DCID_DMG_MAX_EARTH2:
		return AP_SKILL_CONST_POINT_DMG_MAX_EARTH;
	case CONST2_DCID_DMG_MAX_FIRE2:
		return AP_SKILL_CONST_POINT_DMG_MAX_FIRE;
	case CONST2_DCID_DMG_MAX_POISON2:
		return AP_SKILL_CONST_POINT_DMG_MAX_POISON;
	case CONST2_DCID_DMG_MAX_ICE2:
		return AP_SKILL_CONST_POINT_DMG_MAX_ICE;
	case CONST2_DCID_DMG_MAX_THUNDER2:
		return AP_SKILL_CONST_POINT_DMG_MAX_LIGHTENING;
	case CONST2_DCID_DEF_POINT_PHYSICAL2:
		return AP_SKILL_CONST_POINT_DEF_POINT_PHYSICAL;
	case CONST2_DCID_DEF_POINT_MAGIC2:
		return AP_SKILL_CONST_POINT_DEF_POINT_MAGIC;
	case CONST2_DCID_DEF_POINT_WATER2:
		return AP_SKILL_CONST_POINT_DEF_POINT_WATER;
	case CONST2_DCID_DEF_POINT_AIR2:
		return AP_SKILL_CONST_POINT_DEF_POINT_AIR;
	case CONST2_DCID_DEF_POINT_EARTH2:
		return AP_SKILL_CONST_POINT_DEF_POINT_EARTH;
	case CONST2_DCID_DEF_POINT_FIRE2:
		return AP_SKILL_CONST_POINT_DEF_POINT_FIRE;
	case CONST2_DCID_DEF_POINT_POISON2:
		return AP_SKILL_CONST_POINT_DEF_POINT_POISON;
	case CONST2_DCID_DEF_POINT_ICE2:
		return AP_SKILL_CONST_POINT_DEF_POINT_ICE;
	case CONST2_DCID_DEF_POINT_THUNDER2:
		return AP_SKILL_CONST_POINT_DEF_POINT_LIGHTENING;
	case CONST2_DCID_PHYSICAL_RESISTANCE2:
		return AP_SKILL_CONST_POINT_DEF_RATE_PHYSICAL;
	case CONST2_DCID_PHYSICAL_BLOCK2:
		return AP_SKILL_CONST_POINT_DEF_RATE_PHYSICAL_BLOCK;
	case CONST2_DCID_SKILL_BLOCK2:
		return AP_SKILL_CONST_POINT_DEF_RATE_SKILL_BLOCK;
	case CONST2_DCID_IGNORE_PHYSICAL_DEFENCE_PERCENT2:
		return AP_SKILL_CONST_IGNORE_PHYSICAL_DEFENCE_PERCENT;
	case CONST2_DCID_IGNORE_ATTRIBUTE_DEFENCE_PERCENT2:
		return AP_SKILL_CONST_IGNORE_ATTRIBUTE_DEFENCE_PERCENT;
	case CONST2_DCID_CRITICAL_DEFENCE_PERCENT2:
		return AP_SKILL_CONST_CRITICAL_DEFENCE_PERCENT;
	default:
		assert(0);
		return UINT32_MAX;
	}
}

static uint32_t magnifyconstfactor(
	 enum ap_skill_used_const_factor factor)
{
	switch (factor) {
	case AP_SKILL_CONST_POINT_MOVEMENT:
		return AP_SKILL_CONST_MAGNIFY_MOVEMENT;
	case AP_SKILL_CONST_POINT_ATK_SPEED:
		return AP_SKILL_CONST_MAGNIFY_ATKSPEED;
	default:
		return UINT32_MAX;
	}
}

boolean template_read(
	struct ap_skill_module * mod,
	void * data, 
	struct ap_module_stream * stream)
{
	struct ap_skill_template * temp = data;
	while (ap_module_stream_read_next_value(stream)) {
		const char * value_name = 
			ap_module_stream_get_value_name(stream);
		const char * value = ap_module_stream_get_value(stream);
		if (strcmp(value_name, INI_NAME_NAME) == 0) {
			strlcpy(temp->name, value, sizeof(temp->name));
			ap_admin_add_name(&mod->template_admin, 
				temp->id, value);
		}
		else {
			assert(0);
		}
	}
	return TRUE;
}

static void * makebase(
	struct ap_skill_module * mod,
	const void * base)
{
	void * buffer = ap_packet_get_temp_buffer(mod->ap_packet);
	enum ap_base_type type = ap_base_get_type(base);
	uint32_t id = ap_base_get_id(base);
	au_packet_make_packet(&mod->packet_base, 
		buffer, FALSE, NULL, 0,
		&type, &id);
	return buffer;
}

static inline void * makeaction(
	struct ap_skill_module * mod,
	enum ap_skill_action_type action_type,
	const void * targetbase,
	const struct au_pos * targetpos,
	const uint32_t * cast_time,
	const uint32_t * duration_time,
	const uint32_t * cooldown_time,
	const uint32_t * skill_level,
	const boolean * queue_result_factor,
	const uint32_t * target_ids,
	uint16_t target_count)
{
	void * buffer = ap_packet_get_temp_buffer(mod->ap_packet);
	void * target = NULL;
	if (targetbase)
		target = makebase(mod, targetbase);
	if (target_ids) {
		uint16_t len = sizeof(*target_ids) * target_count;
		au_packet_make_packet(&mod->packet_action, 
			buffer, FALSE, NULL, 0,
			&action_type, /* action type */
			target, /* target base packet */
			NULL, /* cast result factor packet */
			targetpos, /* destination position packet */
			NULL, /* forced attack (ctrl + skill) */
			cast_time, /* cast delay */
			duration_time, /* duration */
			cooldown_time, /* recast delay */
			skill_level, /* skill level */
			queue_result_factor, /* result factor queueing  */
			NULL, /* additional effect */
			target_ids, &len); /* target character id */
	}
	else {
		au_packet_make_packet(&mod->packet_action, 
			buffer, FALSE, NULL, 0,
			&action_type, /* action type */
			target, /* target base packet */
			NULL, /* cast result factor packet */
			targetpos, /* destination position packet */
			NULL, /* forced attack (ctrl + skill) */
			cast_time, /* cast delay */
			duration_time, /* duration */
			cooldown_time, /* recast delay */
			skill_level, /* skill level */
			queue_result_factor, /* result factor queueing  */
			NULL, /* additional effect */
			NULL); /* target character id */
	}
	if (target)
		ap_packet_pop_temp_buffers(mod->ap_packet, 1);
	return buffer;
}

static inline void makeadd(
	struct ap_skill_module * mod,
	struct ap_skill * skill,
	struct ap_character * character,
	void * buffer,
	uint16_t * length)
{
	uint8_t type = AP_SKILL_PACKET_TYPE_ADD;
	void * base = makebase(mod, character);
	void * factor = ap_packet_get_temp_buffer(mod->ap_packet);
	ap_factors_make_packet(mod->ap_factors, factor, &skill->factor,
		AP_FACTORS_BIT_SKILL_LEVEL | AP_FACTORS_BIT_SKILL_POINT |
		AP_FACTORS_BIT_SKILL_EXP);
	au_packet_make_packet(&mod->packet, 
		buffer, TRUE, length,
		AP_SKILL_PACKET_TYPE, 
		&type,
		&skill->id,
		base, /* Base Packet */
		factor, /* Factor Packet */
		&skill->temp->id, /* Template Id */
		&skill->status, /* Status (enum ap_skill_status) */
		NULL, /* Action Packet */
		NULL, /* Skill Point */
		NULL, /* Skill Buff Packet */
		NULL); /* BuffedSkillCombatArg */
	ap_packet_pop_temp_buffers(mod->ap_packet, 2);
}

static boolean skillctor(struct ap_skill_module * mod, struct ap_skill * s)
{
	s->base_type = AP_BASE_TYPE_SKILL;
	return TRUE;
}

static boolean chardtor(struct ap_skill_module * mod, struct ap_character * c)
{
	struct ap_skill_character * sc = ap_skill_get_character(mod, c);
	uint32_t i;
	for (i = 0; i < sc->skill_count; i++)
		ap_skill_free(mod, sc->skill[i]);
	return TRUE;
}

static boolean onregister(
	struct ap_skill_module * mod,
	struct ap_module_registry * registry)
{
	AP_MODULE_INSTANCE_FIND_IN_REGISTRY(registry, mod->ap_character, AP_CHARACTER_MODULE_NAME);
	AP_MODULE_INSTANCE_FIND_IN_REGISTRY(registry, mod->ap_factors, AP_FACTORS_MODULE_NAME);
	AP_MODULE_INSTANCE_FIND_IN_REGISTRY(registry, mod->ap_packet, AP_PACKET_MODULE_NAME);
	AP_MODULE_INSTANCE_FIND_IN_REGISTRY(registry, mod->ap_random, AP_RANDOM_MODULE_NAME);
	AP_MODULE_INSTANCE_FIND_IN_REGISTRY(registry, mod->ap_tick, AP_TICK_MODULE_NAME);
	mod->character_offset = ap_character_attach_data(mod->ap_character,
		AP_CHARACTER_MDI_CHAR, sizeof(struct ap_skill_character),
		mod, NULL, chardtor);
	return TRUE;
}

static void onshutdown(struct ap_skill_module * mod)
{
	size_t index = 0;
	struct ap_skill_template * temp = NULL;
	struct ap_skill * skill = mod->freelist;
	while (skill) {
		struct ap_skill * next = skill->next;
		dealloc(skill);
		skill = next;
	}
	while (ap_admin_iterate_id(&mod->template_admin, 
			&index, (void **)&temp)) {
		ap_module_destruct_module_data(mod, 
			AP_SKILL_MDI_TEMPLATE, temp);
	}
	ap_admin_destroy(&mod->template_admin);
}

struct ap_skill_module * ap_skill_create_module()
{
	struct ap_skill_module * mod = ap_module_instance_new(AP_SKILL_MODULE_NAME,
		sizeof(*mod), onregister, NULL, NULL, onshutdown);
	au_packet_init(&mod->packet, sizeof(uint16_t),
		AU_PACKET_TYPE_UINT8, 1, /* Packet Type */ 
		AU_PACKET_TYPE_INT32, 1, /* Skill Id */
		AU_PACKET_TYPE_PACKET, 1, /* Base Packet */
		AU_PACKET_TYPE_PACKET, 1, /* Factor Packet */
		AU_PACKET_TYPE_INT32, 1, /* Template Id */
		AU_PACKET_TYPE_INT8, 1, /* Status (enum ap_skill_status) */
		AU_PACKET_TYPE_PACKET, 1, /* Action Packet */
		AU_PACKET_TYPE_UINT8, 1, /* Skill Point */
		AU_PACKET_TYPE_PACKET, AP_SKILL_MAX_SKILL_BUFF,
		AU_PACKET_TYPE_MEMORY_BLOCK, 1, /* BuffedSkillCombatArg */
		AU_PACKET_TYPE_END);
	au_packet_init(&mod->packet_base, sizeof(uint8_t),
		AU_PACKET_TYPE_INT8, 1, /* base type */
		AU_PACKET_TYPE_INT32, 1, /* base id */
		AU_PACKET_TYPE_END);
	au_packet_init(&mod->packet_action, sizeof(uint16_t),
		AU_PACKET_TYPE_INT8, 1, /* action type */
		AU_PACKET_TYPE_PACKET, 1, /* target base packet */
		AU_PACKET_TYPE_PACKET, 1, /* cast result factor packet */
		AU_PACKET_TYPE_POS, 1, /* destination position packet */
		AU_PACKET_TYPE_INT8, 1, /* forced attack (ctrl + skill) */
		AU_PACKET_TYPE_UINT32, 1, /* cast delay */
		AU_PACKET_TYPE_UINT32, 1, /* duration */
		AU_PACKET_TYPE_UINT32, 1, /* recast delay */
		AU_PACKET_TYPE_UINT8, 1, /* skill level */
		AU_PACKET_TYPE_UINT8, 1, /* result factor queueing  */
		AU_PACKET_TYPE_UINT32, 1, /* additional effect */
		AU_PACKET_TYPE_MEMORY_BLOCK, 1, /* target character id */
		AU_PACKET_TYPE_END);
	au_packet_init(&mod->packet_buff, sizeof(uint16_t),
		AU_PACKET_TYPE_INT32, 1, /* buffed skill tid */
		AU_PACKET_TYPE_UINT32, 1, /* buffed skill end time */
		AU_PACKET_TYPE_INT32, 1, /* caster tid */
		AU_PACKET_TYPE_UINT8, 1, /* charge level */
		AU_PACKET_TYPE_UINT32, 1, /* expired time */
		AU_PACKET_TYPE_MEMORY_BLOCK, 1, /* BuffedSkillCombatArg */
		AU_PACKET_TYPE_END);
	ap_admin_init(&mod->template_admin, 
		sizeof(struct ap_skill_template), 512);
	ap_module_set_module_data(mod, AP_SKILL_MDI_SKILL,
		sizeof(struct ap_skill), skillctor, NULL);
	ap_module_set_module_data(mod, AP_SKILL_MDI_TEMPLATE,
		sizeof(struct ap_skill_template), NULL, NULL);
	ap_skill_add_stream_callback(mod, AP_SKILL_MDI_TEMPLATE, 
		AP_SKILL_MODULE_NAME, mod, template_read, NULL);
	return mod;
}

boolean ap_skill_read_templates(
	struct ap_skill_module * mod,
	const char * file_path, 
	boolean decrypt)
{
	struct ap_module_stream * stream;
	uint32_t count;
	uint32_t i;
	stream = ap_module_stream_create();
	if (!ap_module_stream_open(stream, file_path, 0, decrypt)) {
		ERROR("Failed to open stream (%s).", file_path);
		ap_module_stream_destroy(stream);
		return FALSE;
	}
	count = ap_module_stream_get_section_count(stream);
	for (i = 0; i < count; i++) {
		uint32_t tid = strtoul(
			ap_module_stream_read_section_name(stream, i), NULL, 10);
		struct ap_skill_template * temp = 
			ap_module_create_module_data(mod, 
				AP_SKILL_MDI_TEMPLATE);
		if (!temp) {
			ERROR("Failed to add skill template (tid = %u).", 
				tid);
			ap_module_stream_destroy(stream);
			return FALSE;
		}
		temp = ap_admin_add_object_by_id(&mod->template_admin, tid);
		if (!temp) {
			ERROR("Failed to add skill template (tid = %u).",
				tid);
			ap_module_stream_destroy(stream);
			return FALSE;
		}
		ap_module_construct_module_data(mod, 
			AP_SKILL_MDI_TEMPLATE, temp);
		temp->id = tid;
		if (!ap_module_stream_enum_read(mod, stream, 
				AP_SKILL_MDI_TEMPLATE, temp)) {
			ERROR("Failed to read skill template (tid = %u).",
				tid);
			ap_module_stream_destroy(stream);
			return FALSE;
		}
	}
	ap_module_stream_destroy(stream);
	INFO("Loaded %u skill templates.", count);
	return TRUE;
}

boolean ap_skill_read_spec(
	struct ap_skill_module * mod,
	const char * file_path, 
	boolean decrypt)
{
	struct au_table * table = au_table_open(file_path, decrypt);
	boolean r = TRUE;
	if (!table) {
		ERROR("Failed to open file (%s).", file_path);
		return FALSE;
	}
	r &= au_table_set_column(table,
		"ìŠ¤í‚¬ëª…", SPEC_DCID_NAME);
	r &= au_table_set_column(table,
		"attribute", SPEC_DCID_ATTRIBUTE);
	r &= au_table_set_column(table,
		"upgradable", SPEC_DCID_UPGRADABLE);
	r &= au_table_set_column(table,
		"check_range", SPEC_DCID_CHECK_RANGE);
	r &= au_table_set_column(table,
		"target", SPEC_DCID_TARGET);
	r &= au_table_set_column(table,
		"range", SPEC_DCID_RANGE);
	r &= au_table_set_column(table,
		"requirement", SPEC_DCID_REQUIREMENT);
	r &= au_table_set_column(table,
		"condition", SPEC_DCID_CONDITION);
	r &= au_table_set_column(table,
		"other_condition", SPEC_DCID_OTHER_CONDITION);
	r &= au_table_set_column(table,
		"arg1", SPEC_DCID_ARG1);
	r &= au_table_set_column(table,
		"arg2", SPEC_DCID_ARG2);
	r &= au_table_set_column(table,
		"arg3", SPEC_DCID_ARG3);
	r &= au_table_set_column(table,
		"arg4", SPEC_DCID_ARG4);
	r &= au_table_set_column(table,
		"arg_string", SPEC_DCID_ARG_STRING);
	r &= au_table_set_column(table,
		"melee_attack", SPEC_DCID_MELEE_ATTACK);
	r &= au_table_set_column(table,
		"magic_attack", SPEC_DCID_MAGIC_ATTACK);
	r &= au_table_set_column(table,
		"count", SPEC_DCID_COUNT);
	r &= au_table_set_column(table,
		"special_status", SPEC_DCID_SPECIAL_STATUS);
	r &= au_table_set_column(table,
		"special_status_arg", SPEC_DCID_SPECIAL_STATUS_ARG);
	r &= au_table_set_column(table,
		"move_pos", SPEC_DCID_MOVE_POS);
	r &= au_table_set_column(table,
		"update_factor", SPEC_DCID_UPDATE_FACTOR);
	r &= au_table_set_column(table,
		"reflect_melee_attack", SPEC_DCID_REFLECT_MELEE_ATTACK);
	r &= au_table_set_column(table,
		"reflect_magic_attack", SPEC_DCID_REFLECT_MAGIC_ATTACK);
	r &= au_table_set_column(table,
		"reflect_heroic_attack", SPEC_DCID_REFLECT_HEROIC_ATTACK);
	r &= au_table_set_column(table,
		"defense_melee_attack", SPEC_DCID_DEFENSE_MELEE_ATTACK);
	r &= au_table_set_column(table,
		"defense_magic_attack", SPEC_DCID_DEFENSE_MAGIC_ATTACK);
	r &= au_table_set_column(table,
		"magic_resist_level_up", SPEC_DCID_MAGIC_RESIST_LEVEL_UP);
	r &= au_table_set_column(table,
		"dispel_magic", SPEC_DCID_DISPEL_MAGIC);
	r &= au_table_set_column(table,
		"transform_target", SPEC_DCID_TRANSFORM_TARGET);
	r &= au_table_set_column(table,
		"life_protection", SPEC_DCID_LIFE_PROTECTION);
	r &= au_table_set_column(table,
		"dot", SPEC_DCID_DOT);
	r &= au_table_set_column(table,
		"infect_around", SPEC_DCID_INFECT_AROUND);
	r &= au_table_set_column(table,
		"add_spellcount", SPEC_DCID_ADD_SPELLCOUNT);
	r &= au_table_set_column(table,
		"dmg_adjust", SPEC_DCID_DMG_ADJUST);
	r &= au_table_set_column(table,
		"skill_factor_adjust", SPEC_DCID_SKILL_FACTOR_ADJUST);
	r &= au_table_set_column(table,
		"update_combat_point", SPEC_DCID_UPDATE_COMBAT_POINT);
	r &= au_table_set_column(table,
		"regen_hp", SPEC_DCID_REGEN_HP);
	r &= au_table_set_column(table,
		"convert_type", SPEC_DCID_CONVERT_TYPE);
	r &= au_table_set_column(table,
		"charge", SPEC_DCID_CHARGE);
	r &= au_table_set_column(table,
		"skill_levelup", SPEC_DCID_SKILL_LEVELUP);
	r &= au_table_set_column(table,
		"product", SPEC_DCID_PRODUCT);
	r &= au_table_set_column(table,
		"twice_packet", SPEC_DCID_TWICE_PACKET);
	r &= au_table_set_column(table,
		"auto_attack", SPEC_DCID_AUTO_ATTACK);
	r &= au_table_set_column(table,
		"dynamic_target", SPEC_DCID_DYNAMIC_TARGET);
	r &= au_table_set_column(table,
		"action_on_action", SPEC_DCID_ACTION_ON_ACTION);
	r &= au_table_set_column(table,
		"at_field", SPEC_DCID_AT_FIELD);
	r &= au_table_set_column(table,
		"summons", SPEC_DCID_SUMMONS);
	r &= au_table_set_column(table,
		"action_passive", SPEC_DCID_ACTION_PASSIVE);
	r &= au_table_set_column(table,
		"duration_type", SPEC_DCID_DURATION_TYPE);
	r &= au_table_set_column(table,
		"limited_max_level", SPEC_DCID_LIMITED_MAX_LEVEL);
	r &= au_table_set_column(table,
		"release_target", SPEC_DCID_RELEASE_TARGET);
	r &= au_table_set_column(table,
		"visible_effect_type", SPEC_DCID_VISIBLE_EFFECT_TYPE);
	r &= au_table_set_column(table,
		"game_bonus", SPEC_DCID_GAME_BONUS);
	r &= au_table_set_column(table,
		"item_use_type", SPEC_DCID_ITEM_USE_TYPE);
	r &= au_table_set_column(table,
		"cash", SPEC_DCID_CASH);
	r &= au_table_set_column(table,
		"level_diff_type", SPEC_DCID_LEVEL_DIFF_TYPE);
	r &= au_table_set_column(table,
		"detect", SPEC_DCID_DETECT);
	r &= au_table_set_column(table,
		"ride", SPEC_DCID_RIDE);
	r &= au_table_set_column(table,
		"game_effect", SPEC_DCID_GAME_EFFECT);
	r &= au_table_set_column(table,
		"force", SPEC_DCID_FORCE);
	r &= au_table_set_column(table,
		"divide", SPEC_DCID_DIVIDE);
	r &= au_table_set_column(table,
		"resurrection", SPEC_DCID_RESURRECTION);
	r &= au_table_set_column(table,
		"skill_union", SPEC_DCID_SKILL_UNION);
	r &= au_table_set_column(table,
		"target_restriction", SPEC_DCID_TARGET_RESTRICTION);
	r &= au_table_set_column(table,
		"disturb", SPEC_DCID_DISTURB);
	r &= au_table_set_column(table,
		"downtime_id", SPEC_DCID_DOWNTIME_ID);
	r &= au_table_set_column(table,
		"downtime_duration", SPEC_DCID_DOWNTIME_DURATION);
	r &= au_table_set_column(table,
		"applied_cooldown_cap", SPEC_DCID_APPLIED_COOLDOWN_CAP);
	if (!r) {
		ERROR("Failed to setup columns.");
		au_table_destroy(table);
		return FALSE;
	}
	while (au_table_read_next_line(table)) {
		struct ap_skill_template * temp = NULL;
		while (au_table_read_next_column(table)) {
			enum data_col_id id = au_table_get_column(table);
			const char * value = au_table_get_value(table);
			uint32_t num = au_table_get_i32(table);
			boolean parsed = TRUE;
			boolean interval = FALSE;
			if (id == SPEC_DCID_NAME) {
				temp = ap_skill_get_template_by_name(mod, value);
				if (!temp) {
					ERROR("Invalid skill template name (%s).",
						value);
					assert(0);
					return FALSE;
				}
				continue;
			}
			if (!temp) {
				assert(0);
				continue;
			}
			switch (id) {
			case SPEC_DCID_ATTRIBUTE:
				if (num >= 40000) {
					temp->attribute |= 
						AP_SKILL_ATTRIBUTE_SAVE_DURATION;
					num -= 40000;
				}
				if (num >= 20000) {
					temp->attribute |= 
						AP_SKILL_ATTRIBUTE_SAVE_EXPIREDATE;
					num -= 20000;
				}
				if (num >= 10000) {
					temp->attribute |= 
						AP_SKILL_ATTRIBUTE_NOT_SEND_CAST;
					num -= 10000;
				}
				if (num >= 1000) {
					temp->attribute |= 
						AP_SKILL_ATTRIBUTE_TYPE_MAGIC;
					num -= 1000;
				}
				if (num >= 200) {
					temp->attribute |= AP_SKILL_ATTRIBUTE_SUMMONS;
					num -= 200;
				}
				if (num >= 100)
					num -= 100;
				if (num >= 40) {
					temp->attribute |= AP_SKILL_ATTRIBUTE_ETC;
					num -= 40;
				}
				if (num >= 20) {
					temp->attribute |= AP_SKILL_ATTRIBUTE_DEBUFF;
					num -= 20;
				}
				else if (num >= 10) {
					temp->attribute |= AP_SKILL_ATTRIBUTE_BUFF;
					num -= 10;
				}
				switch (num) {
				case 1:
					temp->attribute |= 
						AP_SKILL_ATTRIBUTE_PHYSICAL_DMG;
					break;
				case 2:
					temp->attribute |= 
						AP_SKILL_ATTRIBUTE_MAGIC_DMG_MAGIC;
					break;
				case 3:
					temp->attribute |= 
						AP_SKILL_ATTRIBUTE_MAGIC_DMG_FIRE;
					break;
				case 4:
					temp->attribute |= 
						AP_SKILL_ATTRIBUTE_MAGIC_DMG_EARTH;
					break;
				case 5:
					temp->attribute |= 
						AP_SKILL_ATTRIBUTE_MAGIC_DMG_AIR;
					break;
				case 6:
					temp->attribute |= 
						AP_SKILL_ATTRIBUTE_MAGIC_DMG_WATER;
					break;
				case 8:
					temp->attribute |= AP_SKILL_ATTRIBUTE_PRODUCT;
					break;
				case 9:
					temp->attribute |= AP_SKILL_ATTRIBUTE_PASSIVE;
					break;
				}
				break;
			case SPEC_DCID_UPGRADABLE:
				switch (num) {
				case 1:
					temp->attribute |= 
						AP_SKILL_ATTRIBUTE_CAN_UPGRADE;
					break;
				case 2:
					temp->attribute |= 
						AP_SKILL_ATTRIBUTE_CANNOT_UPGRADE;
					break;
				case 3:
					temp->attribute |= 
						AP_SKILL_ATTRIBUTE_CAN_UPGRADE |
						AP_SKILL_ATTRIBUTE_LIMITED_MAX_LEVEL;
					break;
				}
				break;
			case SPEC_DCID_CHECK_RANGE:
				switch (num) {
				case 1:
					temp->range_type |= 
						AP_SKILL_CHECK_RANGE_NORMAL_RANGE;
					break;
				case 2:
					temp->range_type |= 
						AP_SKILL_CHECK_RANGE_NOT_CHECK;
					break;
				case 3:
					temp->range_type |= 
						AP_SKILL_CHECK_RANGE_SERVER_CONTROL;
					break;
				}
				break;
			case SPEC_DCID_TARGET:
				if (num >= 100) {
					temp->target_type |= AP_SKILL_TARGET_SELF_ONLY;
					num -= 100;
				}
				if (num >= 10) {
					temp->target_type |= 
						AP_SKILL_TARGET_FRIENDLY_UNITS;
					num -= 10;
				}
				if (num >= 1) {
					temp->target_type |= 
						AP_SKILL_TARGET_ENEMY_UNITS;
				}
				break;
			case SPEC_DCID_RANGE:
				if (num > 1000) {
					temp->range_type |= 
						AP_SKILL_RANGE_BASE_TARGET;
					num -= 1000;
				}
				else {
					temp->range_type |= 
						AP_SKILL_RANGE_BASE_SELF;
				}
				switch (num) {
				case 1:
					temp->range_type |= 
						AP_SKILL_RANGE_SELF_ONLY;
					break;
				case 2:
					temp->range_type |= 
						AP_SKILL_RANGE_TARGET_ONLY;
					break;
				case 201:
					temp->range_type |= 
						AP_SKILL_RANGE_TARGET_ONLY;
					temp->range_type |= 
						AP_SKILL_RANGE_TARGET_ONLY_INVOLVE_SELF;
					break;
				case 202:
					temp->range_type |= 
						AP_SKILL_RANGE_TARGET_ONLY;
					temp->range_type |= 
						AP_SKILL_RANGE_TARGET_ONLY_ENEMY_UNITS;
					break;
				case 203:
					temp->range_type |= 
						AP_SKILL_RANGE_TARGET_ONLY;
					temp->range_type |= 
						AP_SKILL_RANGE_TARGET_ONLY_FRIENDLY_UNITS;
					break;
				case 204:
					temp->range_type |= 
						AP_SKILL_RANGE_TARGET_ONLY;
					temp->range_type2 |= 
						AP_SKILL_RANGE2_TARGET_DEAD;
					break;
				case 205:
					temp->range_type |= 
						AP_SKILL_RANGE_TARGET_ONLY;
					temp->range_type2 |= 
						AP_SKILL_RANGE2_TARGET_RACE;
					break;
				case 206:
					temp->range_type |= 
						AP_SKILL_RANGE_TARGET_ONLY;
					temp->range_type2 |= 
						AP_SKILL_RANGE2_TARGET_PARTY;
					break;
				case 207:
					temp->range_type |= 
						AP_SKILL_RANGE_TARGET_ONLY;
					temp->range_type2 |= 
						AP_SKILL_RANGE2_TARGET_RACE;
					temp->range_type2 |= 
						AP_SKILL_RANGE2_TARGET_REGION_INVOLVE_PARENT;
					break;
				case 208:
					temp->range_type |= 
						AP_SKILL_RANGE_TARGET_ONLY;
					temp->range_type2 |= 
						AP_SKILL_RANGE2_TARGET_PARTY;
					temp->range_type2 |= 
						AP_SKILL_RANGE2_TARGET_REGION_INVOLVE_PARENT;
					break;
				case 209:
					temp->range_type |= 
						AP_SKILL_RANGE_TARGET_ONLY;
					temp->range_type2 |= 
						AP_SKILL_RANGE2_TARGET_RACE;
					temp->range_type2 |= 
						AP_SKILL_RANGE2_TARGET_REGION;
					break;
				case 210:
					temp->range_type |= 
						AP_SKILL_RANGE_TARGET_ONLY;
					temp->range_type2 |= 
						AP_SKILL_RANGE2_TARGET_PARTY;
					temp->range_type2 |= 
						AP_SKILL_RANGE2_TARGET_REGION;
					break;
				case 211:
					temp->range_type |= 
						AP_SKILL_RANGE_TARGET_ONLY;
					temp->range_type2 |= 
						AP_SKILL_RANGE2_TARGET_REGION_INVOLVE_PARENT;
					break;
				case 3:
					temp->range_type |= 
						AP_SKILL_RANGE_SPHERE;
					temp->range_type |= 
						AP_SKILL_RANGE_SPHERE_USE_CONSTANT;
					break;
				case 301:
					temp->range_type |= 
						AP_SKILL_RANGE_SPHERE;
					temp->range_type |= 
						AP_SKILL_RANGE_SPHERE_USE_ATK_RANGE;
					break;
				case 302:
					temp->range_type |= 
						AP_SKILL_RANGE_SPHERE;
					temp->range_type |= 
						AP_SKILL_RANGE_SPHERE_INVOLVE_SELF;
					break;
				case 303:
					temp->range_type |= 
						AP_SKILL_RANGE_SPHERE;
					temp->range_type |= 
						AP_SKILL_RANGE_SELF_ONLY;
					temp->range_type |= 
						AP_SKILL_RANGE_SPHERE_ONLY_PARTY_MEMBER;
					break;
				case 304:
					temp->range_type |= 
						AP_SKILL_RANGE_SPHERE;
					temp->range_type |= 
						AP_SKILL_RANGE_SPHERE_ONLY_ENEMY_UNITS;
					break;
				case 305:
					temp->range_type |= 
						AP_SKILL_RANGE_SPHERE;
					temp->range_type |= 
						AP_SKILL_RANGE_SPHERE_ONLY_FRIENDLY_UNITS;
					break;
				case 306:
					temp->range_type |= 
						AP_SKILL_RANGE_SPHERE;
					temp->range_type |= 
						AP_SKILL_RANGE_SPHERE_ONLY_UNDEAD_UNITS;
					break;
				case 307:
					temp->range_type |= 
						AP_SKILL_RANGE_SPHERE;
					temp->range_type |= 
						AP_SKILL_RANGE_SPHERE_ONLY_SUMMONS;
					temp->range_type |= 
						AP_SKILL_RANGE_SPHERE_INVOLVE_SELF;
					break;
				case 308:
					temp->range_type |= 
						AP_SKILL_RANGE_SPHERE;
					temp->range_type |= 
						AP_SKILL_RANGE_SPHERE_ONLY_SUMMONS;
					temp->range_type |= 
						AP_SKILL_RANGE_SPHERE_INVOLVE_SELF;
					temp->range_type |= 
						AP_SKILL_RANGE_SPHERE_ONLY_PARTY_MEMBER;
					break;
				case 309:
					temp->range_type2 |= 
						AP_SKILL_RANGE2_SPHERE;
					temp->range_type2 |= 
						AP_SKILL_RANGE2_ONLY_GUILD_MEMBERS;
					break;
				case 4:
					temp->range_type |= 
						AP_SKILL_RANGE_BOX;
					break;
				case 404:
					temp->range_type |= 
						AP_SKILL_RANGE_BOX;
					temp->range_type |= 
						AP_SKILL_RANGE_BOX_ONLY_ENEMY_UNITS;
					break;
				case 5:
					temp->range_type |= 
						AP_SKILL_RANGE_SUMMONS_ONLY;
					break;
				case 501:
					temp->range_type |= 
						AP_SKILL_RANGE_SUMMONS_ONLY;
					temp->range_type |= 
						AP_SKILL_RANGE_SELF_ONLY;
					break;
				case 600:
					break;
				case 601:
					temp->range_type2 |= 
						AP_SKILL_RANGE2_SIEGE_WAR_TO_ALL_ATTACKERS;
					break;
				case 602:
					temp->range_type2 |= 
						AP_SKILL_RANGE2_SIEGE_WAR_TO_ALL_DEFENDERS;
					break;
				case 611:
					temp->range_type2 |= 
						AP_SKILL_RANGE2_SIEGE_WAR_TO_ALL_ATTACKERS;
					temp->range_type2 |= 
						AP_SKILL_RANGE2_SPHERE;
					break;
				case 612:
					temp->range_type2 |= 
						AP_SKILL_RANGE2_SIEGE_WAR_TO_ALL_DEFENDERS;
					temp->range_type2 |= 
						AP_SKILL_RANGE2_SPHERE;
					break;
				case 7:
					temp->range_type2 |= 
						AP_SKILL_RANGE2_GROUND;
					break;
				case 701:
					temp->range_type2 |= 
						AP_SKILL_RANGE2_GROUND;
					temp->range_type2 |= 
						AP_SKILL_RANGE2_ONLY_ENEMY_UNITS;
					temp->range_type2 |= 
						AP_SKILL_RANGE2_SPHERE;
					break;
				case 702:
					temp->range_type2 |= 
						AP_SKILL_RANGE2_GROUND;
					temp->range_type2 |= 
						AP_SKILL_RANGE2_ONLY_GUILD_MEMBERS;
					temp->range_type2 |= 
						AP_SKILL_RANGE2_SPHERE;
					break;
				case 8:
					temp->range_type2 |= 
						AP_SKILL_RANGE2_TARGET_REGION;
					break;
				case 801:
					temp->range_type2 |= 
						AP_SKILL_RANGE2_TARGET_REGION_INVOLVE_PARENT;
					break;
				}
				break;
			case SPEC_DCID_REQUIREMENT:
				switch (num) {
				case 1:
					temp->requirement_type = 
						AP_SKILL_REQUIREMENT_EQUIP_WEAPON;
					break;
				case 2:
					temp->requirement_type = 
						AP_SKILL_REQUIREMENT_EQUIP_WEAPON;
					break;
				case 3:
					temp->requirement_type = 
						AP_SKILL_REQUIREMENT_EQUIP_SHIELD;
					break;
				case 4:
					temp->requirement_type = 
						AP_SKILL_REQUIREMENT_EQUIP_PRODUCT_TOOL;
					break;
				case 5:
					temp->requirement_type = 
						AP_SKILL_REQUIREMENT_EQUIP_WEAPON;
					temp->requirement_type |= 
						AP_SKILL_REQUIREMENT_EQUIP_ONE_HAND_SWORD;
					break;
				case 6:
					temp->requirement_type = 
						AP_SKILL_REQUIREMENT_EQUIP_WEAPON;
					temp->requirement_type |= 
						AP_SKILL_REQUIREMENT_EQUIP_ONE_HAND_AXE;
					break;
				case 7:
					temp->requirement_type = 
						AP_SKILL_REQUIREMENT_EQUIP_WEAPON;
					temp->requirement_type |= 
						AP_SKILL_REQUIREMENT_EQUIP_BLUNT;
					break;
				case 8:
					temp->requirement_type = 
						AP_SKILL_REQUIREMENT_EQUIP_WEAPON;
					temp->requirement_type |= 
						AP_SKILL_REQUIREMENT_EQUIP_TWO_HAND_SLASH;
					break;
				case 9:
					temp->requirement_type = 
						AP_SKILL_REQUIREMENT_EQUIP_WEAPON;
					temp->requirement_type |= 
						AP_SKILL_REQUIREMENT_EQUIP_STAFF;
					break;
				case 10:
					temp->requirement_type = 
						AP_SKILL_REQUIREMENT_EQUIP_WEAPON;
					temp->requirement_type |= 
						AP_SKILL_REQUIREMENT_EQUIP_WAND;
					break;
				case 11:
					temp->requirement_type = 
						AP_SKILL_REQUIREMENT_EQUIP_WEAPON;
					temp->requirement_type |= 
						AP_SKILL_REQUIREMENT_EQUIP_BOW;
					break;
				case 12:
					temp->requirement_type = 
						AP_SKILL_REQUIREMENT_EQUIP_WEAPON;
					temp->requirement_type |= 
						AP_SKILL_REQUIREMENT_EQUIP_CROSS_BOW;
					break;
				case 13:
					temp->requirement_type = 
						AP_SKILL_REQUIREMENT_EQUIP_WEAPON;
					temp->requirement_type |= 
						AP_SKILL_REQUIREMENT_EQUIP_KATARIYA;
					break;
				case 14:
					temp->requirement_type = 
						AP_SKILL_REQUIREMENT_EQUIP_WEAPON;
					temp->requirement_type |= 
						AP_SKILL_REQUIREMENT_EQUIP_CHAKRAM;
					break;
				case 15:
					temp->requirement_type = 
						AP_SKILL_REQUIREMENT_EQUIP_WEAPON;
					temp->requirement_type |= 
						AP_SKILL_REQUIREMENT_EQUIP_LEFT_HAND_SWORD;
					break;
				case 16:
					temp->requirement_type = 
						AP_SKILL_REQUIREMENT_EQUIP_WEAPON;
					temp->requirement_type |= 
						AP_SKILL_REQUIREMENT_EQUIP_RIGHT_WEAPON_ONLY;
					break;
				case 17:
					temp->requirement_type = 
						AP_SKILL_REQUIREMENT_EQUIP_WEAPON;
					temp->requirement_type |= 
						AP_SKILL_REQUIREMENT_EQUIP_CHARON;
					break;
				case 18:
					temp->requirement_type = 
						AP_SKILL_REQUIREMENT_EQUIP_WEAPON;
					temp->requirement_type |= 
						AP_SKILL_REQUIREMENT_EQUIP_ZENON;
					break;
				case 19:
					temp->requirement_type = 
						AP_SKILL_REQUIREMENT_EQUIP_WEAPON;
					temp->requirement_type |= 
						AP_SKILL_REQUIREMENT_EQUIP_CHARON_AND_ZENON;
					break;
				}
				break;
			case SPEC_DCID_CONDITION:
				temp->condition_type = 0;
				if (num >= 4000) {
					temp->condition_type |= 
						AP_SKILL_CONDITION_SERVER_CONTROL;
					num -= 4000;
				}
				if (num >= 2000) {
					temp->condition_type |= 
						AP_SKILL_CONDITION_SKIP_TARGET_NOT_IN_RANGE;
					num -= 2000;
				}
				if (num >= 1000) {
					temp->condition_type |= 
						AP_SKILL_CONDITION_SKIP_CHECK_FIRST;
					num -= 1000;
				}
				switch (num) {
				case 1:
					temp->condition_type |= 
						AP_SKILL_CONDITION_MELEE_ATTACK;
					break;
				case 101:
					temp->condition_type |= 
						AP_SKILL_CONDITION_MELEE_ATTACK;
					temp->condition_type |= 
						AP_SKILL_CONDITION_MELEE_ATTACK_EQUIP_WEAPON;
					break;
				case 102:
					temp->condition_type |= 
						AP_SKILL_CONDITION_MELEE_ATTACK;
					temp->condition_type |= 
						AP_SKILL_CONDITION_MELEE_ATTACK_EQUIP_ARROW;
					break;
				case 103:
					temp->condition_type |= 
						AP_SKILL_CONDITION_MELEE_ATTACK;
					temp->condition_type |= 
						AP_SKILL_CONDITION_MELEE_ATTACK_EQUIP_SHIELD;
					break;
				case 104:
					temp->condition_type |= 
						AP_SKILL_CONDITION_MELEE_ATTACK;
					temp->condition_type |= 
						AP_SKILL_CONDITION_MELEE_ATTACK_USE_FORMULA1;
					break;
				case 2:
					temp->condition_type |= 
						AP_SKILL_CONDITION_MAGIC_ATTACK;
					break;
				case 201:
					temp->condition_type |= 
						AP_SKILL_CONDITION_MAGIC_ATTACK;
					temp->condition_type |= 
						AP_SKILL_CONDITION_MAGIC_ATTACK_USE_FORMULA1;
					break;
				case 202:
					temp->condition_type |= 
						AP_SKILL_CONDITION_MAGIC_ATTACK;
					temp->condition_type |= 
						AP_SKILL_CONDITION_MAGIC_ATTACK_USE_FORMULA2;
					break;
				case 3:
					temp->condition_type |= 
						AP_SKILL_CONDITION_DEBUFF;
					break;
				case 4:
					temp->condition_type |= 
						AP_SKILL_CONDITION_FRIENDLY_UNIT;
					break;
				case 5:
					temp->condition_type |= 
						AP_SKILL_CONDITION_LEVEL;
					break;
				case 6:
					temp->condition_type |= 
						AP_SKILL_CONDITION_KILL_GUARDIAN;
					break;
				case 7:
					temp->condition_type |= 
						AP_SKILL_CONDITION_CHAR_TYPE;
					break;
				case 8:
					temp->condition_type |= 
						AP_SKILL_CONDITION_OWN_ITEM;
					break;
				case 9:
					temp->condition_type |= 
						AP_SKILL_CONDITION_PARTY_MEMBER;
					break;
				case 901:
					temp->condition_type |= 
						AP_SKILL_CONDITION_PARTY_MEMBER;
					temp->condition_type |= 
						AP_SKILL_CONDITION_SHOUT_WORD;
					break;
				}
				break;
			case SPEC_DCID_OTHER_CONDITION:
				temp->condition2 = num;
				break;
			case SPEC_DCID_ARG1:
				temp->condition_arg.arg1 = num;
				break;
			case SPEC_DCID_ARG2:
				temp->condition_arg.arg2 = num;
				break;
			case SPEC_DCID_ARG3:
				temp->condition_arg.arg3 = num;
				break;
			case SPEC_DCID_ARG4:
				temp->condition_arg.arg4 = num;
				break;
			case SPEC_DCID_ARG_STRING:
				strlcpy(temp->condition_arg.argstr, value,
					sizeof(temp->condition_arg.argstr));
				break;
			default:
				parsed = FALSE;
				break;
			}
			if (parsed)
				continue;
			if (num >= AP_SKILL_EFFECT_PROCESS_INTERVAL_VALUE) {
				interval = TRUE;
				num = num % 
					AP_SKILL_EFFECT_PROCESS_INTERVAL_VALUE;
			}
			switch (id) {
			case SPEC_DCID_MELEE_ATTACK:
				addeffect(temp, 
					AP_SKILL_EFFECT_MELEE_ATTACK_DMG,
					interval);
				switch (num) {
				case 101:
					addeffect(temp, 
						AP_SKILL_EFFECT_MELEE_ATTACK_DMG_TYPE1,
						interval);
					break;
				case 102:
					addeffect(temp, 
						AP_SKILL_EFFECT_MELEE_ATTACK_DMG_TYPE2,
						interval);
					break;
				case 103:
					addeffect(temp, 
						AP_SKILL_EFFECT_MELEE_ATTACK_DMG_TYPE3,
						interval);
					break;
				case 106:
					addeffect(temp, 
						AP_SKILL_EFFECT_MELEE_ATTACK_CRITICAL,
						interval);
					break;
				case 107:
					addeffect(temp, 
						AP_SKILL_EFFECT_MELEE_ATTACK_DEATH,
						interval);
					break;
				case 108:
					addeffect(temp, 
						AP_SKILL_EFFECT_MELEE_ATTACK_DMG_TYPE6,
						interval);
					break;
				case 109:
					addeffect(temp, 
						AP_SKILL_EFFECT_MELEE_ATTACK_DMG_TYPE1,
						interval);
					addeffect(temp, 
						AP_SKILL_EFFECT_MELEE_ATTACK_CRITICAL,
						interval);
					break;
				case 110:
					addeffect(temp, 
						AP_SKILL_EFFECT_MELEE_ATTACK_DMG_TYPE3,
						interval);
					addeffect(temp, 
						AP_SKILL_EFFECT_MELEE_ATTACK_CRITICAL,
						interval);
					break;
				case 111:
					addeffect(temp, 
						AP_SKILL_EFFECT_MELEE_ATTACK_DMG_TYPE1,
						interval);
					addeffect(temp, 
						AP_SKILL_EFFECT_MELEE_ATTACK_DURABILITY,
						interval);
					break;
				case 112:
					addeffect(temp, 
						AP_SKILL_EFFECT_MELEE_ATTACK_HEROIC,
						interval);
					break;
				}
				break;
			case SPEC_DCID_MAGIC_ATTACK: {
				boolean dmgadjust = FALSE;
				addeffect(temp, 
					AP_SKILL_EFFECT_MAGIC_ATTACK_DMG,
					interval);
				if (num >= AP_SKILL_EFFECT_MAGIC_ATTACK_DMG_ADJUST_FLAG) {
					dmgadjust = TRUE;
					num = num % 
						AP_SKILL_EFFECT_MAGIC_ATTACK_DMG_ADJUST_FLAG;
				}
				switch (num) {
				case 109:
					addeffect(temp, 
						AP_SKILL_EFFECT_MAGIC_ATTACK_CRITICAL,
						interval);
					break;
				}
				break;
			}
			case SPEC_DCID_COUNT:
				addeffect(temp, 
					AP_SKILL_EFFECT_COUNT,
					interval);
				break;
			case SPEC_DCID_SPECIAL_STATUS:
				if (num >= 5000) {
					assert(0);
				}
				else {
					if (num >= 1000) {
						temp->special_status_adjust_type = 1;
						num -= 1000;
					}
					if (num) {
						addeffect(temp,
							AP_SKILL_EFFECT_SPECIAL_STATUS,
							interval);
						setspecialstatus(temp, num);
					}
				}
				break;
			case SPEC_DCID_SPECIAL_STATUS_ARG:
				assert(0);
				break;
			case SPEC_DCID_MOVE_POS:
				addeffect2(temp,
					AP_SKILL_EFFECT2_MOVE_POS,
					interval);
				switch(num) {
				case 1:
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_MOVE_POS,
						AP_SKILL_EFFECT_DETAIL_MOVE_POS_TARGET,
						interval);
					break;
				case 2:
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_MOVE_POS,
						AP_SKILL_EFFECT_DETAIL_MOVE_POS_SELF,
						interval);
					break;
				case 3:
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_MOVE_POS,
						AP_SKILL_EFFECT_DETAIL_MOVE_POS_TARGET_TO_ME,
						interval);
					break;
				default:
					break;
				}
				break;
			case SPEC_DCID_UPDATE_FACTOR: {
				boolean updatefor = FALSE;
				addeffect(temp,
					AP_SKILL_EFFECT_UPDATE_FACTOR,
					interval);
				if (num > 110) {
					num = num - 10;
					updatefor = TRUE;
				}
				else if (num < 100) {
					updatefor = TRUE;
				}
				if (updatefor) {
					addeffect(temp,
						AP_SKILL_EFFECT_UPDATE_FACTOR_FOR_A_WHILE,
						interval);
				}
				switch (num) {
				case 105:
					addeffect(temp,
						AP_SKILL_EFFECT_UPDATE_FACTOR_HOT,
						interval);
					break;
				case 106:
					addeffect(temp,
						AP_SKILL_EFFECT_UPDATE_FACTOR_MAGNIFY,
						interval);
					break;
				case 107:
					addeffect(temp,
						AP_SKILL_EFFECT_UPDATE_FACTOR_ITEM,
						interval);
					break;
				case 108:
					addeffect(temp,
						AP_SKILL_EFFECT_UPDATE_FACTOR_TIME,
						interval);
					break;
				case 10:
					break;
				}
				break;
			}
			case SPEC_DCID_REFLECT_MELEE_ATTACK:
				addeffect(temp,
					AP_SKILL_EFFECT_REFLECT_MELEE_ATTACK,
					interval);
				switch (num) {
				case 1:
					addeffect(temp,
						AP_SKILL_EFFECT_REFLECT_RECEIVED_DAMAGE,
						interval);
					break;
				case 2:
					addeffect(temp,
						AP_SKILL_EFFECT_REFLECT_DAMAGE_SHIELD,
						interval);
					break;
				}
				if (num & AP_SKILL_EFFECT_DETAIL_REFLECT_MELEE_ATK_IGNORE_PHYSICAL) {
					addeffectdetail(temp, 
						AP_SKILL_EFFECT_DETAIL_REFLECT_MELEE_ATK,
						AP_SKILL_EFFECT_DETAIL_REFLECT_MELEE_ATK_IGNORE_PHYSICAL,
						interval);
				}
				if(num & AP_SKILL_EFFECT_DETAIL_REFLECT_MELEE_ATK_IGNORE_ATTRIBUTE) {
					addeffectdetail(temp, 
						AP_SKILL_EFFECT_DETAIL_REFLECT_MELEE_ATK,
						AP_SKILL_EFFECT_DETAIL_REFLECT_MELEE_ATK_IGNORE_ATTRIBUTE,
						interval);
				}
				break;
			case SPEC_DCID_REFLECT_MAGIC_ATTACK:
				addeffect(temp,
					AP_SKILL_EFFECT_REFLECT_MAGIC_ATTACK,
					interval);
				switch (num) {
				case 2:
					addeffect(temp,
						AP_SKILL_EFFECT_REFLECT_RECEIVED_DAMAGE,
						interval);
					break;
				}
				break;
			case SPEC_DCID_REFLECT_HEROIC_ATTACK:
				addeffect(temp,
					AP_SKILL_EFFECT_REFLECT_HEROIC_ATTACK,
					interval);
				break;
			case SPEC_DCID_DEFENSE_MELEE_ATTACK:
				addeffect(temp,
					AP_SKILL_EFFECT_DEFENSE_MELEE_ATTACK,
					interval);
				switch (num) {
				case 2:
					addeffect(temp,
						AP_SKILL_EFFECT_DEFENSE_COUNTER_ATTACK,
						interval);
					break;
				case 3:
					addeffect(temp,
						AP_SKILL_EFFECT_DEFENSE_EVADE,
						interval);
					break;
				case 4:
					addeffect(temp,
						AP_SKILL_EFFECT_CRITICAL_DEFENCE_PERCENT,
						interval);
					break;
				}
				break;
			case SPEC_DCID_DEFENSE_MAGIC_ATTACK:
				addeffect(temp,
					AP_SKILL_EFFECT_DEFENSE_MAGIC_ATTACK,
					interval);
				break;
			case SPEC_DCID_MAGIC_RESIST_LEVEL_UP:
				addeffect(temp,
					AP_SKILL_EFFECT_MAGIC_RESIST_LEVEL_UP,
					interval);
				break;
			case SPEC_DCID_DISPEL_MAGIC:
				addeffect(temp,
					AP_SKILL_EFFECT_DISPEL_MAGIC,
					interval);
				switch (num) {
				case 2:
					addeffect(temp,
						AP_SKILL_EFFECT_DISPEL_MAGIC_CURE,
						interval);
					break;
				}
				if (num & AP_SKILL_EFFECT_DETAIL_DISPEL_STUN) {
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_DISPEL,
						AP_SKILL_EFFECT_DETAIL_DISPEL_STUN,
						interval);
				}
				if (num & AP_SKILL_EFFECT_DETAIL_DISPEL_SLOW) {
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_DISPEL,
						AP_SKILL_EFFECT_DETAIL_DISPEL_SLOW,
						interval);
				}
				if (num & AP_SKILL_EFFECT_DETAIL_DISPEL_ALL_BUFF) {
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_DISPEL,
						AP_SKILL_EFFECT_DETAIL_DISPEL_ALL_BUFF,
						interval);
				}
				if (num & AP_SKILL_EFFECT_DETAIL_DISPEL_TRANSPARENT) {
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_DISPEL,
						AP_SKILL_EFFECT_DETAIL_DISPEL_TRANSPARENT,
						interval);
				}
				if (num & AP_SKILL_EFFECT_DETAIL_DISPEL_SPECIAL_STATUS) {
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_DISPEL,
						AP_SKILL_EFFECT_DETAIL_DISPEL_SPECIAL_STATUS,
						interval);
				}
				break;
			case SPEC_DCID_TRANSFORM_TARGET:
				addeffect(temp,
					AP_SKILL_EFFECT_TRANSFORM_TARGET,
					interval);
				switch (num) {
				case 1:
					addeffect(temp,
						AP_SKILL_EFFECT_TRANSFORM_TARGET_TYPE1,
						interval);
					break;
				case 2:
					addeffect(temp,
						AP_SKILL_EFFECT_TRANSFORM_TARGET_TYPE2,
						interval);
					break;
				case 3:
					addeffect(temp,
						AP_SKILL_EFFECT_TRANSFORM_TARGET_TYPE3,
						interval);
					break;
				case 4:
					addeffect(temp,
						AP_SKILL_EFFECT_TRANSFORM_TARGET_TYPE4,
						interval);
					break;
				case 5:
					addeffect(temp,
						AP_SKILL_EFFECT_TRANSFORM_TARGET_TYPE5,
						interval);
					break;
				}
				break;
			case SPEC_DCID_LIFE_PROTECTION:
				addeffect(temp,
					AP_SKILL_EFFECT_LIFE_PROTECTION,
					interval);
				break;
			case SPEC_DCID_DOT:
				addeffect(temp,
					AP_SKILL_EFFECT_DOT_DAMAGE,
					interval);
				switch (num) {
				case 1:
					addeffect(temp,
						AP_SKILL_EFFECT_DOT_DAMAGE_PHYSICAL,
						interval);
					break;
				case 2:
					addeffect(temp,
						AP_SKILL_EFFECT_DOT_DAMAGE_ATTRIBUTE,
						interval);
					break;
				case 3:
					addeffect(temp,
						AP_SKILL_EFFECT_DOT_DAMAGE_HEROIC,
						interval);
					break;
				}
				break;
			case SPEC_DCID_INFECT_AROUND:
				addeffect(temp,
					AP_SKILL_EFFECT_INFECT_AROUND,
					interval);
				break;
			case SPEC_DCID_ADD_SPELLCOUNT:
				addeffect(temp,
					AP_SKILL_EFFECT_ADD_SPELLCOUNT,
					interval);
				switch (num) {
				case 1:
					addeffect(temp,
						AP_SKILL_EFFECT_ADD_SPELLCOUNT_MASTERY_POINT,
						interval);
					break;
				}
				break;
			case SPEC_DCID_DMG_ADJUST:
				addeffect(temp,
					AP_SKILL_EFFECT_DMG_ADJUST,
					interval);
				break;
			case SPEC_DCID_SKILL_FACTOR_ADJUST:
				addeffect(temp,
					AP_SKILL_EFFECT_SKILL_FACTOR_ADJUST,
					interval);
				switch (num) {
				case 1:
					addeffect(temp,
						AP_SKILL_EFFECT_SKILL_FACTOR_ADJUST_COST_HP,
						interval);
					break;
				case 2:
					addeffect(temp,
						AP_SKILL_EFFECT_SKILL_FACTOR_ADJUST_COST_MP,
						interval);
					break;
				case 3:
					addeffect(temp,
						AP_SKILL_EFFECT_SKILL_FACTOR_ADJUST_COST_SP,
						interval);
					break;
				case 4:
					addeffect(temp,
						AP_SKILL_EFFECT_SKILL_FACTOR_ADJUST_RANGE,
						interval);
					break;
				case 5:
					addeffect(temp,
						AP_SKILL_EFFECT_SKILL_FACTOR_ADJUST_CAST_TIME,
						interval);
					break;
				case 6:
					addeffect(temp,
						AP_SKILL_EFFECT_SKILL_FACTOR_ADJUST_DURATION_TIME,
						interval);
					break;
				case 7:
					addeffect(temp,
						AP_SKILL_EFFECT_SKILL_FACTOR_ADJUST_BUFFED_SKILL_DURATION,
						interval);
					break;
				case 8:
					addeffect(temp,
						AP_SKILL_EFFECT_SKILL_FACTOR_ADJUST_MODIFIED_SKILL_DURATION,
						interval);
					break;
				}
				break;
			case SPEC_DCID_UPDATE_COMBAT_POINT:
				addeffect2(temp,
					AP_SKILL_EFFECT2_UPDATE_COMBAT_POINT,
					interval);
				switch (num) {
				case 1:
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_UPDATE_COMBAT_POINT,
						AP_SKILL_EFFECT_DETAIL_UPDATE_COMBAT_POINT_TYPE1,
						interval);
					break;
				case 2:
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_UPDATE_COMBAT_POINT,
						AP_SKILL_EFFECT_DETAIL_UPDATE_COMBAT_POINT_TYPE2,
						interval);
					break;
				case 3:
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_UPDATE_COMBAT_POINT,
						AP_SKILL_EFFECT_DETAIL_UPDATE_COMBAT_POINT_TYPE3,
						interval);
					break;
				}
				break;
			case SPEC_DCID_REGEN_HP:
				switch (num) {
				case 1:
					addeffect2(temp,
						AP_SKILL_EFFECT2_REGEN_HP,
						interval);
					break;
				case 2:
					addeffect2(temp,
						AP_SKILL_EFFECT2_REGEN_MP,
						interval);
					break;
				case 3:
					addeffect2(temp,
						AP_SKILL_EFFECT2_REGEN_HP,
						interval);
					addeffect2(temp,
						AP_SKILL_EFFECT2_REGEN_MP,
						interval);
					break;
				}
				break;
			case SPEC_DCID_CONVERT_TYPE:
				addeffect2(temp,
					AP_SKILL_EFFECT2_CONVERT,
					interval);
				switch (num) {
				case 1:
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_CONVERT,
						AP_SKILL_EFFECT_DETAIL_CONVERT_DAMAGE_TO_HP,
						interval);
					break;
				case 2:
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_CONVERT,
						AP_SKILL_EFFECT_DETAIL_CONVERT_DAMAGE_TO_MP,
						interval);
					break;
				case 3:
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_CONVERT,
						AP_SKILL_EFFECT_DETAIL_CONVERT_MP_TO_HP,
						interval);
					break;
				case 4:
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_CONVERT,
						AP_SKILL_EFFECT_DETAIL_CONVERT_ATK_DAMAGE_TO_HP,
						interval);
					break;
				case 5:
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_CONVERT,
						AP_SKILL_EFFECT_DETAIL_CONVERT_ATK_DAMAGE_TO_MP,
						interval);
					break;
				case 6:
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_CONVERT,
						AP_SKILL_EFFECT_DETAIL_CONVERT_ATK_DAMAGE_TO_HP_INSTANT,
						interval);
					break;
				}
				break;
			case SPEC_DCID_CHARGE:
				addeffect2(temp,
					AP_SKILL_EFFECT2_CHARGE,
					interval);
				break;
			case SPEC_DCID_SKILL_LEVELUP:
				addeffect2(temp,
					AP_SKILL_EFFECT2_SKILL_LEVELUP,
					interval);
				if (num & AP_SKILL_EFFECT_DETAIL_SKILL_LEVELUP_TYPE1) {
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_SKILL_LEVELUP,
						AP_SKILL_EFFECT_DETAIL_SKILL_LEVELUP_TYPE1,
						interval);
				}
				if (num & AP_SKILL_EFFECT_DETAIL_SKILL_LEVELUP_TYPE2) {
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_SKILL_LEVELUP,
						AP_SKILL_EFFECT_DETAIL_SKILL_LEVELUP_TYPE2,
						interval);
				}
				if (num & AP_SKILL_EFFECT_DETAIL_SKILL_LEVELUP_TYPE3) {
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_SKILL_LEVELUP,
						AP_SKILL_EFFECT_DETAIL_SKILL_LEVELUP_TYPE3,
						interval);
				}
				break;
			case SPEC_DCID_PRODUCT:
				addeffect2(temp,
					AP_SKILL_EFFECT2_PRODUCT,
					interval);
				break;
			case SPEC_DCID_TWICE_PACKET:
				temp->is_twice_packet = TRUE;
				addeffect2(temp,
					AP_SKILL_EFFECT2_TWICE_PACKET,
					interval);
				switch (num) {
				case 1:
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_TWICE_PACKET,
						AP_SKILL_EFFECT_DETAIL_TWICE_PACKET_BY_DISTANCE,
						interval);
					break;
				case 2:
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_TWICE_PACKET,
						AP_SKILL_EFFECT_DETAIL_TWICE_PACKET_BY_STATIC_TIME,
						interval);
					break;
				}
				break;
			case SPEC_DCID_AUTO_ATTACK:
				temp->is_auto_attack = TRUE;
				break;
			case SPEC_DCID_DYNAMIC_TARGET:
				addeffect2(temp,
					AP_SKILL_EFFECT2_DYNAMIC_TARGET,
					interval);
				break;
			case SPEC_DCID_ACTION_ON_ACTION:
				addeffect2(temp,
					AP_SKILL_EFFECT2_ACTOIN_ON_ACTION,
					interval);
				switch (num) {
				case 1:
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_ACTION_ON_ACTION,
						AP_SKILL_EFFECT_DETAIL_ACTION_ON_ACTION_TYPE1,
						interval);
					break;
				case 2:
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_ACTION_ON_ACTION,
						AP_SKILL_EFFECT_DETAIL_ACTION_ON_ACTION_TYPE2,
						interval);
					break;
				case 3:
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_ACTION_ON_ACTION,
						AP_SKILL_EFFECT_DETAIL_ACTION_ON_ACTION_TYPE3,
						interval);
					break;
				case 4:
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_ACTION_ON_ACTION,
						AP_SKILL_EFFECT_DETAIL_ACTION_ON_ACTION_TYPE4,
						interval);
					break;
				case 5:
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_ACTION_ON_ACTION,
						AP_SKILL_EFFECT_DETAIL_ACTION_ON_ACTION_TYPE5,
						interval);
					break;
				case 6:
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_ACTION_ON_ACTION,
						AP_SKILL_EFFECT_DETAIL_ACTION_ON_ACTION_TYPE6,
						interval);
					break;
				case 7:
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_ACTION_ON_ACTION,
						AP_SKILL_EFFECT_DETAIL_ACTION_ON_ACTION_TYPE7,
						interval);
					break;
				case 8:
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_ACTION_ON_ACTION,
						AP_SKILL_EFFECT_DETAIL_ACTION_ON_ACTION_TYPE8,
						interval);
					break;
				}
				break;
			case SPEC_DCID_AT_FIELD:
				addeffect2(temp,
					AP_SKILL_EFFECT2_AT_FIELD,
					interval);
				switch (num) {
				case 1:
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_AT_FIELD,
						AP_SKILL_EFFECT_DETAIL_AT_FIELD_ATTACK,
						interval);
					break;
				case 2:
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_AT_FIELD,
						AP_SKILL_EFFECT_DETAIL_AT_FIELD_ATTACK2,
						interval);
					break;
				case 3:
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_AT_FIELD,
						AP_SKILL_EFFECT_DETAIL_AT_FIELD_AURA,
						interval);
					break;
				}
				break;
			case SPEC_DCID_SUMMONS:
				addeffect2(temp,
					AP_SKILL_EFFECT2_SUMMONS,
					interval);
				switch (num) {
				case 1:
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_SUMMONS,
						AP_SKILL_EFFECT_DETAIL_SUMMONS_TYPE1,
						interval);
					break;
				case 2:
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_SUMMONS,
						AP_SKILL_EFFECT_DETAIL_SUMMONS_TYPE2,
						interval);
					break;
				case 3:
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_SUMMONS,
						AP_SKILL_EFFECT_DETAIL_SUMMONS_TYPE3,
						interval);
					break;
				case 4:
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_SUMMONS,
						AP_SKILL_EFFECT_DETAIL_SUMMONS_TYPE4,
						interval);
					break;
				case 5:
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_SUMMONS,
						AP_SKILL_EFFECT_DETAIL_SUMMONS_TYPE5,
						interval);
					break;
				case 6:
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_SUMMONS,
						AP_SKILL_EFFECT_DETAIL_SUMMONS_TYPE6,
						interval);
					break;
				case 7:
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_SUMMONS,
						AP_SKILL_EFFECT_DETAIL_SUMMONS_TYPE7,
						interval);
					break;
				case 8:
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_SUMMONS,
						AP_SKILL_EFFECT_DETAIL_SUMMONS_TYPE8,
						interval);
					break;
				case 9: {
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_SUMMONS,
						AP_SKILL_EFFECT_DETAIL_SUMMONS_TYPE4,
						interval);
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_SUMMONS,
						AP_SKILL_EFFECT_DETAIL_SUMMONS_TYPE7,
						interval);
					break;
				}
				case 10:
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_SUMMONS,
						AP_SKILL_EFFECT_DETAIL_SUMMONS_TYPE10,
						interval);
					break;
				}
				break;
			case SPEC_DCID_ACTION_PASSIVE:
				addeffect2(temp,
					AP_SKILL_EFFECT2_ACTION_PASSIVE,
					interval);
				break;
			case SPEC_DCID_DURATION_TYPE:
				addeffect2(temp,
					AP_SKILL_EFFECT2_DURATION_TYPE,
					interval);
				switch (num) {
				case 1:
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_DURATION_TYPE,
						AP_SKILL_EFFECT_DETAIL_DURATION_TYPE1,
						interval);
					break;
				case 2:
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_DURATION_TYPE,
						AP_SKILL_EFFECT_DETAIL_DURATION_TYPE2,
						interval);
					break;
				}
				break;
			case SPEC_DCID_LIMITED_MAX_LEVEL:
				if (num > 0 && num <= AP_SKILL_MAX_UPGRADE_SP)
					temp->limited_max_level = num;
				break;
			case SPEC_DCID_RELEASE_TARGET:
				addeffect2(temp,
					AP_SKILL_EFFECT2_RELEASE_TARGET,
					interval);
				break;
			case SPEC_DCID_VISIBLE_EFFECT_TYPE:
				addeffect2(temp,
					AP_SKILL_EFFECT2_VISIBLE_EFFECT_TYPE,
					interval);
				break;
			case SPEC_DCID_GAME_BONUS:
				if (num != 0) {
					addeffect2(temp,
						AP_SKILL_EFFECT2_GAME_BONUS,
						interval);
				}
				if (num & AP_SKILL_EFFECT_DETAIL_GAME_BONUS_EXP) {
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_GAME_BONUS,
						AP_SKILL_EFFECT_DETAIL_GAME_BONUS_EXP,
						interval);
				}
				if (num & AP_SKILL_EFFECT_DETAIL_GAME_BONUS_MONEY) {
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_GAME_BONUS,
						AP_SKILL_EFFECT_DETAIL_GAME_BONUS_MONEY,
						interval);
				}
				if (num & AP_SKILL_EFFECT_DETAIL_GAME_BONUS_DROP_RATE) {
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_GAME_BONUS,
						AP_SKILL_EFFECT_DETAIL_GAME_BONUS_DROP_RATE,
						interval);
				}
				if (num & AP_SKILL_EFFECT_DETAIL_GAME_BONUS_DROP_RATE2) {
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_GAME_BONUS,
						AP_SKILL_EFFECT_DETAIL_GAME_BONUS_DROP_RATE2,
						interval);
				}
				if (num & AP_SKILL_EFFECT_DETAIL_GAME_BONUS_CHARISMA_RATE) {
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_GAME_BONUS,
						AP_SKILL_EFFECT_DETAIL_GAME_BONUS_CHARISMA_RATE,
						interval);
				}
				break;
			case SPEC_DCID_ITEM_USE_TYPE:
				addeffect2(temp,
					AP_SKILL_EFFECT2_ITEM_USE_TYPE,
					interval);
				break;
			case SPEC_DCID_CASH:
				addeffect2(temp,
					AP_SKILL_EFFECT2_CASH,
					interval);
				break;
			case SPEC_DCID_LEVEL_DIFF_TYPE:
				addeffect2(temp,
					AP_SKILL_EFFECT2_LEVEL_DIFF_TYPE,
					interval);
				break;
			case SPEC_DCID_DETECT:
				addeffect2(temp,
					AP_SKILL_EFFECT2_DETECT,
					interval);
				if (num & AP_SKILL_EFFECT_DETAIL_DETECT_TYPE1) {
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_DETECT,
						AP_SKILL_EFFECT_DETAIL_DETECT_TYPE1,
						interval);
				}
				if (num & AP_SKILL_EFFECT_DETAIL_DETECT_TYPE2) {
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_DETECT,
						AP_SKILL_EFFECT_DETAIL_DETECT_TYPE2,
						interval);
				}
				break;
			case SPEC_DCID_RIDE:
				addeffect2(temp,
					AP_SKILL_EFFECT2_RIDE,
					interval);
				break;
			case SPEC_DCID_GAME_EFFECT:
				if (num != 0) {
					addeffect2(temp,
						AP_SKILL_EFFECT2_GAME_EFFECT,
						interval);
				}
				if (num & AP_SKILL_EFFECT_DETAIL_GAME_EFFECT_DAY_NIGHT) {
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_GAME_EFFECT,
						AP_SKILL_EFFECT_DETAIL_GAME_EFFECT_DAY_NIGHT,
						interval);
				}
				if (num & AP_SKILL_EFFECT_DETAIL_GAME_EFFECT_RAIN) {
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_GAME_EFFECT,
						AP_SKILL_EFFECT_DETAIL_GAME_EFFECT_RAIN,
						interval);
				}
				if (num & AP_SKILL_EFFECT_DETAIL_GAME_EFFECT_SNOW) {
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_GAME_EFFECT,
						AP_SKILL_EFFECT_DETAIL_GAME_EFFECT_SNOW,
						interval);
				}
				break;
			case SPEC_DCID_FORCE:
				addeffect2(temp,
					AP_SKILL_EFFECT2_FORCE,
					interval);
				if (num & AP_SKILL_EFFECT_DETAIL_FORCE_SUMMON_LIMIT) {
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_FORCE,
						AP_SKILL_EFFECT_DETAIL_FORCE_SUMMON_LIMIT,
						interval);
				}
				if (num & AP_SKILL_EFFECT_DETAIL_FORCE_WITHOUT_TARGET) {
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_FORCE,
						AP_SKILL_EFFECT_DETAIL_FORCE_WITHOUT_TARGET,
						interval);
				}
				if (num & AP_SKILL_EFFECT_DETAIL_FORCE_INVISIBLE_COMBAT) {
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_FORCE,
						AP_SKILL_EFFECT_DETAIL_FORCE_INVISIBLE_COMBAT,
						interval);
				}
				break;
			case SPEC_DCID_DIVIDE:
				addeffect2(temp,
					AP_SKILL_EFFECT2_DIVIDE,
					interval);
				if (num & AP_SKILL_EFFECT_DETAIL_DIVIDE_ATTR) {
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_DIVIDE,
						AP_SKILL_EFFECT_DETAIL_DIVIDE_ATTR,
						interval);
				}
				if (num & AP_SKILL_EFFECT_DETAIL_DIVIDE_NORMAL) {
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_DIVIDE,
						AP_SKILL_EFFECT_DETAIL_DIVIDE_NORMAL,
						interval);
				}
				break;
			case SPEC_DCID_RESURRECTION:
				addeffect2(temp,
					AP_SKILL_EFFECT2_RESURRECTION,
					interval);
				break;
			case SPEC_DCID_SKILL_UNION:
				addeffect2(temp,
					AP_SKILL_EFFECT2_SKILL_UNION,
					interval);
				if (num & AP_SKILL_EFFECT_DETAIL_SKILL_UNION_TYPE1) {
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_SKILL_UNION,
						AP_SKILL_EFFECT_DETAIL_SKILL_UNION_TYPE1,
						interval);
				}
				if (num & AP_SKILL_EFFECT_DETAIL_SKILL_UNION_TYPE2) {
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_SKILL_UNION,
						AP_SKILL_EFFECT_DETAIL_SKILL_UNION_TYPE2,
						interval);
				}
				break;
			case SPEC_DCID_TARGET_RESTRICTION:
				addeffect2(temp,
					AP_SKILL_EFFECT2_TARGET_RESTRICTION,
					interval);
				if (num & AP_SKILL_EFFECT_DETAIL_TARGET_RESTRICTION_SIEGE_OBJECT) {
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_TARGET_RESTRICTION,
						AP_SKILL_EFFECT_DETAIL_TARGET_RESTRICTION_SIEGE_OBJECT,
						interval);
				}
				if (num & AP_SKILL_EFFECT_DETAIL_TARGET_RESTRICTION_MONSTER) {
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_TARGET_RESTRICTION,
						AP_SKILL_EFFECT_DETAIL_TARGET_RESTRICTION_MONSTER,
						interval);
				}
				if (num & AP_SKILL_EFFECT_DETAIL_TARGET_RESTRICTION_ENEMY_PC) {
					addeffectdetail(temp,
						AP_SKILL_EFFECT_DETAIL_TARGET_RESTRICTION,
						AP_SKILL_EFFECT_DETAIL_TARGET_RESTRICTION_ENEMY_PC,
						interval);
				}
				break;
			case SPEC_DCID_DISTURB:
				if (num > 1000) {
					addeffect2(temp,
						AP_SKILL_EFFECT2_TOLERANCE_DISTURB_CHARACTER_ACTION,
						interval);
					num = num - 1000;
					if (num & AP_SKILL_EFFECT_DETAIL_DISTURB_CHARACTER_ACTION_ATTACK) {
						addeffectdetail(temp,
							AP_SKILL_EFFECT_DETAIL_TOLERANCE_DISTURB_CHARACTER_ACTION,
							AP_SKILL_EFFECT_DETAIL_DISTURB_CHARACTER_ACTION_ATTACK,
							interval);
					}
					if (num & AP_SKILL_EFFECT_DETAIL_DISTURB_CHARACTER_ACTION_MOVE) {
						addeffectdetail(temp,
							AP_SKILL_EFFECT_DETAIL_TOLERANCE_DISTURB_CHARACTER_ACTION,
							AP_SKILL_EFFECT_DETAIL_DISTURB_CHARACTER_ACTION_MOVE,
							interval);
					}
					if (num & AP_SKILL_EFFECT_DETAIL_DISTURB_CHARACTER_ACTION_USE_ITEM) {
						addeffectdetail(temp,
							AP_SKILL_EFFECT_DETAIL_TOLERANCE_DISTURB_CHARACTER_ACTION,
							AP_SKILL_EFFECT_DETAIL_DISTURB_CHARACTER_ACTION_USE_ITEM,
							interval);
					}
					if (num & AP_SKILL_EFFECT_DETAIL_DISTURB_CHARACTER_ACTION_SKILL) {
						addeffectdetail(temp,
							AP_SKILL_EFFECT_DETAIL_TOLERANCE_DISTURB_CHARACTER_ACTION,
							AP_SKILL_EFFECT_DETAIL_DISTURB_CHARACTER_ACTION_SKILL,
							interval);
					}
				}
				else {
					addeffect2(temp,
						AP_SKILL_EFFECT2_DISTURB_CHARACTER_ACTION,
						interval);
					if (num & AP_SKILL_EFFECT_DETAIL_DISTURB_CHARACTER_ACTION_ATTACK) {
						addeffectdetail(temp,
							AP_SKILL_EFFECT_DETAIL_DISTURB_CHARACTER_ACTION,
							AP_SKILL_EFFECT_DETAIL_DISTURB_CHARACTER_ACTION_ATTACK,
							interval);
					}
					if (num & AP_SKILL_EFFECT_DETAIL_DISTURB_CHARACTER_ACTION_MOVE) {
						addeffectdetail(temp,
							AP_SKILL_EFFECT_DETAIL_DISTURB_CHARACTER_ACTION,
							AP_SKILL_EFFECT_DETAIL_DISTURB_CHARACTER_ACTION_MOVE,
							interval);
					}
					if (num & AP_SKILL_EFFECT_DETAIL_DISTURB_CHARACTER_ACTION_USE_ITEM) {
						addeffectdetail(temp,
							AP_SKILL_EFFECT_DETAIL_DISTURB_CHARACTER_ACTION,
							AP_SKILL_EFFECT_DETAIL_DISTURB_CHARACTER_ACTION_USE_ITEM,
							interval);
					}
					if (num & AP_SKILL_EFFECT_DETAIL_DISTURB_CHARACTER_ACTION_SKILL) {
						addeffectdetail(temp,
							AP_SKILL_EFFECT_DETAIL_DISTURB_CHARACTER_ACTION,
							AP_SKILL_EFFECT_DETAIL_DISTURB_CHARACTER_ACTION_SKILL,
							interval);
					}
				}
				break;
			case SPEC_DCID_DOWNTIME_ID:
				break;
			case SPEC_DCID_DOWNTIME_DURATION:
				break;
			case SPEC_DCID_APPLIED_COOLDOWN_CAP:
				break;
			default:
				ERROR("Invalid column id (%u).", id);
				au_table_destroy(table);
				return FALSE;
			}
		}
	}
	au_table_destroy(table);
	return TRUE;
}

boolean ap_skill_read_const(
	struct ap_skill_module * mod,
	const char * file_path, 
	boolean decrypt)
{
	struct au_table * table = au_table_open(file_path, decrypt);
	boolean r = TRUE;
	struct ap_skill_template * temp = NULL;
	uint32_t count = 0;
	if (!table) {
		ERROR("Failed to open file (%s).", file_path);
		return FALSE;
	}
	r &= au_table_set_column(table,
		"name", 
		CONST_DCID_NAME);
	r &= au_table_set_column(table,
		"skill_level", 
		CONST_DCID_SKILL_LEVEL);
	r &= au_table_set_column(table,
		"skill_type", 
		CONST_DCID_SKILL_TYPE);
	r &= au_table_set_column(table,
		"skill_type2", 
		CONST_DCID_SKILL_TYPE2);
	r &= au_table_set_column(table,
		"buff_type", 
		CONST_DCID_BUFF_TYPE);
	r &= au_table_set_column(table,
		"require_class_knight", 
		CONST_DCID_REQUIRE_CLASS_KNIGHT);
	r &= au_table_set_column(table,
		"require_class_archer", 
		CONST_DCID_REQUIRE_CLASS_ARCHER);
	r &= au_table_set_column(table,
		"require_class_wizard", 
		CONST_DCID_REQUIRE_CLASS_WIZARD);
	r &= au_table_set_column(table,
		"require_class_berserker", 
		CONST_DCID_REQUIRE_CLASS_BERSERKER);
	r &= au_table_set_column(table,
		"require_class_hunter", 
		CONST_DCID_REQUIRE_CLASS_HUNTER);
	r &= au_table_set_column(table,
		"require_class_sorcerer", 
		CONST_DCID_REQUIRE_CLASS_SORCERER);
	r &= au_table_set_column(table,
		"require_class_swashbuckler", 
		CONST_DCID_REQUIRE_CLASS_SWASHBUCKLER);
	r &= au_table_set_column(table,
		"require_class_ranger", 
		CONST_DCID_REQUIRE_CLASS_RANGER);
	r &= au_table_set_column(table,
		"require_class_elementaler", 
		CONST_DCID_REQUIRE_CLASS_ELEMENTALER);
	r &= au_table_set_column(table,
		"require_class_slayer", 
		CONST_DCID_REQUIRE_CLASS_SLAYER);
	r &= au_table_set_column(table,
		"require_class_obiter", 
		CONST_DCID_REQUIRE_CLASS_OBITER);
	r &= au_table_set_column(table,
		"require_class_summoner", 
		CONST_DCID_REQUIRE_CLASS_SUMMONER);
	r &= au_table_set_column(table,
		"require_class_scion", 
		CONST_DCID_REQUIRE_CLASS_SCION);
	r &= au_table_set_column(table,
		"require_level", 
		CONST_DCID_REQUIRE_LEVEL);
	r &= au_table_set_column(table,
		"require_point", 
		CONST_DCID_REQUIRE_POINT);
	r &= au_table_set_column(table,
		"require_heroic_point", 
		CONST_DCID_REQUIRE_HEROIC_POINT);
	r &= au_table_set_column(table,
		"require_charisma_point", 
		CONST_DCID_REQUIRE_CHARISMA_POINT);
	r &= au_table_set_column(table,
		"damage_a", 
		CONST_DCID_DAMAGE_A);
	r &= au_table_set_column(table,
		"damage_magic", 
		CONST_DCID_DAMAGE_MAGIC);
	r &= au_table_set_column(table,
		"damage_water", 
		CONST_DCID_DAMAGE_WATER);
	r &= au_table_set_column(table,
		"damage_air", 
		CONST_DCID_DAMAGE_AIR);
	r &= au_table_set_column(table,
		"damage_earth", 
		CONST_DCID_DAMAGE_EARTH);
	r &= au_table_set_column(table,
		"damage_fire", 
		CONST_DCID_DAMAGE_FIRE);
	r &= au_table_set_column(table,
		"damage_poison", 
		CONST_DCID_DAMAGE_POISON);
	r &= au_table_set_column(table,
		"damage_ice", 
		CONST_DCID_DAMAGE_ICE);
	r &= au_table_set_column(table,
		"damage_thunder", 
		CONST_DCID_DAMAGE_THUNDER);
	r &= au_table_set_column(table,
		"dmg_heroic", 
		CONST_DCID_DMG_HEROIC);
	r &= au_table_set_column(table,
		"damage_c", 
		CONST_DCID_DAMAGE_C);
	r &= au_table_set_column(table,
		"damage_a_PERCENT", 
		CONST_DCID_DAMAGE_A_PERCENT);
	r &= au_table_set_column(table,
		"damage_magic_PERCENT", 
		CONST_DCID_DAMAGE_MAGIC_PERCENT);
	r &= au_table_set_column(table,
		"damage_water_PERCENT", 
		CONST_DCID_DAMAGE_WATER_PERCENT);
	r &= au_table_set_column(table,
		"damage_air_PERCENT", 
		CONST_DCID_DAMAGE_AIR_PERCENT);
	r &= au_table_set_column(table,
		"damage_earth_PERCENT", 
		CONST_DCID_DAMAGE_EARTH_PERCENT);
	r &= au_table_set_column(table,
		"damage_fire_PERCENT", 
		CONST_DCID_DAMAGE_FIRE_PERCENT);
	r &= au_table_set_column(table,
		"damage_poison_PERCENT", 
		CONST_DCID_DAMAGE_POISON_PERCENT);
	r &= au_table_set_column(table,
		"damage_ice_PERCENT", 
		CONST_DCID_DAMAGE_ICE_PERCENT);
	r &= au_table_set_column(table,
		"damage_thunder_PERCENT", 
		CONST_DCID_DAMAGE_THUNDER_PERCENT);
	r &= au_table_set_column(table,
		"dmg_heroic_percent", 
		CONST_DCID_DMG_HEROIC_PERCENT);
	r &= au_table_set_column(table,
		"damage_c_PERCENT", 
		CONST_DCID_DAMAGE_C_PERCENT);
	r &= au_table_set_column(table,
		"resist_a", 
		CONST_DCID_RESIST_A);
	r &= au_table_set_column(table,
		"cost_hp", 
		CONST_DCID_COST_HP);
	r &= au_table_set_column(table,
		"cost_mp", 
		CONST_DCID_COST_MP);
	r &= au_table_set_column(table,
		"cost_sp", 
		CONST_DCID_COST_SP);
	r &= au_table_set_column(table,
		"cost_arrow", 
		CONST_DCID_COST_ARROW);
	r &= au_table_set_column(table,
		"endskill_cost_hp", 
		CONST_DCID_ENDSKILL_COST_HP);
	r &= au_table_set_column(table,
		"cast_time", 
		CONST_DCID_CAST_TIME);
	r &= au_table_set_column(table,
		"recast_time", 
		CONST_DCID_RECAST_TIME);
	r &= au_table_set_column(table,
		"semi_recast_time", 
		CONST_DCID_SEMI_RECAST_TIME);
	r &= au_table_set_column(table,
		"duration", 
		CONST_DCID_DURATION);
	r &= au_table_set_column(table,
		"interval", 
		CONST_DCID_INTERVAL);
	r &= au_table_set_column(table,
		"show damage", 
		CONST_DCID_SHOW_DAMAGE);
	r &= au_table_set_column(table,
		"range", 
		CONST_DCID_RANGE);
	r &= au_table_set_column(table,
		"area_r", 
		CONST_DCID_AREA_R);
	r &= au_table_set_column(table,
		"area_f1", 
		CONST_DCID_AREA_F1);
	r &= au_table_set_column(table,
		"area_f2", 
		CONST_DCID_AREA_F2);
	r &= au_table_set_column(table,
		"dot_dmg_a", 
		CONST_DCID_DOT_DMG_A);
	r &= au_table_set_column(table,
		"dot_dmg_magic", 
		CONST_DCID_DOT_DMG_MAGIC);
	r &= au_table_set_column(table,
		"dot_dmg_water", 
		CONST_DCID_DOT_DMG_WATER);
	r &= au_table_set_column(table,
		"dot_dmg_air", 
		CONST_DCID_DOT_DMG_AIR);
	r &= au_table_set_column(table,
		"dot_dmg_earth", 
		CONST_DCID_DOT_DMG_EARTH);
	r &= au_table_set_column(table,
		"dot_dmg_fire", 
		CONST_DCID_DOT_DMG_FIRE);
	r &= au_table_set_column(table,
		"dot_dmg_poison", 
		CONST_DCID_DOT_DMG_POISON);
	r &= au_table_set_column(table,
		"dot_dmg_ice", 
		CONST_DCID_DOT_DMG_ICE);
	r &= au_table_set_column(table,
		"dot_dmg_thunder", 
		CONST_DCID_DOT_DMG_THUNDER);
	r &= au_table_set_column(table,
		"dot_dmg_heroic", 
		CONST_DCID_DOT_DMG_HEROIC);
	r &= au_table_set_column(table,
		"dot_dmg_a_PERCENT", 
		CONST_DCID_DOT_DMG_A_PERCENT);
	r &= au_table_set_column(table,
		"dot_dmg_magic_PERCENT", 
		CONST_DCID_DOT_DMG_MAGIC_PERCENT);
	r &= au_table_set_column(table,
		"dot_dmg_water_PERCENT", 
		CONST_DCID_DOT_DMG_WATER_PERCENT);
	r &= au_table_set_column(table,
		"dot_dmg_air_PERCENT", 
		CONST_DCID_DOT_DMG_AIR_PERCENT);
	r &= au_table_set_column(table,
		"dot_dmg_earth_PERCENT", 
		CONST_DCID_DOT_DMG_EARTH_PERCENT);
	r &= au_table_set_column(table,
		"dot_dmg_fire_PERCENT", 
		CONST_DCID_DOT_DMG_FIRE_PERCENT);
	r &= au_table_set_column(table,
		"dot_dmg_poison_PERCENT", 
		CONST_DCID_DOT_DMG_POISON_PERCENT);
	r &= au_table_set_column(table,
		"dot_dmg_ice_PERCENT", 
		CONST_DCID_DOT_DMG_ICE_PERCENT);
	r &= au_table_set_column(table,
		"dot_dmg_thunder_PERCENT", 
		CONST_DCID_DOT_DMG_THUNDER_PERCENT);
	r &= au_table_set_column(table,
		"move_distance", 
		CONST_DCID_MOVE_DISTANCE);
	r &= au_table_set_column(table,
		"reflect_max", 
		CONST_DCID_REFLECT_MAX);
	r &= au_table_set_column(table,
		"heroic_reflect_max", 
		CONST_DCID_HEROIC_REFLECT_MAX);
	r &= au_table_set_column(table,
		"defense_max", 
		CONST_DCID_DEFENSE_MAX);
	r &= au_table_set_column(table,
		"reflect_con", 
		CONST_DCID_REFLECT_CON);
	r &= au_table_set_column(table,
		"defense_con", 
		CONST_DCID_DEFENSE_CON);
	r &= au_table_set_column(table,
		"damage_shield", 
		CONST_DCID_DAMAGE_SHIELD);
	r &= au_table_set_column(table,
		"counter_up", 
		CONST_DCID_COUNTER_UP);
	r &= au_table_set_column(table,
		"counter_reduce", 
		CONST_DCID_COUNTER_REDUCE);
	r &= au_table_set_column(table,
		"hot", 
		CONST_DCID_HOT);
	r &= au_table_set_column(table,
		"dmg_adjust", 
		CONST_DCID_DMG_ADJUST);
	r &= au_table_set_column(table,
		"dmg_show_divide", 
		CONST_DCID_DMG_SHOW_DIVIDE);
	r &= au_table_set_column(table,
		"hp_recovery", 
		CONST_DCID_HP_RECOVERY);
	r &= au_table_set_column(table,
		"mp_recovery", 
		CONST_DCID_MP_RECOVERY);
	r &= au_table_set_column(table,
		"sp_recovery", 
		CONST_DCID_SP_RECOVERY);
	r &= au_table_set_column(table,
		"warrior_lev", 
		CONST_DCID_WARRIOR_LEV);
	r &= au_table_set_column(table,
		"change_monster", 
		CONST_DCID_CHANGE_MONSTER);
	r &= au_table_set_column(table,
		"block_point", 
		CONST_DCID_BLOCK_POINT);
	r &= au_table_set_column(table,
		"stun_time", 
		CONST_DCID_STUN_TIME);
	r &= au_table_set_column(table,
		"stun_generate_time", 
		CONST_DCID_STUN_GENERATE_TIME);
	r &= au_table_set_column(table,
		"critical", 
		CONST_DCID_CRITICAL);
	r &= au_table_set_column(table,
		"skill_range", 
		CONST_DCID_SKILL_RANGE);
	r &= au_table_set_column(table,
		"skill_rate", 
		CONST_DCID_SKILL_RATE);
	r &= au_table_set_column(table,
		"special_status_rate", 
		CONST_DCID_SPECIAL_STATUS_RATE);
	r &= au_table_set_column(table,
		"damage_convert_hp", 
		CONST_DCID_DAMAGE_CONVERT_HP);
	r &= au_table_set_column(table,
		"damage_convert_mp", 
		CONST_DCID_DAMAGE_CONVERT_MP);
	r &= au_table_set_column(table,
		"regen_hp", 
		CONST_DCID_REGEN_HP);
	r &= au_table_set_column(table,
		"regen_mp", 
		CONST_DCID_REGEN_MP);
	r &= au_table_set_column(table,
		"charge_1", 
		CONST_DCID_CHARGE_1);
	r &= au_table_set_column(table,
		"charge_2", 
		CONST_DCID_CHARGE_2);
	r &= au_table_set_column(table,
		"charge_3", 
		CONST_DCID_CHARGE_3);
	r &= au_table_set_column(table,
		"aggrodoll_hp", 
		CONST_DCID_AGGRODOLL_HP);
	r &= au_table_set_column(table,
		"dot_damage_time", 
		CONST_DCID_DOT_DAMAGE_TIME);
	r &= au_table_set_column(table,
		"cost_mp_decrease", 
		CONST_DCID_COST_MP_DECREASE);
	r &= au_table_set_column(table,
		"cast_time_decrease", 
		CONST_DCID_CAST_TIME_DECREASE);
	r &= au_table_set_column(table,
		"skill_levelup", 
		CONST_DCID_SKILL_LEVELUP);
	r &= au_table_set_column(table,
		"mp_convert_hp", 
		CONST_DCID_MP_CONVERT_HP);
	r &= au_table_set_column(table,
		"death", 
		CONST_DCID_DEATH);
	r &= au_table_set_column(table,
		"time_control", 
		CONST_DCID_TIME_CONTROL);
	r &= au_table_set_column(table,
		"item_parts", 
		CONST_DCID_ITEM_PARTS);
	r &= au_table_set_column(table,
		"skill_cost", 
		CONST_DCID_SKILL_COST);
	r &= au_table_set_column(table,
		"skill_upgrade_cost", 
		CONST_DCID_SKILL_UPGRADE_COST);
	r &= au_table_set_column(table,
		"skill_classify_id", 
		CONST_DCID_SKILL_CLASSIFY_ID);
	r &= au_table_set_column(table,
		"skill_classify_level", 
		CONST_DCID_SKILL_CLASSIFY_LEVEL);
	r &= au_table_set_column(table,
		"velocity", 
		CONST_DCID_VELOCITY);
	r &= au_table_set_column(table,
		"summons_tid", 
		CONST_DCID_SUMMONS_TID);
	r &= au_table_set_column(table,
		"creature_tid", 
		CONST_DCID_CREATURE_TID);
	r &= au_table_set_column(table,
		"additional_skilltid", 
		CONST_DCID_ADDITIONAL_SKILLTID);
	r &= au_table_set_column(table,
		"additional_duration", 
		CONST_DCID_ADDITIONAL_DURATION);
	r &= au_table_set_column(table,
		"max_target_num", 
		CONST_DCID_MAX_TARGET_NUM);
	r &= au_table_set_column(table,
		"limit_quantity", 
		CONST_DCID_LIMIT_QUANTITY);
	r &= au_table_set_column(table,
		"summons_count", 
		CONST_DCID_SUMMONS_COUNT);
	r &= au_table_set_column(table,
		"bonus_exp", 
		CONST_DCID_BONUS_EXP);
	r &= au_table_set_column(table,
		"bonus_money", 
		CONST_DCID_BONUS_MONEY);
	r &= au_table_set_column(table,
		"bonus_drop_rate", 
		CONST_DCID_BONUS_DROP_RATE);
	r &= au_table_set_column(table,
		"bonus_charisma_add_rate", 
		CONST_DCID_BONUS_CHARISMA_ADD_RATE);
	r &= au_table_set_column(table,
		"level_diff", 
		CONST_DCID_LEVEL_DIFF);
	r &= au_table_set_column(table,
		"divide_rate", 
		CONST_DCID_DIVIDE_RATE);
	r &= au_table_set_column(table,
		"ea_damage_physical", 
		CONST_DCID_EA_DAMAGE_PHYSICAL);
	r &= au_table_set_column(table,
		"ea_damage_magic", 
		CONST_DCID_EA_DAMAGE_MAGIC);
	r &= au_table_set_column(table,
		"ea_damage_water", 
		CONST_DCID_EA_DAMAGE_WATER);
	r &= au_table_set_column(table,
		"ea_damage_air", 
		CONST_DCID_EA_DAMAGE_AIR);
	r &= au_table_set_column(table,
		"ea_damage_earth", 
		CONST_DCID_EA_DAMAGE_EARTH);
	r &= au_table_set_column(table,
		"ea_damage_fire", 
		CONST_DCID_EA_DAMAGE_FIRE);
	r &= au_table_set_column(table,
		"ea_damage_poison", 
		CONST_DCID_EA_DAMAGE_POISON);
	r &= au_table_set_column(table,
		"ea_damage_ice", 
		CONST_DCID_EA_DAMAGE_ICE);
	r &= au_table_set_column(table,
		"ea_damage_thunder", 
		CONST_DCID_EA_DAMAGE_THUNDER);
	r &= au_table_set_column(table,
		"ea_damage_c", 
		CONST_DCID_EA_DAMAGE_C);
	r &= au_table_set_column(table,
		"ea_damage_physical_PERCENT", 
		CONST_DCID_EA_DAMAGE_PHYSICAL_PERCENT);
	r &= au_table_set_column(table,
		"ea_damage_magic_PERCENT", 
		CONST_DCID_EA_DAMAGE_MAGIC_PERCENT);
	r &= au_table_set_column(table,
		"ea_damage_water_PERCENT", 
		CONST_DCID_EA_DAMAGE_WATER_PERCENT);
	r &= au_table_set_column(table,
		"ea_damage_air_PERCENT", 
		CONST_DCID_EA_DAMAGE_AIR_PERCENT);
	r &= au_table_set_column(table,
		"ea_damage_earth_PERCENT", 
		CONST_DCID_EA_DAMAGE_EARTH_PERCENT);
	r &= au_table_set_column(table,
		"ea_damage_fire_PERCENT", 
		CONST_DCID_EA_DAMAGE_FIRE_PERCENT);
	r &= au_table_set_column(table,
		"ea_damage_poison_PERCENT", 
		CONST_DCID_EA_DAMAGE_POISON_PERCENT);
	r &= au_table_set_column(table,
		"ea_damage_ice_PERCENT", 
		CONST_DCID_EA_DAMAGE_ICE_PERCENT);
	r &= au_table_set_column(table,
		"ea_damage_thunder_PERCENT", 
		CONST_DCID_EA_DAMAGE_THUNDER_PERCENT);
	r &= au_table_set_column(table,
		"ea_damage_c_PERCENT", 
		CONST_DCID_EA_DAMAGE_C_PERCENT);
	r &= au_table_set_column(table,
		"FACTOR_POINT", 
		CONST_DCID_FACTOR_POINT);
	r &= au_table_set_column(table,
		"con", 
		CONST_DCID_CON);
	r &= au_table_set_column(table,
		"str", 
		CONST_DCID_STR);
	r &= au_table_set_column(table,
		"int", 
		CONST_DCID_INT);
	r &= au_table_set_column(table,
		"dex", 
		CONST_DCID_DEX);
	r &= au_table_set_column(table,
		"cha", 
		CONST_DCID_CHA);
	r &= au_table_set_column(table,
		"wis", 
		CONST_DCID_WIS);
	r &= au_table_set_column(table,
		"movement", 
		CONST_DCID_MOVEMENT);
	r &= au_table_set_column(table,
		"hp", 
		CONST_DCID_HP);
	r &= au_table_set_column(table,
		"mp", 
		CONST_DCID_MP);
	r &= au_table_set_column(table,
		"sp", 
		CONST_DCID_SP);
	r &= au_table_set_column(table,
		"ap", 
		CONST_DCID_AP);
	r &= au_table_set_column(table,
		"agro", 
		CONST_DCID_AGRO);
	r &= au_table_set_column(table,
		"max_hp", 
		CONST_DCID_MAX_HP);
	r &= au_table_set_column(table,
		"max_mp", 
		CONST_DCID_MAX_MP);
	r &= au_table_set_column(table,
		"max_sp", 
		CONST_DCID_MAX_SP);
	r &= au_table_set_column(table,
		"atk_speed", 
		CONST_DCID_ATK_SPEED);
	r &= au_table_set_column(table,
		"atk_range", 
		CONST_DCID_ATK_RANGE);
	r &= au_table_set_column(table,
		"skill_cast", 
		CONST_DCID_SKILL_CAST);
	r &= au_table_set_column(table,
		"skill_delay", 
		CONST_DCID_SKILL_DELAY);
	r &= au_table_set_column(table,
		"hit_rate", 
		CONST_DCID_HIT_RATE);
	r &= au_table_set_column(table,
		"evade_rate", 
		CONST_DCID_EVADE_RATE);
	r &= au_table_set_column(table,
		"dodge_rate", 
		CONST_DCID_DODGE_RATE);
	r &= au_table_set_column(table,
		"dmg_min_physical", 
		CONST_DCID_DMG_MIN_PHYSICAL);
	r &= au_table_set_column(table,
		"dmg_min_magic", 
		CONST_DCID_DMG_MIN_MAGIC);
	r &= au_table_set_column(table,
		"dmg_min_water", 
		CONST_DCID_DMG_MIN_WATER);
	r &= au_table_set_column(table,
		"dmg_min_air", 
		CONST_DCID_DMG_MIN_AIR);
	r &= au_table_set_column(table,
		"dmg_min_earth", 
		CONST_DCID_DMG_MIN_EARTH);
	r &= au_table_set_column(table,
		"dmg_min_fire", 
		CONST_DCID_DMG_MIN_FIRE);
	r &= au_table_set_column(table,
		"dmg_min_poison", 
		CONST_DCID_DMG_MIN_POISON);
	r &= au_table_set_column(table,
		"dmg_min_ice", 
		CONST_DCID_DMG_MIN_ICE);
	r &= au_table_set_column(table,
		"dmg_min_thunder", 
		CONST_DCID_DMG_MIN_THUNDER);
	r &= au_table_set_column(table,
		"dmg_max_physical", 
		CONST_DCID_DMG_MAX_PHYSICAL);
	r &= au_table_set_column(table,
		"dmg_max_magic", 
		CONST_DCID_DMG_MAX_MAGIC);
	r &= au_table_set_column(table,
		"dmg_max_water", 
		CONST_DCID_DMG_MAX_WATER);
	r &= au_table_set_column(table,
		"dmg_max_air", 
		CONST_DCID_DMG_MAX_AIR);
	r &= au_table_set_column(table,
		"dmg_max_earth", 
		CONST_DCID_DMG_MAX_EARTH);
	r &= au_table_set_column(table,
		"dmg_max_fire", 
		CONST_DCID_DMG_MAX_FIRE);
	r &= au_table_set_column(table,
		"dmg_max_poison", 
		CONST_DCID_DMG_MAX_POISON);
	r &= au_table_set_column(table,
		"dmg_max_ice", 
		CONST_DCID_DMG_MAX_ICE);
	r &= au_table_set_column(table,
		"dmg_max_thunder", 
		CONST_DCID_DMG_MAX_THUNDER);
	r &= au_table_set_column(table,
		"def_point_physical", 
		CONST_DCID_DEF_POINT_PHYSICAL);
	r &= au_table_set_column(table,
		"def_point_magic", 
		CONST_DCID_DEF_POINT_MAGIC);
	r &= au_table_set_column(table,
		"def_point_water", 
		CONST_DCID_DEF_POINT_WATER);
	r &= au_table_set_column(table,
		"def_point_air", 
		CONST_DCID_DEF_POINT_AIR);
	r &= au_table_set_column(table,
		"def_point_earth", 
		CONST_DCID_DEF_POINT_EARTH);
	r &= au_table_set_column(table,
		"def_point_fire", 
		CONST_DCID_DEF_POINT_FIRE);
	r &= au_table_set_column(table,
		"def_point_poison", 
		CONST_DCID_DEF_POINT_POISON);
	r &= au_table_set_column(table,
		"def_point_ice", 
		CONST_DCID_DEF_POINT_ICE);
	r &= au_table_set_column(table,
		"def_point_thunder", 
		CONST_DCID_DEF_POINT_THUNDER);
	r &= au_table_set_column(table,
		"physical_resistance", 
		CONST_DCID_PHYSICAL_RESISTANCE);
	r &= au_table_set_column(table,
		"physical_block", 
		CONST_DCID_PHYSICAL_BLOCK);
	r &= au_table_set_column(table,
		"skill_block", 
		CONST_DCID_SKILL_BLOCK);
	r &= au_table_set_column(table,
		"dmg_min_heroic", 
		CONST_DCID_DMG_MIN_HEROIC);
	r &= au_table_set_column(table,
		"dmg_max_heroic", 
		CONST_DCID_DMG_MAX_HEROIC);
	r &= au_table_set_column(table,
		"def_point_heroic", 
		CONST_DCID_DEF_POINT_HEROIC);
	r &= au_table_set_column(table,
		"heroic_melee_Resistance", 
		CONST_DCID_HEROIC_MELEE_RESISTANCE);
	r &= au_table_set_column(table,
		"heroic_ranged_Resistance", 
		CONST_DCID_HEROIC_RANGED_RESISTANCE);
	r &= au_table_set_column(table,
		"heroic_magic_Resistance", 
		CONST_DCID_HEROIC_MAGIC_RESISTANCE);
	r &= au_table_set_column_with_options(table,
		"FACTOR_PERCENT", 
		CONST_DCID_FACTOR_PERCENT, TRUE);
	r &= au_table_set_column_with_options(table,
		"FACTOR_MAGNIFY", 
		CONST_DCID_FACTOR_MAGNIFY, TRUE);
	if (!r) {
		ERROR("Failed to setup columns.");
		au_table_destroy(table);
		return FALSE;
	}
	while (au_table_read_next_line(table)) {
		boolean percent = FALSE;
		boolean magnify = FALSE;
		float * factor = NULL;
		uint32_t factorindex;
		while (au_table_read_next_column(table)) {
			enum data_col_id id = au_table_get_column(table);
			char * value = au_table_get_value(table);
			if (id == CONST_DCID_NAME) {
				temp = ap_skill_get_template_by_name(mod, value);
				if (!temp) {
					ERROR("Invalid skill const name (%s).",
						value);
					assert(0);
					return FALSE;
				}
				count++;
				continue;
			}
			if (!temp) {
				assert(0);
				continue;
			}
			if (id == CONST_DCID_SKILL_LEVEL) {
				uint32_t level = strtol(value, NULL, 10);
				if (level >= AP_SKILL_MAX_SKILL_CAP)
					break;
				factor = &temp->used_const_factor[level][0];
				temp->available_const_factor[level] = TRUE;
			}
			if (!factor) {
				assert(0);
				continue;
			}
			switch (id) {
			case CONST_DCID_SPECIAL_STATUS_RATE:
				break;
			case CONST_DCID_CREATURE_TID:
				break;
			case CONST_DCID_ADDITIONAL_SKILLTID:
				break;
			case CONST_DCID_FACTOR_PERCENT:
				percent = TRUE;
				magnify = FALSE;
				break;
			case CONST_DCID_FACTOR_MAGNIFY:
				percent = FALSE;
				magnify = TRUE;
				break;
			default:
				factorindex = getconstfactor(id);
				if (factorindex == UINT32_MAX) {
					ERROR("Invalid column id (%u).", id);
					au_table_destroy(table);
					return FALSE;
				}
				if (percent)
					factorindex += AP_SKILL_CONST_PERCENT_START;
				else if (magnify)
					factorindex = magnifyconstfactor(factorindex);
				if (factorindex >= AP_SKILL_CONST_COUNT) {
					ERROR("Invalid const factor index (%u).", 
						factorindex);
					au_table_destroy(table);
					return FALSE;
				}
				factor[factorindex] = strtof(value, NULL);
				switch (factorindex) {
				case AP_SKILL_CONST_RANGE:
				case AP_SKILL_CONST_TARGET_AREA_R:
				case AP_SKILL_CONST_TARGET_AREA_F1:
				case AP_SKILL_CONST_TARGET_AREA_F2:
				case AP_SKILL_CONST_MOVE_DISTANCE:
					factor[factorindex] *= 100.0f;
					break;
				case AP_SKILL_CONST_POINT_MOVEMENT:
					factor[AP_SKILL_CONST_POINT_MOVEMENT_FAST] =
						factor[factorindex];
					break;
				case AP_SKILL_CONST_COST_HP:
					temp->cost_type |= AP_SKILL_COST_HP;
					break;
				case AP_SKILL_CONST_COST_MP:
					temp->cost_type |= AP_SKILL_COST_MP;
					break;
				case AP_SKILL_CONST_COST_SP:
					temp->cost_type |= AP_SKILL_COST_SP;
					break;
				case AP_SKILL_CONST_COST_ARROW:
					temp->cost_type |= AP_SKILL_COST_ARROW;
					break;
				case AP_SKILL_CONST_ENDSKILL_COST_HP:
					temp->end_effect_type |= 
						AP_SKILL_ENDSKILL_CONSUME_HP;
					break;
				}
			}
		}
	}
	au_table_destroy(table);
	return TRUE;
}

boolean ap_skill_read_const2(
	struct ap_skill_module * mod,
	const char * file_path, 
	boolean decrypt)
{
	struct au_table * table = au_table_open(file_path, decrypt);
	boolean r = TRUE;
	struct ap_skill_template * temp = NULL;
	uint32_t count = 0;
	if (!table) {
		ERROR("Failed to open file (%s).", file_path);
		return FALSE;
	}
	r &= au_table_set_column(table,
		"name2", 
		CONST2_DCID_NAME2);
	r &= au_table_set_column(table,
		"skill_level2", 
		CONST2_DCID_SKILL_LEVEL2);
	r &= au_table_set_column(table,
		"damage_a2", 
		CONST2_DCID_DAMAGE_A2);
	r &= au_table_set_column(table,
		"damage_magic2", 
		CONST2_DCID_DAMAGE_MAGIC2);
	r &= au_table_set_column(table,
		"damage_water2", 
		CONST2_DCID_DAMAGE_WATER2);
	r &= au_table_set_column(table,
		"damage_air2", 
		CONST2_DCID_DAMAGE_AIR2);
	r &= au_table_set_column(table,
		"damage_earth2", 
		CONST2_DCID_DAMAGE_EARTH2);
	r &= au_table_set_column(table,
		"damage_fire2", 
		CONST2_DCID_DAMAGE_FIRE2);
	r &= au_table_set_column(table,
		"damage_poison2", 
		CONST2_DCID_DAMAGE_POISON2);
	r &= au_table_set_column(table,
		"damage_ice2", 
		CONST2_DCID_DAMAGE_ICE2);
	r &= au_table_set_column(table,
		"damage_thunder2", 
		CONST2_DCID_DAMAGE_THUNDER2);
	r &= au_table_set_column(table,
		"damage_a_PERCENT2", 
		CONST2_DCID_DAMAGE_A_PERCENT2);
	r &= au_table_set_column(table,
		"damage_magic_PERCENT2", 
		CONST2_DCID_DAMAGE_MAGIC_PERCENT2);
	r &= au_table_set_column(table,
		"damage_water_PERCENT2", 
		CONST2_DCID_DAMAGE_WATER_PERCENT2);
	r &= au_table_set_column(table,
		"damage_air_PERCENT2", 
		CONST2_DCID_DAMAGE_AIR_PERCENT2);
	r &= au_table_set_column(table,
		"damage_earth_PERCENT2", 
		CONST2_DCID_DAMAGE_EARTH_PERCENT2);
	r &= au_table_set_column(table,
		"damage_fire_PERCENT2", 
		CONST2_DCID_DAMAGE_FIRE_PERCENT2);
	r &= au_table_set_column(table,
		"damage_poison_PERCENT2", 
		CONST2_DCID_DAMAGE_POISON_PERCENT2);
	r &= au_table_set_column(table,
		"damage_ice_PERCENT2", 
		CONST2_DCID_DAMAGE_ICE_PERCENT2);
	r &= au_table_set_column(table,
		"damage_thunder_PERCENT2", 
		CONST2_DCID_DAMAGE_THUNDER_PERCENT2);
	r &= au_table_set_column(table,
		"damage_c_PERCENT2", 
		CONST2_DCID_DAMAGE_C_PERCENT2);
	r &= au_table_set_column(table,
		"cost_hp2", 
		CONST2_DCID_COST_HP2);
	r &= au_table_set_column(table,
		"cost_mp2", 
		CONST2_DCID_COST_MP2);
	r &= au_table_set_column(table,
		"duration2", 
		CONST2_DCID_DURATION2);
	r &= au_table_set_column(table,
		"interval2", 
		CONST2_DCID_INTERVAL2);
	r &= au_table_set_column(table,
		"dot_dmg_a2", 
		CONST2_DCID_DOT_DMG_A2);
	r &= au_table_set_column(table,
		"dot_dmg_magic2", 
		CONST2_DCID_DOT_DMG_MAGIC2);
	r &= au_table_set_column(table,
		"dot_dmg_water2", 
		CONST2_DCID_DOT_DMG_WATER2);
	r &= au_table_set_column(table,
		"dot_dmg_air2", 
		CONST2_DCID_DOT_DMG_AIR2);
	r &= au_table_set_column(table,
		"dot_dmg_earth2", 
		CONST2_DCID_DOT_DMG_EARTH2);
	r &= au_table_set_column(table,
		"dot_dmg_fire2", 
		CONST2_DCID_DOT_DMG_FIRE2);
	r &= au_table_set_column(table,
		"dot_dmg_poison2", 
		CONST2_DCID_DOT_DMG_POISON2);
	r &= au_table_set_column(table,
		"dot_dmg_ice2", 
		CONST2_DCID_DOT_DMG_ICE2);
	r &= au_table_set_column(table,
		"dot_dmg_thunder2", 
		CONST2_DCID_DOT_DMG_THUNDER2);
	r &= au_table_set_column(table,
		"dot_dmg_a_PERCENT2", 
		CONST2_DCID_DOT_DMG_A_PERCENT2);
	r &= au_table_set_column(table,
		"dot_dmg_magic_PERCENT2", 
		CONST2_DCID_DOT_DMG_MAGIC_PERCENT2);
	r &= au_table_set_column(table,
		"dot_dmg_water_PERCENT2", 
		CONST2_DCID_DOT_DMG_WATER_PERCENT2);
	r &= au_table_set_column(table,
		"dot_dmg_air_PERCENT2", 
		CONST2_DCID_DOT_DMG_AIR_PERCENT2);
	r &= au_table_set_column(table,
		"dot_dmg_earth_PERCENT2", 
		CONST2_DCID_DOT_DMG_EARTH_PERCENT2);
	r &= au_table_set_column(table,
		"dot_dmg_fire_PERCENT2", 
		CONST2_DCID_DOT_DMG_FIRE_PERCENT2);
	r &= au_table_set_column(table,
		"dot_dmg_poison_PERCENT2", 
		CONST2_DCID_DOT_DMG_POISON_PERCENT2);
	r &= au_table_set_column(table,
		"dot_dmg_ice_PERCENT2", 
		CONST2_DCID_DOT_DMG_ICE_PERCENT2);
	r &= au_table_set_column(table,
		"dot_dmg_thunder_PERCENT2", 
		CONST2_DCID_DOT_DMG_THUNDER_PERCENT2);
	r &= au_table_set_column(table,
		"stun_time2", 
		CONST2_DCID_STUN_TIME2);
	r &= au_table_set_column(table,
		"skill_rate2", 
		CONST2_DCID_SKILL_RATE2);
	r &= au_table_set_column(table,
		"aggrodoll_hp2", 
		CONST2_DCID_AGGRODOLL_HP2);
	r &= au_table_set_column(table,
		"dot_damage_time2", 
		CONST2_DCID_DOT_DAMAGE_TIME2);
	r &= au_table_set_column(table,
		"death2", 
		CONST2_DCID_DEATH2);
	r &= au_table_set_column(table,
		"specific_skill_levelup2", 
		CONST2_DCID_SPECIFIC_SKILL_LEVELUP2);
	r &= au_table_set_column(table,
		"Connection_TID2", 
		CONST2_DCID_CONNECTION_TID2);
	r &= au_table_set_column(table,
		"Skill_Union2", 
		CONST2_DCID_SKILL_UNION2);
	r &= au_table_set_column(table,
		"Skill_Union_Control2", 
		CONST2_DCID_SKILL_UNION_CONTROL2);
	r &= au_table_set_column(table,
		"Max_Skill_Union2", 
		CONST2_DCID_MAX_SKILL_UNION2);
	r &= au_table_set_column(table,
		"bonus_drop_add_rate2", 
		CONST2_DCID_BONUS_DROP_ADD_RATE2);
	r &= au_table_set_column(table,
		"velocity2", 
		CONST2_DCID_VELOCITY2);
	r &= au_table_set_column(table,
		"ea_damage_physical2", 
		CONST2_DCID_EA_DAMAGE_PHYSICAL2);
	r &= au_table_set_column(table,
		"ea_damage_magic2", 
		CONST2_DCID_EA_DAMAGE_MAGIC2);
	r &= au_table_set_column(table,
		"ea_damage_water2", 
		CONST2_DCID_EA_DAMAGE_WATER2);
	r &= au_table_set_column(table,
		"ea_damage_air2", 
		CONST2_DCID_EA_DAMAGE_AIR2);
	r &= au_table_set_column(table,
		"ea_damage_earth2", 
		CONST2_DCID_EA_DAMAGE_EARTH2);
	r &= au_table_set_column(table,
		"ea_damage_fire2", 
		CONST2_DCID_EA_DAMAGE_FIRE2);
	r &= au_table_set_column(table,
		"ea_damage_poison2", 
		CONST2_DCID_EA_DAMAGE_POISON2);
	r &= au_table_set_column(table,
		"ea_damage_ice2", 
		CONST2_DCID_EA_DAMAGE_ICE2);
	r &= au_table_set_column(table,
		"ea_damage_thunder2", 
		CONST2_DCID_EA_DAMAGE_THUNDER2);
	r &= au_table_set_column(table,
		"ea_damage_c2", 
		CONST2_DCID_EA_DAMAGE_C2);
	r &= au_table_set_column(table,
		"ea_damage_physical_PERCENT2", 
		CONST2_DCID_EA_DAMAGE_PHYSICAL_PERCENT2);
	r &= au_table_set_column(table,
		"ea_damage_magic_PERCENT2", 
		CONST2_DCID_EA_DAMAGE_MAGIC_PERCENT2);
	r &= au_table_set_column(table,
		"ea_damage_water_PERCENT2", 
		CONST2_DCID_EA_DAMAGE_WATER_PERCENT2);
	r &= au_table_set_column(table,
		"ea_damage_air_PERCENT2", 
		CONST2_DCID_EA_DAMAGE_AIR_PERCENT2);
	r &= au_table_set_column(table,
		"ea_damage_earth_PERCENT2", 
		CONST2_DCID_EA_DAMAGE_EARTH_PERCENT2);
	r &= au_table_set_column(table,
		"ea_damage_fire_PERCENT2", 
		CONST2_DCID_EA_DAMAGE_FIRE_PERCENT2);
	r &= au_table_set_column(table,
		"ea_damage_poison_PERCENT2", 
		CONST2_DCID_EA_DAMAGE_POISON_PERCENT2);
	r &= au_table_set_column(table,
		"ea_damage_ice_PERCENT2", 
		CONST2_DCID_EA_DAMAGE_ICE_PERCENT2);
	r &= au_table_set_column(table,
		"ea_damage_thunder_PERCENT2", 
		CONST2_DCID_EA_DAMAGE_THUNDER_PERCENT2);
	r &= au_table_set_column(table,
		"ea_damage_c_PERCENT2", 
		CONST2_DCID_EA_DAMAGE_C_PERCENT2);
	r &= au_table_set_column(table,
		"FACTOR_POINT2", 
		CONST2_DCID_FACTOR_POINT2);
	r &= au_table_set_column(table,
		"con2", 
		CONST2_DCID_CON2);
	r &= au_table_set_column(table,
		"str2", 
		CONST2_DCID_STR2);
	r &= au_table_set_column(table,
		"int2", 
		CONST2_DCID_INT2);
	r &= au_table_set_column(table,
		"dex2", 
		CONST2_DCID_DEX2);
	r &= au_table_set_column(table,
		"cha2", 
		CONST2_DCID_CHA2);
	r &= au_table_set_column(table,
		"wis2", 
		CONST2_DCID_WIS2);
	r &= au_table_set_column(table,
		"movement2", 
		CONST2_DCID_MOVEMENT2);
	r &= au_table_set_column(table,
		"hp2", 
		CONST2_DCID_HP2);
	r &= au_table_set_column(table,
		"mp2", 
		CONST2_DCID_MP2);
	r &= au_table_set_column(table,
		"sp2", 
		CONST2_DCID_SP2);
	r &= au_table_set_column(table,
		"ap2", 
		CONST2_DCID_AP2);
	r &= au_table_set_column(table,
		"agro2", 
		CONST2_DCID_AGRO2);
	r &= au_table_set_column(table,
		"max_hp2", 
		CONST2_DCID_MAX_HP2);
	r &= au_table_set_column(table,
		"max_mp2", 
		CONST2_DCID_MAX_MP2);
	r &= au_table_set_column(table,
		"max_sp2", 
		CONST2_DCID_MAX_SP2);
	r &= au_table_set_column(table,
		"atk_speed2", 
		CONST2_DCID_ATK_SPEED2);
	r &= au_table_set_column(table,
		"atk_range2", 
		CONST2_DCID_ATK_RANGE2);
	r &= au_table_set_column(table,
		"skill_cast2", 
		CONST2_DCID_SKILL_CAST2);
	r &= au_table_set_column(table,
		"skill_delay2", 
		CONST2_DCID_SKILL_DELAY2);
	r &= au_table_set_column(table,
		"hit_rate2", 
		CONST2_DCID_HIT_RATE2);
	r &= au_table_set_column(table,
		"evade_rate2", 
		CONST2_DCID_EVADE_RATE2);
	r &= au_table_set_column(table,
		"dodge_rate2", 
		CONST2_DCID_DODGE_RATE2);
	r &= au_table_set_column(table,
		"dmg_min_physical2", 
		CONST2_DCID_DMG_MIN_PHYSICAL2);
	r &= au_table_set_column(table,
		"dmg_min_magic2", 
		CONST2_DCID_DMG_MIN_MAGIC2);
	r &= au_table_set_column(table,
		"dmg_min_water2", 
		CONST2_DCID_DMG_MIN_WATER2);
	r &= au_table_set_column(table,
		"dmg_min_air2", 
		CONST2_DCID_DMG_MIN_AIR2);
	r &= au_table_set_column(table,
		"dmg_min_earth2", 
		CONST2_DCID_DMG_MIN_EARTH2);
	r &= au_table_set_column(table,
		"dmg_min_fire2", 
		CONST2_DCID_DMG_MIN_FIRE2);
	r &= au_table_set_column(table,
		"dmg_min_poison2", 
		CONST2_DCID_DMG_MIN_POISON2);
	r &= au_table_set_column(table,
		"dmg_min_ice2", 
		CONST2_DCID_DMG_MIN_ICE2);
	r &= au_table_set_column(table,
		"dmg_min_thunder2", 
		CONST2_DCID_DMG_MIN_THUNDER2);
	r &= au_table_set_column(table,
		"dmg_max_physical2", 
		CONST2_DCID_DMG_MAX_PHYSICAL2);
	r &= au_table_set_column(table,
		"dmg_max_magic2", 
		CONST2_DCID_DMG_MAX_MAGIC2);
	r &= au_table_set_column(table,
		"dmg_max_water2", 
		CONST2_DCID_DMG_MAX_WATER2);
	r &= au_table_set_column(table,
		"dmg_max_air2", 
		CONST2_DCID_DMG_MAX_AIR2);
	r &= au_table_set_column(table,
		"dmg_max_earth2", 
		CONST2_DCID_DMG_MAX_EARTH2);
	r &= au_table_set_column(table,
		"dmg_max_fire2", 
		CONST2_DCID_DMG_MAX_FIRE2);
	r &= au_table_set_column(table,
		"dmg_max_poison2", 
		CONST2_DCID_DMG_MAX_POISON2);
	r &= au_table_set_column(table,
		"dmg_max_ice2", 
		CONST2_DCID_DMG_MAX_ICE2);
	r &= au_table_set_column(table,
		"dmg_max_thunder2", 
		CONST2_DCID_DMG_MAX_THUNDER2);
	r &= au_table_set_column(table,
		"def_point_physical2", 
		CONST2_DCID_DEF_POINT_PHYSICAL2);
	r &= au_table_set_column(table,
		"def_point_magic2", 
		CONST2_DCID_DEF_POINT_MAGIC2);
	r &= au_table_set_column(table,
		"def_point_water2", 
		CONST2_DCID_DEF_POINT_WATER2);
	r &= au_table_set_column(table,
		"def_point_air2", 
		CONST2_DCID_DEF_POINT_AIR2);
	r &= au_table_set_column(table,
		"def_point_earth2", 
		CONST2_DCID_DEF_POINT_EARTH2);
	r &= au_table_set_column(table,
		"def_point_fire2", 
		CONST2_DCID_DEF_POINT_FIRE2);
	r &= au_table_set_column(table,
		"def_point_poison2", 
		CONST2_DCID_DEF_POINT_POISON2);
	r &= au_table_set_column(table,
		"def_point_ice2", 
		CONST2_DCID_DEF_POINT_ICE2);
	r &= au_table_set_column(table,
		"def_point_thunder2", 
		CONST2_DCID_DEF_POINT_THUNDER2);
	r &= au_table_set_column(table,
		"physical_resistance2", 
		CONST2_DCID_PHYSICAL_RESISTANCE2);
	r &= au_table_set_column(table,
		"physical_block2", 
		CONST2_DCID_PHYSICAL_BLOCK2);
	r &= au_table_set_column(table,
		"skill_block2", 
		CONST2_DCID_SKILL_BLOCK2);
	r &= au_table_set_column(table,
		"FACTOR_PERCENT2", 
		CONST2_DCID_FACTOR_PERCENT2);
	r &= au_table_set_column(table,
		"ignore_physical_defence_percent2", 
		CONST2_DCID_IGNORE_PHYSICAL_DEFENCE_PERCENT2);
	r &= au_table_set_column(table,
		"ignore_attribute_defence_percent2", 
		CONST2_DCID_IGNORE_ATTRIBUTE_DEFENCE_PERCENT2);
	r &= au_table_set_column(table,
		"critical_defence_percent2", 
		CONST2_DCID_CRITICAL_DEFENCE_PERCENT2);
	r &= au_table_set_column(table,
		"durability_percent2", 
		CONST2_DCID_DURABILITY_PERCENT2);
	r &= au_table_set_column(table,
		"durability_num2", 
		CONST2_DCID_DURABILITY_NUM2);
	if (!r) {
		ERROR("Failed to setup columns.");
		au_table_destroy(table);
		return FALSE;
	}
	while (au_table_read_next_line(table)) {
		boolean percent = FALSE;
		float * factor = NULL;
		uint32_t factorindex;
		uint32_t level;
		while (au_table_read_next_column(table)) {
			enum data_col_id id = au_table_get_column(table);
			char * value = au_table_get_value(table);
			if (id == CONST2_DCID_NAME2) {
				temp = ap_skill_get_template_by_name(mod, value);
				if (!temp) {
					ERROR("Invalid skill const name (%s).", value);
					assert(0);
					return FALSE;
				}
				count++;
				continue;
			}
			if (!temp) {
				assert(0);
				continue;
			}
			if (id == CONST2_DCID_SKILL_LEVEL2) {
				level = strtol(value, NULL, 10);
				if (level >= AP_SKILL_MAX_SKILL_CAP)
					break;
				factor = &temp->used_const_factor2[level][0];
				temp->available_const_factor2[level] = TRUE;
			}
			if (!factor) {
				assert(0);
				continue;
			}
			if (id == CONST2_DCID_FACTOR_PERCENT2) {
				percent = TRUE;
			}
			else if (id == CONST2_DCID_IGNORE_PHYSICAL_DEFENCE_PERCENT2) {
				percent = FALSE;
			}
			else if (id == CONST2_DCID_SPECIFIC_SKILL_LEVELUP2) {
				assert(temp->level_up_skill_count[level] < AP_SKILL_MAX_SKILL_LEVELUP_TID);
				temp->level_up_skill_tid[level][temp->level_up_skill_count[level]++] =
					strtoul(value, NULL, 10);
				continue;
			}
			switch (id) {
			default:
				factorindex = getconstfactor2(id);
				if (factorindex == UINT32_MAX) {
					ERROR("Invalid column id (%u).", id);
					au_table_destroy(table);
					return FALSE;
				}
				if (percent)
					factorindex += AP_SKILL_CONST_PERCENT_START;
				if (factorindex >= AP_SKILL_CONST_COUNT) {
					ERROR("Invalid const factor index (%u).", factorindex);
					au_table_destroy(table);
					return FALSE;
				}
				factor[factorindex] = strtof(value, NULL);
				switch (factorindex) {
				case AP_SKILL_CONST_POINT_MOVEMENT:
					factor[AP_SKILL_CONST_POINT_MOVEMENT_FAST] =
						factor[factorindex];
					break;
				}
			}
		}
	}
	au_table_destroy(table);
	return TRUE;
}

struct ap_skill * ap_skill_new(struct ap_skill_module * mod)
{
	struct ap_skill * c = mod->freelist;
	uint32_t id;
	if (c) {
		id = c->id;
		mod->freelist = c->next;
	}
	else {
		c = alloc(ap_module_get_module_data_size(mod, AP_SKILL_MDI_SKILL));
		id = ++mod->id_counter;
	}
	ap_module_construct_module_data(mod, AP_SKILL_MDI_SKILL, c);
	c->base_type = AP_BASE_TYPE_SKILL;
	c->id = id;
	return c;
}

void ap_skill_free(struct ap_skill_module * mod, struct ap_skill * skill)
{
	ap_module_destruct_module_data(mod, 
		AP_SKILL_MDI_SKILL, skill);
	skill->next = mod->freelist;
	mod->freelist = skill;
}

void ap_skill_add_callback(
	struct ap_skill_module * mod,
	enum ap_skill_callback_id id,
	ap_module_t callback_module,
	ap_module_default_t callback)
{
	ap_module_add_callback(mod, id, callback_module, callback);
}

size_t ap_skill_attach_data(
	struct ap_skill_module * mod,
	enum ap_skill_module_data_index data_index,
	size_t data_size,
	ap_module_t callback_module,
	ap_module_default_t constructor,
	ap_module_default_t destructor)
{
	return ap_module_attach_data(mod, data_index, data_size, 
		callback_module, constructor, destructor);
}

void ap_skill_add_stream_callback(
	struct ap_skill_module * mod,
	enum ap_skill_module_data_index data_index,
	const char * module_name,
	ap_module_t callback_module,
	ap_module_stream_read_t read_cb,
	ap_module_stream_write_t write_cb)
{
	if (data_index < 0 || data_index >= AP_SKILL_MDI_COUNT) {
		ERROR("Invalid stream data index: %u.");
		return;
	}
	ap_module_stream_add_callback(mod, data_index,
		module_name, callback_module, read_cb, write_cb);
}

struct ap_skill_template * ap_skill_get_template(
	struct ap_skill_module * mod,
	uint32_t tid)
{
	return ap_admin_get_object_by_id(&mod->template_admin, tid);
}

struct ap_skill_template * ap_skill_get_template_by_name(
	struct ap_skill_module * mod,
	const char * name)
{
	return ap_admin_get_object_by_name(&mod->template_admin, name);
}

struct ap_skill_character * ap_skill_get_character(
	struct ap_skill_module * mod,
	struct ap_character * character)
{
	return ap_module_get_attached_data(character, mod->character_offset);
}

float ap_skill_get_cast_range(
	struct ap_skill_module * mod,
	struct ap_character * character,
	struct ap_skill * skill)
{
	const float * f = ap_skill_get_const_factor(mod, character, skill);
	float r = f[AP_SKILL_CONST_RANGE];
	if (r == 0.0f) {
		/* Default to character attack range. */
		r = (float)character->factor.attack.attack_range;
	}
	if (CHECK_BIT(skill->temp->range_type, AP_SKILL_RANGE_BOX)) {
		/* AREA_F1 is box length. 
		 * It is shortened to ensure that target 
		 * remains within hit box. */
		return f[AP_SKILL_CONST_TARGET_AREA_F1] * 0.8f;
	}
	else {
		const struct ap_skill_character * sc = 
			ap_skill_get_character(mod, character);
		return (r + sc->factor_effect_arg.range_adust_percent);
	}
}

uint32_t ap_skill_get_modified_level(
	struct ap_skill_module * mod,
	struct ap_character * character,
	const struct ap_skill * skill)
{
	struct ap_skill_character * attachment = ap_skill_get_character(mod, character);
	int32_t level = skill->factor.dirt.skill_level + 
		attachment->combat_effect_arg.skill_level_up_point;
	if (level < 1) {
		level = 1;
	}
	else {
		if (level >= AP_SKILL_MAX_SKILL_CAP)
			level = AP_SKILL_MAX_SKILL_CAP - 1;
		for (; level > 1; level--) {
			if (skill->temp->available_const_factor[level])
				break;
		}
	}
	assert(skill->temp->available_const_factor[level]);
	return level;
}

const float * ap_skill_get_const_factor(
	struct ap_skill_module * mod,
	struct ap_character * character,
	const struct ap_skill * skill)
{
	uint32_t level = ap_skill_get_modified_level(mod, character, skill);
	return &skill->temp->used_const_factor[level][0];
}

struct ap_skill * ap_skill_find(
	struct ap_skill_module * mod,
	struct ap_character * character,
	uint32_t skill_id)
{
	struct ap_skill_character * sc = ap_skill_get_character(mod, character);
	uint32_t i;
	for (i = 0; i < sc->skill_count; i++) {
		if (sc->skill_id[i] == skill_id)
			return sc->skill[i];
	}
	return NULL;
}

struct ap_skill * ap_skill_find_by_tid(
	struct ap_skill_module * mod,
	struct ap_character * character,
	uint32_t skill_tid)
{
	struct ap_skill_character * sc = ap_skill_get_character(mod, character);
	uint32_t i;
	for (i = 0; i < sc->skill_count; i++) {
		if (sc->skill[i]->tid == skill_tid)
			return sc->skill[i];
	}
	return NULL;
}

boolean ap_skill_attempt_cast(
	struct ap_skill_module * mod,
	struct ap_character * character,
	struct ap_skill * skill)
{
	uint64_t tick = ap_tick_get(mod->ap_tick);
	struct ap_skill_cb_attempt_cast cb = { character, skill, tick };
	const float * f = ap_skill_get_const_factor(mod, character, skill);
	if (tick < skill->cooldown_tick)
		return FALSE;
	if (character->is_transformed)
		return FALSE;
	if (f[AP_SKILL_CONST_COST_HP] >= character->factor.char_point.hp)
		return FALSE;
	if (f[AP_SKILL_CONST_COST_MP] > character->factor.char_point.mp)
		return FALSE;
	if (skill->temp->is_auto_attack)
		return FALSE;
	if (CHECK_BIT(skill->temp->attribute, AP_SKILL_ATTRIBUTE_PASSIVE))
		return FALSE;
	if (CHECK_BIT(character->special_status, 
			AP_CHARACTER_SPECIAL_STATUS_DISABLE_SKILL) &&
		ap_skill_is_offensive(skill)) {
		return FALSE;
	}
	if (CHECK_BIT(skill->temp->special_status, 
			AP_SKILL_SPECIAL_STATUS_TRANSPARENT) &&
		tick < character->combat_end_tick &&
		!ap_skill_check_effect2(skill, AP_SKILL_EFFECT2_FORCE,
			AP_SKILL_EFFECT_DETAIL_FORCE, 
			AP_SKILL_EFFECT_DETAIL_FORCE_INVISIBLE_COMBAT)) {
		return FALSE;
	}
	/** \todo
	 * Check:
	 * - If skill can be casted while mounted.
	 * - If character is mutated.
	 * - If skill should be cast on death (i.e. Bomba).
	 * - If character is ArchLord but skill type is not.
	 * - If weapon meets skill requirements.
	 * - If skill is a summoning skill and character meets req. */
	return ap_module_enum_callback(mod, AP_SKILL_CB_ATTEMPT_CAST, &cb);
}

boolean ap_skill_is_valid_target(
	struct ap_skill_module * mod,
	struct ap_character * character,
	struct ap_character * target,
	struct ap_skill * skill,
	boolean force_attack)
{
	uint64_t tick = ap_tick_get(mod->ap_tick);
	struct ap_skill_cb_is_valid_target cb = { 
		character, target, skill };
	const struct ap_skill_template * temp = skill->temp;
	const float * f = ap_skill_get_const_factor(mod, character, skill);
	if (!CHECK_BIT(target->char_type, AP_CHARACTER_TYPE_TARGETABLE))
		return FALSE;
	if (CHECK_BIT(temp->attribute, AP_SKILL_ATTRIBUTE_PRODUCT)) {
		if (!CHECK_BIT(target->char_type, AP_CHARACTER_TYPE_MONSTER) ||
			target->action_status != AP_CHARACTER_ACTION_STATUS_DEAD) {
			return FALSE;
		}
		else {
			return TRUE;
		}
	}
	if (CHECK_BIT(temp->effect_type2, AP_SKILL_EFFECT2_RESURRECTION))
		return (target->action_status == AP_CHARACTER_ACTION_STATUS_DEAD);
	if (target->action_status == AP_CHARACTER_ACTION_STATUS_DEAD)
		return FALSE;
	if (!ap_skill_is_offensive(skill))
		return TRUE;
	if (!ap_character_is_valid_attack_target(mod->ap_character, 
			character, target, force_attack)) {
		return FALSE;
	}
	/** \todo
	 * Check:
	 * - If character or target is mutated.
	 * - Siege related conditions that invalidate target.
	 * - If target is in the same party as character.
	 * - Battleground race restrictions.
	 * - Battle (arena) state. */
	if (CHECK_BIT(target->special_status, AP_CHARACTER_SPECIAL_STATUS_INVINCIBLE))
		return FALSE;
	if (CHECK_BIT(target->special_status, AP_CHARACTER_SPECIAL_STATUS_TRANSPARENT))
		return FALSE;
	return ap_module_enum_callback(mod, AP_SKILL_CB_IS_VALID_TARGET, &cb);
}

boolean ap_skill_is_stronger_effect_applied(
	struct ap_skill_module * mod,
	struct ap_character * character,
	const struct ap_skill_template * temp,
	uint32_t skill_level)
{
	struct ap_skill_character * attachment = ap_skill_get_character(mod, character);
	uint32_t i;
	uint32_t classifyid = ap_skill_get_classify_id(temp, skill_level);
	uint32_t classifylevel = ap_skill_get_classify_level(temp, skill_level);
	assert(ap_skill_is_buff(temp) != FALSE || ap_skill_is_passive(temp));
	for (i = 0; i < attachment->buff_count; i++) {
		struct ap_skill_buff_list * buff = &attachment->buff_list[i];
		const float * constfactor = buff->temp->used_const_factor[buff->skill_level];
		uint32_t id = ap_skill_get_classify_id(buff->temp, buff->skill_level);
		uint32_t level = ap_skill_get_classify_level(buff->temp, buff->skill_level);;
		if (id && id == classifyid && level > classifylevel)
			return TRUE;
		if (buff->skill_tid == temp->id && buff->skill_level > skill_level)
			return TRUE;
	}
	return FALSE;
}

boolean ap_skill_is_stronger_or_equal_effect_applied(
	struct ap_skill_module * mod,
	struct ap_character * character,
	const struct ap_skill_template * temp,
	uint32_t skill_level)
{
	struct ap_skill_character * attachment = ap_skill_get_character(mod, character);
	uint32_t i;
	uint32_t classifyid = ap_skill_get_classify_id(temp, skill_level);
	uint32_t classifylevel = ap_skill_get_classify_level(temp, skill_level);
	assert(ap_skill_is_buff(temp) != FALSE);
	for (i = 0; i < attachment->buff_count; i++) {
		struct ap_skill_buff_list * buff = &attachment->buff_list[i];
		const float * constfactor = buff->temp->used_const_factor[buff->skill_level];
		uint32_t id = ap_skill_get_classify_id(buff->temp, buff->skill_level);
		uint32_t level = ap_skill_get_classify_level(buff->temp, buff->skill_level);;
		if (id && id == classifyid && level >= classifylevel)
			return TRUE;
		if (buff->skill_tid == temp->id && buff->skill_level >= skill_level)
			return TRUE;
	}
	return FALSE;
}

static inline void addconstfactorfloat(
	struct ap_character * character,
	float * dst,
	float value, 
	int modifier,
	uint64_t factorbit)
{
	if (value != 0.0f) {
		*dst += value * modifier;
		character->update_flags |= factorbit;
	}
}

static inline void addconstfactoruint(
	struct ap_character * character,
	uint32_t * dst, 
	float value,
	int modifier,
	uint64_t factorbit)
{
	if (value != 0.0f) {
		*dst += (int)value * modifier;
		assert((int)*dst >= 0);
		character->update_flags |= factorbit;
	}
}

static inline void addconstfactorint(
	struct ap_character * character,
	int32_t * dst, 
	float value,
	int modifier,
	uint64_t factorbit)
{
	if (value != 0.0f) {
		*dst += (int)value * modifier;
		character->update_flags |= factorbit;
	}
}

static void applybuff(
	struct ap_skill_module * mod,
	struct ap_character * character,
	struct ap_skill_character * attachment,
	struct ap_skill_buff_list * buff,
	int modifier)
{
	const struct ap_skill_template * temp = buff->temp;
	const float * constfactor = ap_skill_get_buff_const_factor(buff);
	const float * constfactor2 = ap_skill_get_buff_const_factor2(buff);
	addconstfactoruint(character, &character->factor_percent.char_point_max.hp,
		constfactor[AP_SKILL_CONST_PERCENT_HP_MAX], modifier, 
		AP_FACTORS_BIT_MAX_HP);
	addconstfactoruint(character, &character->factor_point.char_point_max.hp,
		constfactor[AP_SKILL_CONST_POINT_HP_MAX], modifier, 
		AP_FACTORS_BIT_MAX_HP);
	addconstfactoruint(character, &character->factor_percent.char_point_max.mp,
		constfactor[AP_SKILL_CONST_PERCENT_MP_MAX], modifier, 
		AP_FACTORS_BIT_MAX_MP);
	addconstfactoruint(character, &character->factor_point.char_point_max.mp,
		constfactor[AP_SKILL_CONST_POINT_MP_MAX], modifier, 
		AP_FACTORS_BIT_MAX_MP);
	addconstfactorfloat(character, &character->factor.char_status.con,
		constfactor[AP_SKILL_CONST_POINT_CON], modifier, 
		AP_FACTORS_BIT_CHAR_STATUS | AP_FACTORS_BIT_MAX_HP);
	addconstfactorfloat(character, &character->factor.char_status.str,
		constfactor[AP_SKILL_CONST_POINT_STR], modifier, 
		AP_FACTORS_BIT_CHAR_STATUS);
	addconstfactorfloat(character, &character->factor.char_status.intel,
		constfactor[AP_SKILL_CONST_POINT_INT], modifier, 
		AP_FACTORS_BIT_CHAR_STATUS);
	addconstfactorfloat(character, &character->factor.char_status.agi,
		constfactor[AP_SKILL_CONST_POINT_DEX], modifier, 
		AP_FACTORS_BIT_CHAR_STATUS);
	addconstfactorfloat(character, &character->factor.char_status.wis,
		constfactor[AP_SKILL_CONST_POINT_WIS], modifier, 
		AP_FACTORS_BIT_CHAR_STATUS | AP_FACTORS_BIT_MAX_MP);
	if (constfactor[AP_SKILL_CONST_PERCENT_MOVEMENT]) {
		if (temp->attribute & AP_SKILL_ATTRIBUTE_DEBUFF) {
			character->negative_percent_movement += modifier * 
				(int)constfactor[AP_SKILL_CONST_PERCENT_MOVEMENT];
			character->negative_percent_movement_fast += modifier * 
				(int)constfactor[AP_SKILL_CONST_PERCENT_MOVEMENT];
		}
		else {
			character->factor_percent.char_status.movement += modifier * 
				(int)constfactor[AP_SKILL_CONST_PERCENT_MOVEMENT];
			character->factor_percent.char_status.movement_fast += modifier * 
				(int)constfactor[AP_SKILL_CONST_PERCENT_MOVEMENT];
		}
		character->update_flags |= AP_FACTORS_BIT_MOVEMENT_SPEED;
	}
	addconstfactorint(character, &character->factor_percent.attack.attack_speed,
		constfactor[AP_SKILL_CONST_PERCENT_ATKSPEED], modifier, 
		AP_FACTORS_BIT_ATTACK_SPEED);
	addconstfactorfloat(character, &character->factor.defense.rate.physical_block,
		constfactor[AP_SKILL_CONST_BLOCK_POINT], modifier, 
		AP_FACTORS_BIT_DEFENSE);
	addconstfactorfloat(character, &character->factor.defense.point.physical,
		constfactor[AP_SKILL_CONST_POINT_DEF_POINT_PHYSICAL], modifier, 
		AP_FACTORS_BIT_DEFENSE);
	addconstfactorfloat(character, &character->factor.defense.point.heroic,
		constfactor[AP_SKILL_CONST_POINT_DEF_POINT_HEROIC], modifier, 
		AP_FACTORS_BIT_DEFENSE);
	addconstfactorfloat(character, &character->factor.defense.rate.physical,
		constfactor[AP_SKILL_CONST_POINT_DEF_RATE_PHYSICAL], modifier, 
		AP_FACTORS_BIT_DEFENSE);
	addconstfactorfloat(character, &character->factor.defense.rate.skill_block,
		constfactor[AP_SKILL_CONST_SKILL_BLOCK], modifier, 
		AP_FACTORS_BIT_DEFENSE);
	addconstfactorfloat(character, &character->factor.defense.point.magic,
		constfactor[AP_SKILL_CONST_POINT_DEF_POINT_MAGIC], modifier, 
		AP_FACTORS_BIT_DEFENSE);
	addconstfactorfloat(character, &character->factor.defense.point.water,
		constfactor[AP_SKILL_CONST_POINT_DEF_POINT_WATER], modifier, 
		AP_FACTORS_BIT_DEFENSE);
	addconstfactorfloat(character, &character->factor.defense.point.fire,
		constfactor[AP_SKILL_CONST_POINT_DEF_POINT_FIRE], modifier, 
		AP_FACTORS_BIT_DEFENSE);
	addconstfactorfloat(character, &character->factor.defense.point.earth,
		constfactor[AP_SKILL_CONST_POINT_DEF_POINT_EARTH], modifier, 
		AP_FACTORS_BIT_DEFENSE);
	addconstfactorfloat(character, &character->factor.defense.point.air,
		constfactor[AP_SKILL_CONST_POINT_DEF_POINT_AIR], modifier, 
		AP_FACTORS_BIT_DEFENSE);
	addconstfactorfloat(character, &character->factor.defense.point.poison,
		constfactor[AP_SKILL_CONST_POINT_DEF_POINT_POISON], modifier, 
		AP_FACTORS_BIT_DEFENSE);
	addconstfactorfloat(character, &character->factor.defense.point.lightning,
		constfactor[AP_SKILL_CONST_POINT_DEF_POINT_LIGHTENING], modifier, 
		AP_FACTORS_BIT_DEFENSE);
	addconstfactorfloat(character, &character->factor.defense.point.ice,
		constfactor[AP_SKILL_CONST_POINT_DEF_POINT_ICE], modifier, 
		AP_FACTORS_BIT_DEFENSE);
	addconstfactorfloat(character, &character->factor.defense.point.heroic_melee,
		constfactor[AP_SKILL_CONST_POINT_DEF_RATE_HEROIC_MELEE], modifier, 
		AP_FACTORS_BIT_DEFENSE);
	addconstfactorfloat(character, &character->factor.defense.point.heroic_ranged,
		constfactor[AP_SKILL_CONST_POINT_DEF_RATE_HEROIC_RANGED], modifier, 
		AP_FACTORS_BIT_DEFENSE);
	addconstfactorfloat(character, &character->factor.defense.point.heroic_magic,
		constfactor[AP_SKILL_CONST_POINT_DEF_RATE_HEROIC_MAGIC], modifier, 
		AP_FACTORS_BIT_DEFENSE);
	addconstfactorfloat(character, &character->factor.damage.min.physical,
		constfactor[AP_SKILL_CONST_POINT_DMG_MIN_PHYSICAL], modifier, 
		AP_FACTORS_BIT_DAMAGE);
	addconstfactorfloat(character, &character->factor.damage.min.magic,
		constfactor[AP_SKILL_CONST_POINT_DMG_MIN_MAGIC], modifier, 
		AP_FACTORS_BIT_DAMAGE);
	addconstfactorfloat(character, &character->factor.damage.min.water,
		constfactor[AP_SKILL_CONST_POINT_DMG_MIN_WATER], modifier, 
		AP_FACTORS_BIT_DAMAGE);
	addconstfactorfloat(character, &character->factor.damage.min.fire,
		constfactor[AP_SKILL_CONST_POINT_DMG_MIN_FIRE], modifier, 
		AP_FACTORS_BIT_DAMAGE);
	addconstfactorfloat(character, &character->factor.damage.min.earth,
		constfactor[AP_SKILL_CONST_POINT_DMG_MIN_EARTH], modifier, 
		AP_FACTORS_BIT_DAMAGE);
	addconstfactorfloat(character, &character->factor.damage.min.air,
		constfactor[AP_SKILL_CONST_POINT_DMG_MIN_AIR], modifier, 
		AP_FACTORS_BIT_DAMAGE);
	addconstfactorfloat(character, &character->factor.damage.min.poison,
		constfactor[AP_SKILL_CONST_POINT_DMG_MIN_POISON], modifier, 
		AP_FACTORS_BIT_DAMAGE);
	addconstfactorfloat(character, &character->factor.damage.min.lightning,
		constfactor[AP_SKILL_CONST_POINT_DMG_MIN_LIGHTENING], modifier, 
		AP_FACTORS_BIT_DAMAGE);
	addconstfactorfloat(character, &character->factor.damage.min.heroic,
		constfactor[AP_SKILL_CONST_POINT_DMG_MIN_HEROIC], modifier, 
		AP_FACTORS_BIT_DAMAGE);
	addconstfactorfloat(character, &character->factor.damage.max.physical,
		constfactor[AP_SKILL_CONST_POINT_DMG_MAX_PHYSICAL], modifier, 
		AP_FACTORS_BIT_DAMAGE);
	addconstfactorfloat(character, &character->factor.damage.max.magic,
		constfactor[AP_SKILL_CONST_POINT_DMG_MAX_MAGIC], modifier, 
		AP_FACTORS_BIT_DAMAGE);
	addconstfactorfloat(character, &character->factor.damage.max.water,
		constfactor[AP_SKILL_CONST_POINT_DMG_MAX_WATER], modifier, 
		AP_FACTORS_BIT_DAMAGE);
	addconstfactorfloat(character, &character->factor.damage.max.fire,
		constfactor[AP_SKILL_CONST_POINT_DMG_MAX_FIRE], modifier, 
		AP_FACTORS_BIT_DAMAGE);
	addconstfactorfloat(character, &character->factor.damage.max.earth,
		constfactor[AP_SKILL_CONST_POINT_DMG_MAX_EARTH], modifier, 
		AP_FACTORS_BIT_DAMAGE);
	addconstfactorfloat(character, &character->factor.damage.max.air,
		constfactor[AP_SKILL_CONST_POINT_DMG_MAX_AIR], modifier, 
		AP_FACTORS_BIT_DAMAGE);
	addconstfactorfloat(character, &character->factor.damage.max.poison,
		constfactor[AP_SKILL_CONST_POINT_DMG_MAX_POISON], modifier, 
		AP_FACTORS_BIT_DAMAGE);
	addconstfactorfloat(character, &character->factor.damage.max.lightning,
		constfactor[AP_SKILL_CONST_POINT_DMG_MAX_LIGHTENING], modifier, 
		AP_FACTORS_BIT_DAMAGE);
	addconstfactorfloat(character, &character->factor.damage.max.heroic,
		constfactor[AP_SKILL_CONST_POINT_DMG_MAX_HEROIC], modifier, 
		AP_FACTORS_BIT_DAMAGE);
	addconstfactorfloat(character, &character->factor_percent.damage.min.physical,
		constfactor[AP_SKILL_CONST_PERCENT_DMG_MIN_PHYSICAL], modifier, 
		AP_FACTORS_BIT_DAMAGE);
	addconstfactorfloat(character, &character->factor_percent.damage.max.physical,
		constfactor[AP_SKILL_CONST_PERCENT_DMG_MAX_PHYSICAL], modifier, 
		AP_FACTORS_BIT_DAMAGE);
	addconstfactorint(character, &character->factor.attack.skill_cast,
		constfactor[AP_SKILL_CONST_POINT_SKILL_CAST], modifier, 
		AP_FACTORS_BIT_ATTACK);
	addconstfactorint(character, &character->factor.attack.skill_cooldown,
		constfactor[AP_SKILL_CONST_POINT_SKILL_DELAY], modifier, 
		AP_FACTORS_BIT_ATTACK);
	addconstfactoruint(character, &character->factor.char_point_recovery_rate.hp,
		constfactor[AP_SKILL_CONST_HP_RECOVERY], modifier, 
		0);
	addconstfactoruint(character, &character->factor.char_point_recovery_rate.mp,
		constfactor[AP_SKILL_CONST_MP_RECOVERY], modifier, 
		0);
	addconstfactorint(character, &character->factor.attack.accuracy,
		constfactor[AP_SKILL_CONST_POINT_HIT_RATE], modifier, 
		AP_FACTORS_BIT_ATTACK);
	addconstfactorint(character, &character->factor.attack.evade_rate,
		constfactor[AP_SKILL_CONST_POINT_EVADE_RATE], modifier, 
		AP_FACTORS_BIT_ATTACK);
	addconstfactorint(character, &character->factor.attack.dodge_rate,
		constfactor[AP_SKILL_CONST_POINT_DODGE_RATE], modifier, 
		AP_FACTORS_BIT_ATTACK);
	/* \todo Skill range increase. */
	/* \todo Range increase. */
	if (temp->effect_type2 & AP_SKILL_EFFECT2_SKILL_LEVELUP) {
		if (ap_skill_has_detail(temp, AP_SKILL_EFFECT_DETAIL_SKILL_LEVELUP, 
				AP_SKILL_EFFECT_DETAIL_SKILL_LEVELUP_TYPE1)) {
			attachment->modify_skill_level += modifier;
			assert(attachment->modify_skill_level >= 0);
		}
	}
	if (temp->effect_type & AP_SKILL_EFFECT_MELEE_ATTACK_CRITICAL) {
		attachment->combat_effect_arg.melee_critical_rate += 
			(int)constfactor[AP_SKILL_CONST_SKILL_RATE] * modifier;
		attachment->combat_effect_arg.melee_critical_damage_adjust_rate += 
			(int)constfactor[AP_SKILL_CONST_CRITICAL] * modifier;
	}
	if (temp->effect_type & AP_SKILL_EFFECT_SPECIAL_STATUS) {
		if (temp->special_status & AP_SKILL_SPECIAL_STATUS_STUN_PROTECT) {
			attachment->combat_effect_arg.stun_protect_rate += 
				(int)constfactor[AP_SKILL_CONST_SKILL_RATE] * modifier;
		}
	}
	if (temp->effect_type2 & AP_SKILL_EFFECT2_CONVERT) {
		if (ap_skill_has_detail(temp, AP_SKILL_EFFECT_DETAIL_CONVERT,
			AP_SKILL_EFFECT_DETAIL_CONVERT_DAMAGE_TO_HP)) {
			attachment->combat_effect_arg.damage_to_hp_rate[0] +=
				(int)constfactor[AP_SKILL_CONST_SKILL_RATE] * modifier;
			attachment->combat_effect_arg.damage_to_hp_rate[1] +=
				(int)constfactor[AP_SKILL_CONST_SKILL_RATE] * modifier;
			attachment->combat_effect_arg.damage_to_hp_amount[0] +=
				(int)constfactor[AP_SKILL_CONST_DAMAGE_CONVERT_HP] * modifier;
			attachment->combat_effect_arg.damage_to_hp_amount[1] +=
				(int)constfactor[AP_SKILL_CONST_DAMAGE_CONVERT_HP] * modifier;
		}
		if (ap_skill_has_detail(temp, AP_SKILL_EFFECT_DETAIL_CONVERT,
			AP_SKILL_EFFECT_DETAIL_CONVERT_DAMAGE_TO_MP)) {
			attachment->combat_effect_arg.damage_to_mp_rate[0] +=
				(int)constfactor[AP_SKILL_CONST_SKILL_RATE] * modifier;
			attachment->combat_effect_arg.damage_to_mp_amount[0] +=
				(int)constfactor[AP_SKILL_CONST_DAMAGE_CONVERT_MP] * modifier;
		}
		if (ap_skill_has_detail(temp, AP_SKILL_EFFECT_DETAIL_CONVERT,
			AP_SKILL_EFFECT_DETAIL_CONVERT_ATK_DAMAGE_TO_HP)) {
			attachment->combat_effect_arg.damage_to_hp_rate[1] +=
				(int)constfactor[AP_SKILL_CONST_SKILL_RATE] * modifier;
			attachment->combat_effect_arg.damage_to_hp_amount[1] +=
				(int)constfactor[AP_SKILL_CONST_DAMAGE_CONVERT_HP] * modifier;
		}
		if (ap_skill_has_detail(temp, AP_SKILL_EFFECT_DETAIL_CONVERT,
			AP_SKILL_EFFECT_DETAIL_CONVERT_ATK_DAMAGE_TO_MP)) {
			attachment->combat_effect_arg.damage_to_mp_rate[1] +=
				(int)constfactor[AP_SKILL_CONST_SKILL_RATE] * modifier;
			attachment->combat_effect_arg.damage_to_mp_amount[1] +=
				(int)constfactor[AP_SKILL_CONST_DAMAGE_CONVERT_MP] * modifier;
		}
	}
	if (temp->effect_type & AP_SKILL_EFFECT2_SUMMONS) {
		if (ap_skill_has_detail(temp, AP_SKILL_EFFECT_DETAIL_SUMMONS,
			AP_SKILL_EFFECT_DETAIL_SUMMONS_TYPE4)) {
			attachment->combat_effect_arg.increase_summon_limit +=
				(int)constfactor[AP_SKILL_CONST_LIMIT_QUANTITY] * modifier;
		}
	}
	if (temp->effect_type & AP_SKILL_EFFECT2_SKILL_UNION) {
		/* \todo Skill union stats (Swashbuckler related). */
	}
	/* \todo Level up skills. */
	/* \todo Game bonuses (gold, drop, exp, etc.) */
	if (temp->effect_type & AP_SKILL_EFFECT_CRITICAL_DEFENCE_PERCENT) {
		attachment->combat_effect_arg.critical_hit_resistance +=
			(int)constfactor2[AP_SKILL_CONST_CRITICAL_DEFENCE_PERCENT] * modifier;
	}
	if (temp->effect_type & AP_SKILL_EFFECT_REFLECT_MELEE_ATTACK) {
		if (ap_skill_has_detail(temp, AP_SKILL_EFFECT_DETAIL_REFLECT_MELEE_ATK,
			AP_SKILL_EFFECT_DETAIL_REFLECT_MELEE_ATK_IGNORE_PHYSICAL)) {
			attachment->combat_effect_arg.ignore_physical_defense +=
				(int)constfactor2[AP_SKILL_CONST_IGNORE_PHYSICAL_DEFENCE_PERCENT] *
				modifier;
		}
		if (ap_skill_has_detail(temp, AP_SKILL_EFFECT_DETAIL_REFLECT_MELEE_ATK,
			AP_SKILL_EFFECT_DETAIL_REFLECT_MELEE_ATK_IGNORE_ATTRIBUTE)) {
			attachment->combat_effect_arg.ignore_attribute_defense +=
				(int)constfactor2[AP_SKILL_CONST_IGNORE_ATTRIBUTE_DEFENCE_PERCENT] *
				modifier;
		}
	}
}

struct ap_skill_buff_list * ap_skill_add_buff(
	struct ap_skill_module * mod, 
	struct ap_character * character,
	uint32_t skill_id,
	uint32_t skill_level,
	const struct ap_skill_template * temp,
	uint32_t duration,
	uint32_t caster_id,
	uint32_t caster_tid)
{
	struct ap_skill_character * attachment = ap_skill_get_character(mod, character);
	struct ap_skill_buff_list * buff;
	struct ap_skill_cb_add_buff cb = { 0 };
	const float * constfactor;
	assert(!ap_skill_is_buff_list_full(attachment));
	assert(!ap_skill_is_stronger_effect_applied(mod, character, temp, skill_level));
	buff = &attachment->buff_list[attachment->buff_count++];
	buff->skill_id = skill_id;
	buff->skill_tid = temp->id;
	buff->skill_level = skill_level;
	buff->temp = temp;
	buff->caster_id = caster_id;
	buff->caster_tid = caster_tid;
	buff->duration_ms = duration;
	buff->end_tick = ap_tick_get(mod->ap_tick) + duration;
	applybuff(mod, character, attachment, buff, 1);
	constfactor = ap_skill_get_buff_const_factor(buff);
	if (constfactor[AP_SKILL_CONST_PERCENT_HP]) {
		/* \todo
		 * Check:
		 * - If character is a siege structure.
		 * - If character is a battleground boss. */
		int hp = character->factor.char_point.hp + 
			(int)(character->factor.char_point_max.hp * 
				constfactor[AP_SKILL_CONST_PERCENT_HP] / 100.0f);
		if (hp > (int)character->factor.char_point_max.hp) {
			hp = character->factor.char_point_max.hp;
		}
		else if (hp <= 0) {
			/* If, for whatever reason, a healing skill has negative healing 
			 * effect, make sure that character does not die. */
			hp = 1;
		}
		character->update_flags |= AP_FACTORS_BIT_HP;
	}
	if (constfactor[AP_SKILL_CONST_POINT_HP]) {
		/* \todo
		 * Check:
		 * - If character is a siege structure.
		 * - If character is a battleground boss. */
		int hp = character->factor.char_point.hp + 
			(int)constfactor[AP_SKILL_CONST_POINT_HP];
		if (hp > (int)character->factor.char_point_max.hp) {
			hp = character->factor.char_point_max.hp;
		}
		else if (hp <= 0) {
			/* If, for whatever reason, a healing skill has negative healing 
			 * effect, make sure that character does not die. */
			hp = 1;
		}
		character->update_flags |= AP_FACTORS_BIT_HP;
	}
	if (constfactor[AP_SKILL_CONST_PERCENT_MP]) {
		int mp = character->factor.char_point.mp + 
			(int)(character->factor.char_point_max.mp * 
				constfactor[AP_SKILL_CONST_PERCENT_MP] / 100.0f);
		if (mp > (int)character->factor.char_point_max.mp)
			mp = character->factor.char_point_max.mp;
		else if (mp < 0)
			mp = 0;
		character->update_flags |= AP_FACTORS_BIT_MP;
	}
	if (constfactor[AP_SKILL_CONST_POINT_MP]) {
		int mp = character->factor.char_point.mp + 
			(int)constfactor[AP_SKILL_CONST_POINT_MP];
		if (mp > (int)character->factor.char_point_max.mp)
			mp = character->factor.char_point_max.mp;
		else if (mp < 0)
			mp = 0;
		character->update_flags |= AP_FACTORS_BIT_MP;
	}
	if (temp->effect_type2 & AP_SKILL_EFFECT2_UPDATE_COMBAT_POINT) {
		if (ap_skill_has_detail(temp, 
			AP_SKILL_EFFECT_DETAIL_UPDATE_COMBAT_POINT,
			AP_SKILL_EFFECT_DETAIL_UPDATE_COMBAT_POINT_TYPE2)) {
			character->adjust_combat_point |= 
				AP_CHARACTER_ADJUST_COMBAT_POINT_MAX_DAMAGE;
			character->update_flags |= AP_FACTORS_BIT_DAMAGE;
		}
		else if (ap_skill_has_detail(temp, 
			AP_SKILL_EFFECT_DETAIL_UPDATE_COMBAT_POINT,
			AP_SKILL_EFFECT_DETAIL_UPDATE_COMBAT_POINT_TYPE3)) {
			character->adjust_combat_point |= 
				AP_CHARACTER_ADJUST_COMBAT_POINT_MIN_DAMAGE;
			character->update_flags |= AP_FACTORS_BIT_DAMAGE;
		}
	}
	if (temp->effect_type & AP_SKILL_EFFECT_SPECIAL_STATUS) {
		if (temp->special_status & AP_SKILL_SPECIAL_STATUS_INVINCIBLE) {
			ap_character_special_status_on(mod->ap_character, character,
				AP_CHARACTER_SPECIAL_STATUS_INVINCIBLE, buff->duration_ms);
		}
		if (temp->special_status & AP_SKILL_SPECIAL_STATUS_ATTRIBUTE_INVINCIBLE) {
			ap_character_special_status_on(mod->ap_character, character, 
				AP_CHARACTER_SPECIAL_STATUS_ATTRIBUTE_INVINCIBLE, buff->duration_ms);
		}
		if (temp->special_status & AP_SKILL_SPECIAL_STATUS_NOT_ADD_AGRO) {
			/* \todo Cancel agro. */
		}
		if (temp->special_status & AP_SKILL_SPECIAL_STATUS_HALT) {
			ap_character_special_status_on(mod->ap_character, character, 
				AP_CHARACTER_SPECIAL_STATUS_DISABLE_SKILL, buff->duration_ms);
			ap_character_special_status_on(mod->ap_character, character, 
				AP_CHARACTER_SPECIAL_STATUS_DISABLE_NORMAL_ATK, buff->duration_ms);
		}
		if (temp->special_status & AP_SKILL_SPECIAL_STATUS_TRANSPARENT) {
			ap_character_special_status_on(mod->ap_character, character, 
				AP_CHARACTER_SPECIAL_STATUS_TRANSPARENT, buff->duration_ms);
		}
		if (temp->special_status & AP_SKILL_SPECIAL_STATUS_NORMAL_ATK_INVINCIBLE) {
			ap_character_special_status_on(mod->ap_character, character, 
				AP_CHARACTER_SPECIAL_STATUS_NORMAL_ATK_INVINCIBLE, buff->duration_ms);
		}
		if (temp->special_status & AP_SKILL_SPECIAL_STATUS_SKILL_ATK_INVINCIBLE) {
			ap_character_special_status_on(mod->ap_character, character, 
				AP_CHARACTER_SPECIAL_STATUS_SKILL_ATK_INVINCIBLE, buff->duration_ms);
		}
		if (temp->special_status & AP_SKILL_SPECIAL_STATUS_DISABLE_NORMAL_ATK) {
			ap_character_special_status_on(mod->ap_character, character, 
				AP_CHARACTER_SPECIAL_STATUS_DISABLE_NORMAL_ATK, buff->duration_ms);
		}
		if (temp->special_status & AP_SKILL_SPECIAL_STATUS_DISABLE_SKILL) {
			ap_character_special_status_on(mod->ap_character, character, 
				AP_CHARACTER_SPECIAL_STATUS_DISABLE_SKILL, buff->duration_ms);
		}
		if (temp->special_status & AP_SKILL_SPECIAL_STATUS_SLEEP) {
			ap_character_special_status_on(mod->ap_character, character, 
				AP_CHARACTER_SPECIAL_STATUS_SLEEP, buff->duration_ms);
		}
		if (temp->special_status & AP_SKILL_SPECIAL_STATUS_SLOW_INVINCIBLE) {
			ap_character_special_status_on(mod->ap_character, character, 
				AP_CHARACTER_SPECIAL_STATUS_SLOW_INVINCIBLE, buff->duration_ms);
		}
	}
	if (temp->effect_type & AP_SKILL_EFFECT2_ACTOIN_ON_ACTION) {
		if (ap_skill_has_detail(temp, AP_SKILL_EFFECT_DETAIL_ACTION_ON_ACTION,
			AP_SKILL_EFFECT_DETAIL_ACTION_ON_ACTION_TYPE6)) {
			/* \todo Schedule for skill to be 
			 * cast on death (i.e. elementalist bomb). */
		}
	}
	ap_character_update_factor(mod->ap_character, character, 0);
	cb.character = character;
	cb.buff = buff;
	ap_module_enum_callback(mod, AP_SKILL_CB_ADD_BUFF, &cb);
	return buff;
}

uint32_t ap_skill_remove_buff(
	struct ap_skill_module * mod, 
	struct ap_character * character,
	uint32_t buff_index)
{
	struct ap_skill_character * attachment = ap_skill_get_character(mod, character);
	struct ap_skill_cb_remove_buff cb = { 0 };
	const struct ap_skill_template * temp;
	assert(buff_index < attachment->buff_count);
	cb.character = character;
	cb.buff = &attachment->buff_list[buff_index];
	temp = cb.buff->temp;
	applybuff(mod, character, attachment, cb.buff, -1);
	ap_character_update_factor(mod->ap_character, character, 0);
	if (temp->effect_type2 & AP_SKILL_EFFECT2_UPDATE_COMBAT_POINT) {
		if (ap_skill_has_detail(temp, 
			AP_SKILL_EFFECT_DETAIL_UPDATE_COMBAT_POINT,
			AP_SKILL_EFFECT_DETAIL_UPDATE_COMBAT_POINT_TYPE2)) {
			character->adjust_combat_point &= 
				~AP_CHARACTER_ADJUST_COMBAT_POINT_MAX_DAMAGE;
			character->update_flags |= AP_FACTORS_BIT_DAMAGE;
		}
		else if (ap_skill_has_detail(temp, 
			AP_SKILL_EFFECT_DETAIL_UPDATE_COMBAT_POINT,
			AP_SKILL_EFFECT_DETAIL_UPDATE_COMBAT_POINT_TYPE3)) {
			character->adjust_combat_point &= 
				~AP_CHARACTER_ADJUST_COMBAT_POINT_MIN_DAMAGE;
			character->update_flags |= AP_FACTORS_BIT_DAMAGE;
		}
	}
	ap_module_enum_callback(mod, AP_SKILL_CB_REMOVE_BUFF, &cb);
	memmove(&attachment->buff_list[buff_index], 
		&attachment->buff_list[buff_index + 1],
		((size_t)--attachment->buff_count - buff_index) * sizeof(attachment->buff_list[0]));
	return buff_index;
}

boolean ap_skill_check_buff_condition(
	struct ap_skill_module * mod, 
	const struct ap_skill_buff_list * buff)
{
	const struct ap_skill_template * temp = buff->temp;
	const float * constfactor;
	if (!(temp->condition_type & AP_SKILL_CONDITION_SKIP_CHECK_FIRST))
		return TRUE;
	constfactor = ap_skill_get_buff_const_factor(buff);
	if (ap_random_get(mod->ap_random, 100) < constfactor[AP_SKILL_CONST_SKILL_RATE])
		return TRUE;
	return FALSE;
}

boolean ap_skill_on_receive(
	struct ap_skill_module * mod,
	const void * data,
	uint16_t length,
	void * user_data)
{
	struct ap_skill_cb_receive cb = { 0 };
	void * actionpacket = NULL;
	struct ap_skill_action_packet action= { 0 };
	struct ap_skill_base_packet targetbase = { 0 };
	if (!au_packet_get_field(&mod->packet, TRUE, data, length,
			&cb.type,
			&cb.skill_id,
			NULL, /* Base Packet */
			NULL, /* Factor Packet */
			&cb.skill_tid,
			NULL, /* Status (enum ap_skill_status) */
			&actionpacket, /* Action Packet */
			NULL, /* Skill Point */
			NULL,
			NULL, NULL)) { /* BuffedSkillCombatArg */
		return FALSE;
	}
	if (actionpacket) {
		void * basepacket = NULL;
		if (!au_packet_get_field(&mod->packet_action, 
				FALSE, actionpacket, 0,
				&action.action_type,
				&basepacket, /* target base packet */
				NULL, /* cast result factor packet */
				&action.dest_pos, /* destination position packet */
				&action.forced_attack, /* forced attack */
				NULL, /* cast delay */
				NULL, /* duration */
				NULL, /* recast delay */
				NULL, /* skill level */
				NULL, /* result factor queueing  */
				NULL, /* additional effect */
				NULL, NULL)) { /* target character id */
			return FALSE;
		}
		cb.action_packet = &action;
		if (basepacket) {
			if (!au_packet_get_field(&mod->packet_base, 
					FALSE, basepacket, 0,
					&targetbase.base_type,
					&targetbase.id)) {
				return FALSE;
			}
			action.target = &targetbase;
		}
	}
	cb.user_data = user_data;
	return ap_module_enum_callback(mod, 
		AP_SKILL_CB_RECEIVE, &cb);
}

void ap_skill_make_add_packet(
	struct ap_skill_module * mod,
	struct ap_skill * skill,
	struct ap_character * character)
{
	void * buffer = ap_packet_get_buffer(mod->ap_packet);
	uint16_t length = 0;
	makeadd(mod, skill, character, buffer, &length);
	ap_packet_set_length(mod->ap_packet, length);
}

void ap_skill_make_add_packet_buffer(
	struct ap_skill_module * mod,
	struct ap_skill * skill,
	struct ap_character * character,
	void * buffer,
	uint16_t * length)
{
	makeadd(mod, skill, character, buffer, length);
}

void ap_skill_make_update_packet(
	struct ap_skill_module * mod,
	struct ap_skill * skill,
	struct ap_character * character)
{
	uint8_t type = AP_SKILL_PACKET_TYPE_UPDATE;
	void * buffer = ap_packet_get_buffer(mod->ap_packet);
	uint16_t length = 0;
	void * base = makebase(mod, character);
	void * factor = ap_packet_get_temp_buffer(mod->ap_packet);
	ap_factors_make_skill_result_packet(mod->ap_factors, factor, &skill->factor);
	au_packet_make_packet(&mod->packet, 
		buffer, TRUE, &length,
		AP_SKILL_PACKET_TYPE, 
		&type,
		&skill->id,
		base, /* Base Packet */
		factor, /* Factor Packet */
		NULL, /* Template Id */
		NULL, /* Status (enum ap_skill_status) */
		NULL, /* Action Packet */
		NULL, /* Skill Point */
		NULL, /* Skill Buff Packet */
		NULL); /* BuffedSkillCombatArg */
	ap_packet_set_length(mod->ap_packet, length);
	ap_packet_pop_temp_buffers(mod->ap_packet, 2);
}

void ap_skill_make_update_attached_data_packet(
	struct ap_skill_module * mod,
	struct ap_character * character)
{
	uint8_t type = AP_SKILL_PACKET_TYPE_UPDATE_ATTACH_DATA;
	void * buffer = ap_packet_get_buffer(mod->ap_packet);
	uint16_t length = 0;
	void * base = makebase(mod, character);
	struct ap_skill_buffed_combat_effect_arg * arg =
		&ap_skill_get_character(mod, character)->combat_effect_arg;
	uint16_t argsize = (uint16_t)sizeof(*arg);
	assert(argsize == 152);
	au_packet_make_packet(&mod->packet, 
		buffer, TRUE, &length,
		AP_SKILL_PACKET_TYPE, 
		&type,
		NULL,
		base, /* Base Packet */
		NULL, /* Factor Packet */
		NULL, /* Template Id */
		NULL, /* Status (enum ap_skill_status) */
		NULL, /* Action Packet */
		NULL, /* Skill Point */
		NULL, /* Skill Buff Packet */
		arg, &argsize); /* BuffedSkillCombatArg */
	ap_packet_set_length(mod->ap_packet, length);
	ap_packet_pop_temp_buffers(mod->ap_packet, 1);
}

void ap_skill_make_add_buffed_list_packet(
	struct ap_skill_module * mod,
	struct ap_character * character,
	const struct ap_skill_buff_list * buff)
{
	uint8_t type = AP_SKILL_PACKET_TYPE_ADD_BUFFED_LIST;
	void * buffer = ap_packet_get_buffer(mod->ap_packet);
	uint16_t length = 0;
	void * base = makebase(mod, character);
	void * buffed = ap_packet_get_temp_buffer(mod->ap_packet);
	static void * buffedlist[AP_SKILL_MAX_SKILL_BUFF] = { 0 };
	au_packet_make_packet(&mod->packet_buff, 
		buffed, FALSE, 0,
		0, 
		&buff->skill_tid, /* buffed skill tid */
		&buff->duration_ms, /* buffed skill end time */
		&buff->caster_tid, /* caster tid */
		NULL, /* charge level */
		NULL, /* expired time */
		NULL); /* BuffedSkillCombatArg */
	buffedlist[0] = buffed;
	au_packet_make_packet(&mod->packet, 
		buffer, TRUE, &length,
		AP_SKILL_PACKET_TYPE, 
		&type,
		&buff->skill_id,
		base, /* Base Packet */
		NULL, /* Factor Packet */
		NULL, /* Template Id */
		NULL, /* Status (enum ap_skill_status) */
		NULL, /* Action Packet */
		NULL, /* Skill Point */
		buffedlist, /* Skill Buff Packet */
		NULL); /* BuffedSkillCombatArg */
	ap_packet_set_length(mod->ap_packet, length);
	ap_packet_pop_temp_buffers(mod->ap_packet, 2);
}

void ap_skill_make_remove_buffed_list_packet(
	struct ap_skill_module * mod,
	struct ap_character * character,
	struct ap_skill_buff_list * buff)
{
	uint8_t type = AP_SKILL_PACKET_TYPE_REMOVE_BUFFED_LIST;
	void * buffer = ap_packet_get_buffer(mod->ap_packet);
	uint16_t length = 0;
	void * base = makebase(mod, character);
	void * buffed = ap_packet_get_temp_buffer(mod->ap_packet);
	static void * buffedlist[AP_SKILL_MAX_SKILL_BUFF] = { 0 };
	au_packet_make_packet(&mod->packet_buff, 
		buffed, FALSE, 0,
		0, 
		&buff->skill_tid, /* buffed skill tid */
		NULL, /* buffed skill end time */
		NULL, /* caster tid */
		NULL, /* charge level */
		NULL, /* expired time */
		NULL); /* BuffedSkillCombatArg */
	buffedlist[0] = buffed;
	au_packet_make_packet(&mod->packet, 
		buffer, TRUE, &length,
		AP_SKILL_PACKET_TYPE, 
		&type,
		&buff->skill_id,
		base, /* Base Packet */
		NULL, /* Factor Packet */
		NULL, /* Template Id */
		NULL, /* Status (enum ap_skill_status) */
		NULL, /* Action Packet */
		NULL, /* Skill Point */
		buffedlist, /* Skill Buff Packet */
		NULL); /* BuffedSkillCombatArg */
	ap_packet_set_length(mod->ap_packet, length);
	ap_packet_pop_temp_buffers(mod->ap_packet, 2);
}

void ap_skill_make_cast_packet(
	struct ap_skill_module * mod,
	struct ap_skill * skill,
	struct ap_character * character,
	struct ap_character * target,
	const struct ap_skill_cast_info * cast_info)
{
	uint8_t type = AP_SKILL_PACKET_TYPE_CAST_SKILL;
	void * buffer = ap_packet_get_buffer(mod->ap_packet);
	uint16_t length = 0;
	void * base = makebase(mod, character);
	uint32_t level = ap_skill_get_level(skill);
	boolean queue = TRUE;
	void * action = makeaction(mod, AP_SKILL_ACTION_CAST_SKILL,
		target, &cast_info->target_pos, &cast_info->cast_time,
		&cast_info->duration_time, &cast_info->cooldown_time,
		&level, &queue, cast_info->targets, 
		cast_info->target_count);
	au_packet_make_packet(&mod->packet, 
		buffer, TRUE, &length,
		AP_SKILL_PACKET_TYPE, 
		&type,
		&skill->id,
		base, /* Base Packet */
		NULL, /* Factor Packet */
		&skill->temp->id, /* Template Id */
		NULL, /* Status (enum ap_skill_status) */
		action, /* Action Packet */
		NULL, /* Skill Point */
		NULL, /* Skill Buff Packet */
		NULL); /* BuffedSkillCombatArg */
	ap_packet_set_length(mod->ap_packet, length);
	ap_packet_pop_temp_buffers(mod->ap_packet, 2);
}

void ap_skill_make_cast_result_packet(
	struct ap_skill_module * mod,
	struct ap_character * character,
	struct ap_skill_action_data * action)
{
	uint8_t type = AP_SKILL_PACKET_TYPE_CAST_SKILL_RESULT;
	void * buffer = ap_packet_get_buffer(mod->ap_packet);
	uint16_t length = 0;
	void * base = makebase(mod, character);
	boolean queue = TRUE;
	void * actionpacket = ap_packet_get_temp_buffer(mod->ap_packet);
	void * target = makebase(mod, action->target_base[0]);
	void * factor = ap_packet_get_temp_buffer(mod->ap_packet);
	uint8_t skipqueue = TRUE;
	ap_factors_make_result_damage_packet(mod->ap_factors, factor, 
		&action->info.target);
	au_packet_make_packet(&mod->packet_action, 
		actionpacket, FALSE, NULL, 0,
		&action->action_type, /* action type */
		target, /* target base packet */
		factor, /* cast result factor packet */
		NULL, /* destination position packet */
		NULL, /* forced attack (ctrl + skill) */
		NULL, /* cast delay */
		NULL, /* duration */
		NULL, /* recast delay */
		&action->skilll_level, /* skill level */
		&skipqueue, /* result factor queueing  */
		&action->additional_effect, /* additional effect */
		NULL); /* target character id */
	au_packet_make_packet(&mod->packet, 
		buffer, TRUE, &length,
		AP_SKILL_PACKET_TYPE, 
		&type,
		&action->skill_id,
		base, /* Base Packet */
		NULL, /* Factor Packet */
		&action->skill_tid, /* Template Id */
		NULL, /* Status (enum ap_skill_status) */
		actionpacket, /* Action Packet */
		NULL, /* Skill Point */
		NULL, /* Skill Buff Packet */
		NULL); /* BuffedSkillCombatArg */
	ap_packet_set_length(mod->ap_packet, length);
	ap_packet_pop_temp_buffers(mod->ap_packet, 4);
}

void ap_skill_make_additional_effect_packet(
	struct ap_skill_module * mod,
	struct ap_skill * skill,
	struct ap_character * character,
	uint32_t target_id,
	uint32_t additional_effect)
{
	uint8_t type = AP_SKILL_PACKET_TYPE_ADDITIONAL_EFFECT;
	void * buffer = ap_packet_get_buffer(mod->ap_packet);
	uint16_t length = 0;
	void * base = makebase(mod, character);
	au_packet_make_packet(&mod->packet, 
		buffer, TRUE, &length,
		AP_SKILL_PACKET_TYPE, 
		&type,
		&additional_effect,
		base, /* Base Packet */
		NULL, /* Factor Packet */
		&target_id, /* Template Id */
		NULL, /* Status (enum ap_skill_status) */
		NULL, /* Action Packet */
		NULL, /* Skill Point */
		NULL, /* Skill Buff Packet */
		NULL); /* BuffedSkillCombatArg */
	ap_packet_set_length(mod->ap_packet, length);
	ap_packet_pop_temp_buffers(mod->ap_packet, 1);
}

void ap_skill_make_modified_skill_level_packet(
	struct ap_skill_module * mod,
	struct ap_character * character)
{
	uint8_t type = AP_SKILL_PACKET_TYPE_MODIFIED_SKILL_LEVEL;
	void * buffer = ap_packet_get_buffer(mod->ap_packet);
	uint16_t length = 0;
	void * base = makebase(mod, character);
	au_packet_make_packet(&mod->packet, 
		buffer, TRUE, &length,
		AP_SKILL_PACKET_TYPE, 
		&type,
		&ap_skill_get_character(mod, character)->combat_effect_arg.skill_level_up_point,
		base, /* Base Packet */
		NULL, /* Factor Packet */
		NULL, /* Template Id */
		NULL, /* Status (enum ap_skill_status) */
		NULL, /* Action Packet */
		NULL, /* Skill Point */
		NULL, /* Skill Buff Packet */
		NULL); /* BuffedSkillCombatArg */
	ap_packet_set_length(mod->ap_packet, length);
	ap_packet_pop_temp_buffers(mod->ap_packet, 1);
}

void ap_skill_make_init_cooltime_packet(
	struct ap_skill_module * mod,
	struct ap_character * character,
	struct ap_skill * skill)
{
	uint8_t type = AP_SKILL_PACKET_TYPE_INIT_COOLTIME;
	void * buffer = ap_packet_get_buffer(mod->ap_packet);
	uint16_t length = 0;
	void * base = makebase(mod, character);
	au_packet_make_packet(&mod->packet, 
		buffer, TRUE, &length,
		AP_SKILL_PACKET_TYPE, 
		&type,
		&skill->id,
		base, /* Base Packet */
		NULL, /* Factor Packet */
		&skill->tid, /* Template Id */
		NULL, /* Status (enum ap_skill_status) */
		NULL, /* Action Packet */
		NULL, /* Skill Point */
		NULL, /* Skill Buff Packet */
		NULL); /* BuffedSkillCombatArg */
	ap_packet_set_length(mod->ap_packet, length);
	ap_packet_pop_temp_buffers(mod->ap_packet, 1);
}
